<!DOCTYPE html>
<html lang="en-us">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  <meta itemprop="name" content="Bo Jeanes" />
  <meta itemprop="description" content="" />

  <link rel="apple-touch-icon" sizes="180x180" href="https://bjeanes.com/apple-touch-icon.png"/>
  <link rel="icon" type="image/png" sizes="32x32" href="https://bjeanes.com/favicon-32x32.png" />
  <link
    rel="icon"
    type="image/png"
    sizes="16x16"
    href="https://bjeanes.com/favicon-16x16.png"
  />
  <link
    rel="shortcut icon"
    href="https://bjeanes.com/favicon.ico"
  />
  <link rel="stylesheet" href="https://bjeanes.com/style.css"/>
  
  <title>Motivate your lazy sequences</title>
  

  
  <link rel="alternate" type="application/rss+xml" title="RSS" href="https://bjeanes.com/atom.xml">
  

  <body id="page">

	
<header id="site-header" class="animated slideInUp faster">
  <div class="hdr-wrapper section-inner">
    <div class="hdr-left">
      <div class="site-branding">
        <a href="https:&#x2F;&#x2F;bjeanes.com">Bo Jeanes</a>
      </div>
      <nav class="site-nav hide-in-mobile">
            
        
        <a href="https://bjeanes.com/posts">Posts</a>
        
        <a href="https://bjeanes.com/about">About</a>
        
      </nav>
    </div>
    <div class="hdr-right hdr-icons">
      <span class="hdr-social hide-in-mobile">
        

<a href="https:&#x2F;&#x2F;github.com&#x2F;bjeanes" target="_blank" rel="noopener me"
   title="github">
  
  <svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg>
  
</a>

<a href="https:&#x2F;&#x2F;gitlab.com&#x2F;bjeanes" target="_blank" rel="noopener me"
   title="gitlab">
  
  <svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22.65 14.39L12 22.13 1.35 14.39a.84.84 0 0 1-.3-.94l1.22-3.78 2.44-7.51A.42.42 0 0 1 4.82 2a.43.43 0 0 1 .58 0 .42.42 0 0 1 .11.18l2.44 7.49h8.1l2.44-7.51A.42.42 0 0 1 18.6 2a.43.43 0 0 1 .58 0 .42.42 0 0 1 .11.18l2.44 7.51L23 13.45a.84.84 0 0 1-.35.94z"></path></svg>
  
</a>

<a href="https:&#x2F;&#x2F;twitter.com&#x2F;bjeanes" target="_blank" rel="noopener me"
   title="twitter">
  
  <svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path></svg>
  
</a>

<a href="https:&#x2F;&#x2F;instagram.com&#x2F;bjeanes" target="_blank" rel="noopener me"
   title="instagram">
  
  <svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path><line x1="17.5" y1="6.5" x2="17.5" y2="6.5"></line></svg>
  
</a>

<a href="https:&#x2F;&#x2F;www.linkedin.com&#x2F;in&#x2F;bjeanes&#x2F;" target="_blank" rel="noopener me"
   title="linkedin">
  
  <svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect x="2" y="9" width="4" height="12"></rect><circle cx="4" cy="4" r="2"></circle></svg>
  
</a>

<a href="mailto:me@bjeanes.com" target="_blank" rel="noopener me"
   title="email">
  
  <svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
  
</a>


      </span>
      <button id="menu-btn" class="hdr-btn" title="Menu">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          class="feather feather-menu"
        >
          <line x1="3" y1="12" x2="21" y2="12"></line>
          <line x1="3" y1="6" x2="21" y2="6"></line>
          <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
      </button>
    </div>
  </div>
</header>
<div id="mobile-menu" class="animated fast">
  <ul>
    
    <li><a href="https://bjeanes.com/posts">Posts</a></li>
    
    <li><a href="https://bjeanes.com/about">About</a></li>
    
  </ul>
</div>

	
	

		
<main class="site-main section-inner animated fadeIn faster">
  <article class="thin">
	<header class="post-header">
	  <div class="post-meta">
		
		<span>Sep 03, 2012</span>
		<small> - 
<span class="reading-time" title="Estimated read time">
  
  3 min read
  
</span>
</small>
		
            
	  </div>
	  <h1>Motivate your lazy sequences</h1>
	</header>

	<div class="content">
        
	  <p>I <em>love</em> Clojure’s laziness.</p>
<p>Recently, I’ve been using <code>lazy-seq</code>  to consume remote collections via APIs, fetching pages of data transparently and only as needed. <a href="http://gfredericks.com/">Gary Fredericks</a>, <a href="http://mikelikesbikes.com/">Mike Busch</a>, and I applied this to a project of ours that had to crunch tens of thousands of records from Salesforce. I’m also doing something similar with a personal project that has to fetch a lot of Pivotal Tracker stories to <code>reduce</code> them.</p>
<p>In cases like these, consuming (potentially unbounded) resources in a lazy manner allows one to start processing data earlier and to make as few requests as possible to get only the data you need.</p>
<h2 id="mostly-lazy"><em>Mostly</em> Lazy</h2>
<p>I want to talk about a neat little thing I did in my project to get a nice little performance boost on top of this laziness, without having to think about any low-level concurrency concerns.</p>
<h3 id="laziness">Laziness</h3>
<p>Here’s a piece of code that provides an “infinite” lazy sequence. In this case, it is of tweets:</p>
<pre data-lang="clojure" style="background-color:#282c34;color:#dcdfe4;" class="language-clojure "><code class="language-clojure" data-lang="clojure"><span>(</span><span style="color:#e06c75;">require </span><span style="color:#c678dd;">&#39;</span><span>[clj-http.client </span><span style="color:#e5c07b;">:as</span><span> http])
</span><span>
</span><span>(</span><span style="color:#c678dd;">defn </span><span style="color:#61afef;">tweets-for
</span><span>  ([user] (</span><span style="color:#e06c75;">tweets-for</span><span> user </span><span style="color:#e5c07b;">nil</span><span>))
</span><span>  ([user last-tweet-id]
</span><span>     (</span><span style="color:#e06c75;">lazy-seq
</span><span>      (</span><span style="color:#e06c75;">let </span><span>[url </span><span style="color:#98c379;">&quot;http://api.twitter.com/1/statuses/user_timeline.json&quot;
</span><span>            params {</span><span style="color:#e5c07b;">:limit 10 :screen_name</span><span> user}
</span><span>            params (</span><span style="color:#e06c75;">if</span><span> last-tweet-id (</span><span style="color:#e06c75;">assoc</span><span> params </span><span style="color:#e5c07b;">:max_id</span><span> last-tweet-id) params)
</span><span>            response (</span><span style="color:#e06c75;">http/get</span><span> url {</span><span style="color:#e5c07b;">:query-params</span><span> params </span><span style="color:#e5c07b;">:as :json</span><span>})
</span><span>            tweets (</span><span style="color:#e5c07b;">:body</span><span> response)]
</span><span>
</span><span>        (</span><span style="color:#e06c75;">when </span><span>(</span><span style="color:#e06c75;">not-empty</span><span> tweets)
</span><span>          (</span><span style="color:#e06c75;">concat</span><span> tweets
</span><span>                  (</span><span style="color:#e06c75;">tweets-for</span><span> user (</span><span style="color:#e5c07b;">:id </span><span>(</span><span style="color:#e06c75;">last</span><span> tweets)))))))))
</span></code></pre>
<p>So that’s cool. Now, note the following performance characteristics when contemplating the next section:</p>
<pre data-lang="clojure" style="background-color:#282c34;color:#dcdfe4;" class="language-clojure "><code class="language-clojure" data-lang="clojure"><span>(</span><span style="color:#c678dd;">def </span><span style="color:#61afef;">my-tweets </span><span>(</span><span style="color:#e06c75;">tweets-for </span><span style="color:#98c379;">&quot;bjeanes&quot;</span><span>))
</span><span>
</span><span style="color:#5c6370;">;; The following returns after a delay while we fetch the first page:
</span><span>(</span><span style="color:#e06c75;">first</span><span> my-tweets) </span><span style="color:#5c6370;">;=&gt; {:text &quot;Tweet 0&quot; ...}
</span><span>
</span><span style="color:#5c6370;">;; This returns instantly because our `tweets-for` function fetches 10 tweets per page:
</span><span>(</span><span style="color:#e06c75;">nth</span><span> my-tweets </span><span style="color:#e5c07b;">9</span><span>) </span><span style="color:#5c6370;">;=&gt; {:text &quot;Tweet 9&quot; ...}
</span><span>
</span><span style="color:#5c6370;">;; This returns after a delay because this tweet is on the next (still lazily unfetched) page:
</span><span>(</span><span style="color:#e06c75;">nth</span><span> my-tweets </span><span style="color:#e5c07b;">10</span><span>) </span><span style="color:#5c6370;">;=&gt; {:text &quot;Tweet 10&quot; ...}
</span></code></pre>
<h3 id="motivation">Motivation</h3>
<p>So laziness is pretty cool. But, sometimes, things can improve if you are ever so slightly less lazy. What if we could remove that little pause between the 9th and the 10th items in the list where we are just waiting around for the network request to Twitter to complete? We could be using our time to do more CPU-melting tweet crunching! Well, it turns out we can easily do it.</p>
<p>Assume for a moment that we have some calculation (<code>process</code>) that takes a considerable amount of CPU time to process:</p>
<pre data-lang="clojure" style="background-color:#282c34;color:#dcdfe4;" class="language-clojure "><code class="language-clojure" data-lang="clojure"><span>(</span><span style="color:#c678dd;">defn </span><span style="color:#61afef;">process
</span><span>  </span><span style="color:#98c379;">&quot;Do some really hard work with our tweets&quot;
</span><span>  [tweets]
</span><span>  (</span><span style="color:#e06c75;">map </span><span style="color:#c678dd;">#</span><span>(</span><span style="color:#e06c75;">Thread/sleep </span><span style="color:#e5c07b;">100</span><span>) tweets))
</span></code></pre>
<p>If we know we will be consuming a substantial amount of the lazy sequence, we could encourage the sequence to go ahead and start realizing the next chunk of our sequence.</p>
<p>This would mean that instead of processing 10 tweets, waiting, processing 10 tweets, waiting, etc.:</p>
<p><img src="https://bjeanes.com/posts/motivate-your-lazy-sequences/lazy.png" alt="Diagram of lazy sequencing" /></p>
<p>... we would be able to process tweets continuously back-to-back:</p>
<p><img src="https://bjeanes.com/posts/motivate-your-lazy-sequences/motivated.png" alt="Diagram showing the &quot;motivated&quot; sequencing" /></p>
<p>Wouldn't also be great if we didn't have to think about the parallelism at all? To this end, I present <code>motivate</code>:</p>
<pre data-lang="clojure" style="background-color:#282c34;color:#dcdfe4;" class="language-clojure "><code class="language-clojure" data-lang="clojure"><span>(</span><span style="color:#c678dd;">defn </span><span style="color:#61afef;">motivate
</span><span>  </span><span style="color:#98c379;">&quot;Motivate a lazy sequence to seek slightly ahead of the sequence consumer&#39;s position.&quot;
</span><span>  ([coll] (</span><span style="color:#e06c75;">motivate</span><span> coll </span><span style="color:#e5c07b;">1</span><span>))
</span><span>  ([coll motivation]
</span><span>     (</span><span style="color:#e06c75;">lazy-seq
</span><span>      (</span><span style="color:#e06c75;">future </span><span>(</span><span style="color:#e06c75;">nth</span><span> coll motivation))
</span><span>      (</span><span style="color:#e06c75;">cons </span><span>(</span><span style="color:#e06c75;">first</span><span> coll) (</span><span style="color:#e06c75;">motivate </span><span>(</span><span style="color:#e06c75;">rest</span><span> coll) motivation)))))
</span></code></pre>
<p>Let’s compare:</p>
<pre data-lang="clojure" style="background-color:#282c34;color:#dcdfe4;" class="language-clojure "><code class="language-clojure" data-lang="clojure"><span>(</span><span style="color:#e06c75;">time </span><span>(</span><span style="color:#e06c75;">process </span><span>(</span><span style="color:#e06c75;">take </span><span style="color:#e5c07b;">100 </span><span>(</span><span style="color:#e06c75;">tweets-for </span><span style="color:#98c379;">&quot;riblah&quot;</span><span>))))
</span><span style="color:#5c6370;">;=&gt; “Elapsed time: 11545.011 msecs&quot;
</span><span>(</span><span style="color:#e06c75;">time </span><span>(</span><span style="color:#e06c75;">process </span><span>(</span><span style="color:#e06c75;">take </span><span style="color:#e5c07b;">100 </span><span>(</span><span style="color:#e06c75;">motivate </span><span>(</span><span style="color:#e06c75;">tweets-for </span><span style="color:#98c379;">&quot;riblah&quot;</span><span>) </span><span style="color:#e5c07b;">5</span><span>))))
</span><span style="color:#5c6370;">;=&gt; &quot;Elapsed time: 10394.769 msecs&quot;
</span></code></pre>
<p>The speed difference is noticeable even when processing only a 100 tweets. If we were doing more than 100 milliseconds/tweet of processing, fetching a lot more data, or dealing with a slow upstream dependency, the speed improvements would be even clearer.</p>
<p>The last (optional) parameter to <code>motivate</code> is the “motivation factor”. If your CPU-bound work is long-running, this number can be smaller without a noticeable difference. The ideal number depends on how long each IO operation takes and much processing you do with each chunk.</p>
<p>Essentially, the motivation you give to the lazy sequence is a trade-off between waiting for IO and wasting IO; that is, the lower the number, the more likely you are to wait on IO but the higher the number, the more IO you’ll perform unnecessarily (at least, if you aren’t guaranteed to consume the whole sequence.</p>
<p>Hopefully this is handy to someone else out there. I wouldn’t at all be surprised if something like this already existed (<strong>UPDATE</strong> Yup: <a href="http://clojuredocs.org/clojure_core/clojure.core/seque"><code>seque</code></a>) or if this completely obvious to seasoned Clojurian, but it was a pleasant moment discovering this possibility on my own.</p>

	</div>
	<hr class="post-end">
	<footer class="post-info">
    
    <p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>771 Words</p>
    
    <p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>2012-09-03T18:00:53Z</p>
    
	</footer>
  </article>
    
  
  <div class="post-nav thin">
	
	
  </div>

  
</main>

	  </div>
	  
	  



<footer id="site-footer" class="section-inner thin animated fadeIn faster">
  <p>&copy; 2022 <a href="https:&#x2F;&#x2F;bjeanes.com">Bo Jeanes</a></p>
  <p>Made with <a href="https://www.getzola.org" target="_blank" rel="noopener">Zola</a> &#183; Theme <a href="https://github.com/VersBinarii/hermit_zola" target="_blank" rel="noopener">Hermit_Zola</a>
	
	&#183; <a href="https://bjeanes.com/atom.xml" target="_blank" title="rss"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a>
	
  </p>
</footer>




	</div>
	
	<script src="https://bjeanes.com/js/main.js"></script>

	<!-- Math rendering -->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css" integrity="sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js" integrity="sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js" integrity="sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI" crossorigin="anonymous"
        onload="renderMathInElement(document.body, { delimiters: [ {left: '$$', right: '$$', display: true}, {left: '$', right: '$', display: false}, {left: '\\[', right: '\\]', display: true}, {left: '\\(', right: '\\)', display: false}]});"></script>

    

	
	<script src="https://bjeanes.com/js/copy.js"></script>
	
	<script src="https://bjeanes.com/js/main.js"></script>

    
    

	
  </body>
</html>
