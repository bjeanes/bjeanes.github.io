<!DOCTYPE html>
<html lang="en-us">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  <meta itemprop="name" content="Bo Jeanes" />
  <meta itemprop="description" content="" />

  <link rel="apple-touch-icon" sizes="180x180" href="https://bjeanes.com/apple-touch-icon.png"/>
  <link rel="icon" type="image/png" sizes="32x32" href="https://bjeanes.com/favicon-32x32.png" />
  <link
    rel="icon"
    type="image/png"
    sizes="16x16"
    href="https://bjeanes.com/favicon-16x16.png"
  />
  <link
    rel="shortcut icon"
    href="https://bjeanes.com/favicon.ico"
  />
  <link rel="stylesheet" href="https://bjeanes.com/style.css"/>
  
  <title>RubyCocoa and Keychain access</title>
  

  
  <link rel="alternate" type="application/rss+xml" title="RSS" href="https://bjeanes.com/atom.xml">
  

  <body id="page">

	
<header id="site-header" class="animated slideInUp faster">
  <div class="hdr-wrapper section-inner">
    <div class="hdr-left">
      <div class="site-branding">
        <a href="https:&#x2F;&#x2F;bjeanes.com">Bo Jeanes</a>
      </div>
      <nav class="site-nav hide-in-mobile">
            
        
        <a href="https://bjeanes.com/posts">Posts</a>
        
        <a href="https://bjeanes.com/about">About</a>
        
      </nav>
    </div>
    <div class="hdr-right hdr-icons">
      <span class="hdr-social hide-in-mobile">
        

<a href="https:&#x2F;&#x2F;github.com&#x2F;bjeanes" target="_blank" rel="noopener me"
   title="github">
  
  <svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg>
  
</a>

<a href="https:&#x2F;&#x2F;gitlab.com&#x2F;bjeanes" target="_blank" rel="noopener me"
   title="gitlab">
  
  <svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22.65 14.39L12 22.13 1.35 14.39a.84.84 0 0 1-.3-.94l1.22-3.78 2.44-7.51A.42.42 0 0 1 4.82 2a.43.43 0 0 1 .58 0 .42.42 0 0 1 .11.18l2.44 7.49h8.1l2.44-7.51A.42.42 0 0 1 18.6 2a.43.43 0 0 1 .58 0 .42.42 0 0 1 .11.18l2.44 7.51L23 13.45a.84.84 0 0 1-.35.94z"></path></svg>
  
</a>

<a href="https:&#x2F;&#x2F;twitter.com&#x2F;bjeanes" target="_blank" rel="noopener me"
   title="twitter">
  
  <svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path></svg>
  
</a>

<a href="https:&#x2F;&#x2F;instagram.com&#x2F;bjeanes" target="_blank" rel="noopener me"
   title="instagram">
  
  <svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path><line x1="17.5" y1="6.5" x2="17.5" y2="6.5"></line></svg>
  
</a>

<a href="https:&#x2F;&#x2F;www.linkedin.com&#x2F;in&#x2F;bjeanes&#x2F;" target="_blank" rel="noopener me"
   title="linkedin">
  
  <svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect x="2" y="9" width="4" height="12"></rect><circle cx="4" cy="4" r="2"></circle></svg>
  
</a>

<a href="mailto:me@bjeanes.com" target="_blank" rel="noopener me"
   title="email">
  
  <svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
  
</a>


      </span>
      <button id="menu-btn" class="hdr-btn" title="Menu">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          class="feather feather-menu"
        >
          <line x1="3" y1="12" x2="21" y2="12"></line>
          <line x1="3" y1="6" x2="21" y2="6"></line>
          <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
      </button>
    </div>
  </div>
</header>
<div id="mobile-menu" class="animated fast">
  <ul>
    
    <li><a href="https://bjeanes.com/posts">Posts</a></li>
    
    <li><a href="https://bjeanes.com/about">About</a></li>
    
  </ul>
</div>

	
	

		
<main class="site-main section-inner animated fadeIn faster">
  <article class="thin">
	<header class="post-header">
	  <div class="post-meta">
		
		<span>Apr 10, 2008</span>
		<small> - 
<span class="reading-time" title="Estimated read time">
  
  2 min read
  
</span>
</small>
		
            
	  </div>
	  <h1>RubyCocoa and Keychain access</h1>
	</header>

	<div class="content">
        
	  <p>There have been a few posts asking how to access and manipulate the
Keychain from within RubyCocoa but no answers supplied. As someone who
is just getting into RubyCocoa (and Cocoa all together for that matter),
I thought I’d document once and for all the process I took to get it
working.</p>
<p>I am running on Leopard and while 10.5 is supposed to ship with
BridgeSupport for most frameworks, the Security framework must have been
left out. After playing around with using other frameworks (such as the
AddressBook framework) and seeing how they were used, I did a bit of
digging in the Apple Developer Documentation (incredible resource for
anyone starting out) and stumbled across this gem: <a href="http://developer.apple.com/documentation/Cocoa/Conceptual/RubyPythonCocoa/Articles/GenerateFrameworkMetadata.html#//apple_ref/doc/uid/TP40005426">Generate Framework
Metadata</a></p>
<p>After reading this, I was accessing the keychain within 5 minutes.
Here’s how:</p>
<ol>
<li>
<p>Run the following commands (first one will take some time):</p>
<pre data-lang="bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#bf616a;">gen_bridge_metadata -f</span><span> Security</span><span style="color:#bf616a;"> -o</span><span> Security.bridgesupport
</span><span style="color:#bf616a;">mkdir -p</span><span> /Library/BridgeSupport
</span><span style="color:#bf616a;">mv</span><span> Security.bridgesupport /Library/BridgeSupport
</span></code></pre>
</li>
<li>
<p>Open an IRB session to test it:</p>
</li>
</ol>
<pre data-lang="ruby" style="background-color:#2b303b;color:#c0c5ce;" class="language-ruby "><code class="language-ruby" data-lang="ruby"><span>&gt;&gt; </span><span style="color:#8fa1b3;">require </span><span>&#39;</span><span style="color:#a3be8c;">osx/cocoa</span><span>&#39;
</span><span>=&gt; </span><span style="color:#d08770;">true
</span><span>&gt;&gt; </span><span style="color:#ebcb8b;">OSX</span><span>.require_framework &#39;</span><span style="color:#a3be8c;">Security</span><span>&#39;
</span><span>=&gt; </span><span style="color:#d08770;">true
</span><span>&gt;&gt; </span><span style="color:#b48ead;">defined? </span><span style="color:#ebcb8b;">OSX</span><span>::SecKeychainAddGenericPassword()
</span><span>=&gt; &quot;</span><span style="color:#a3be8c;">method</span><span>&quot;
</span></code></pre>
<p>Hoorah! Two steps! Well, one because the second one was just testing…
Now go make password-able RubyCocoa application! I am not sure how to
pull this off with deployable apps but I suggest your apps could ship
with the file or run those commands on first-run or if the
Security.bridgesupport file doesn’t exist. Note: I have not tested
either of those scenarios, but I would guess the latter would be more
reliable for cross-version development (i.e. Tiger + Leopard)</p>
<h3 id="how-to-use-these-methods">How to use these methods</h3>
<pre data-lang="ruby" style="background-color:#2b303b;color:#c0c5ce;" class="language-ruby "><code class="language-ruby" data-lang="ruby"><span style="color:#65737e;"># Require needed libraries
</span><span>
</span><span style="color:#8fa1b3;">require </span><span>&#39;</span><span style="color:#a3be8c;">osx/cocoa</span><span>&#39;
</span><span style="color:#8fa1b3;">include </span><span style="color:#bf616a;">OSX
</span><span>require_framework &#39;</span><span style="color:#a3be8c;">Security</span><span>&#39;
</span><span>
</span><span style="color:#65737e;"># Set up some relevant variables
</span><span>
</span><span>service = &quot;</span><span style="color:#a3be8c;">Test Service</span><span>&quot;
</span><span>account = &quot;</span><span style="color:#a3be8c;">MyUsername</span><span>&quot;
</span><span>password = &quot;</span><span style="color:#a3be8c;">MyPassword</span><span>&quot;
</span><span>
</span><span style="color:#65737e;"># Add password to default keychain (first param)
</span><span>
</span><span style="color:#bf616a;">SecKeychainAddGenericPassword</span><span>(</span><span style="color:#d08770;">nil</span><span>, service.length, service, account.length, account, password.length, password, </span><span style="color:#d08770;">nil</span><span>)
</span><span>
</span><span style="color:#65737e;"># Finding a password in default keychain (first param)
</span><span>
</span><span>status, *password = </span><span style="color:#bf616a;">SecKeychainFindGenericPassword</span><span>(</span><span style="color:#d08770;">nil</span><span>, service.length, service, account.length, account)
</span><span>
</span><span style="color:#65737e;"># Password-related data
</span><span>password_length = password.shift </span><span style="color:#65737e;"># =&gt; 10
</span><span>password_data = password.shift </span><span style="color:#65737e;"># OSX::ObjcPtr object
</span><span>password = password_data.bytestr(password_length)
</span><span>
</span><span style="color:#65737e;"># The last item is another OSX::ObjcPtr. I haven&#39;t figured
</span><span style="color:#65737e;"># out how to cast or use this yet but will post when I&#39;ve
</span><span style="color:#65737e;"># figured it out
</span><span>keychain_item = password.shift
</span><span>
</span><span style="color:#65737e;"># Yay it works! You can also check the password exists
</span><span style="color:#65737e;"># in the Keychain Access utility. I&#39;ve confirmed that
</span><span style="color:#65737e;"># this works
</span><span style="color:#96b5b4;">puts</span><span> password </span><span style="color:#65737e;"># =&gt; &quot;MyPassword&quot;
</span></code></pre>
<h3 id="update-4-8-08-below-is-a-fix-for-the-rexml-bug-some-people-have">[UPDATE 4/8/08]: Below is a fix for the REXML bug some people have</h3>
<p>been getting (myself included)</p>
<p>There is good news for anyone that has been getting the following error:</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>undefined local variable or method `trans’ for &lt;UNDEFINED&gt; … &lt;/&gt;:REXML::Document
</span><span>Usage: gen_bridge_metadata [options] &lt;headers…&gt;
</span><span>Use the `-h’ flag or consult gen_bridge_metadata(1) for help.
</span></code></pre>
<p>There is a very simple fix. This is caused by a typo in the source of
REXML. It’s such a massive bug I can’t believe it made it into the
release of Ruby but i did some poking around and it looks like they
renamed a method and didn’t change all references to it.</p>
<p>There are two ways to fix it—patching REXML; and patching <code>gen_bridge_metadata</code>.</p>
<p>Personally I prefer patching the generator for peace of mind and have submitted the patch at
<a href="http://bridgesupport.macosforge.org/trac/ticket/1">http://bridgesupport.macosforge.org/trac/ticket/1</a>,
but I’ll show both fixes.</p>
<h4 id="patching-genbridgemetadata">Patching gen<em>bridge</em>metadata</h4>
<ol>
<li>Open <code>/usr/bin/gen_bridge_metadata and find the method definition for </code>generate_xml`</li>
<li>Replace <code>0</code> in the <code>xml_document.write()</code> with <code>-1</code> (both occurrences)</li>
<li>Save!</li>
</ol>
<h4 id="patching-rexml">Patching REXML</h4>
<ol>
<li>Open
<code>/System/Library/Frameworks/Ruby.framework/Versions/1.8/usr/lib/ruby/1.8/rexml/document.rb</code></li>
<li>Find the line that has <code>if trans</code> and change it to <code>if transitive</code></li>
<li>Save!</li>
</ol>

	</div>
	<hr class="post-end">
	<footer class="post-info">
    
    <p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>609 Words</p>
    
    <p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>2008-04-10T12:00:00Z</p>
    
	</footer>
  </article>
    
  
  <div class="post-nav thin">
	
	
  </div>

  
</main>

	  </div>
	  
	  



<footer id="site-footer" class="section-inner thin animated fadeIn faster">
  <p>&copy; 2022 <a href="https:&#x2F;&#x2F;bjeanes.com">Bo Jeanes</a></p>
  <p>Made with <a href="https://www.getzola.org" target="_blank" rel="noopener">Zola</a> &#183; Theme <a href="https://github.com/VersBinarii/hermit_zola" target="_blank" rel="noopener">Hermit_Zola</a>
	
	&#183; <a href="https://bjeanes.com/atom.xml" target="_blank" title="rss"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a>
	
  </p>
</footer>




	</div>
	
	<script src="https://bjeanes.com/js/main.js"></script>

	<!-- Math rendering -->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css" integrity="sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js" integrity="sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js" integrity="sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI" crossorigin="anonymous"
        onload="renderMathInElement(document.body, { delimiters: [ {left: '$$', right: '$$', display: true}, {left: '$', right: '$', display: false}, {left: '\\[', right: '\\]', display: true}, {left: '\\(', right: '\\)', display: false}]});"></script>

    

	
	<script src="https://bjeanes.com/js/copy.js"></script>
	
	<script src="https://bjeanes.com/js/main.js"></script>

    
    

	
  </body>
</html>
