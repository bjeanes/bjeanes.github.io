<!DOCTYPE html>
<html lang="">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Meta Robots Tag -->
  <meta name="robots" content="all">

  <!-- Site Author -->
  <meta name="author" content="bo">

  <!-- Atom Feed -->
  <link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Bo Jeanes Feed">
  
  <!-- Stylesheet -->
  <link rel="stylesheet" href="/assets/css/minimal.css">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="/favicon.png">

  <!-- Analytics -->
  

  <!-- SEO -->
  <!-- Begin Jekyll SEO tag v2.3.0 -->
<title>Bo Jeanes</title>
<meta property="og:title" content="Bo Jeanes" />
<meta name="author" content="Bo Jeanes" />
<meta property="og:locale" content="en_US" />
<link rel="canonical" href="https://bjeanes.com/2009/" />
<meta property="og:url" content="https://bjeanes.com/2009/" />
<meta property="og:site_name" content="Bo Jeanes" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2009-01-01T00:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@bjeanes" />
<meta name="twitter:creator" content="@bjeanes" />
<script type="application/ld+json">
{"mainEntityOfPage":{"@type":"WebPage","@id":"https://bjeanes.com/2009/"},"description":null,"@type":"BlogPosting","url":"https://bjeanes.com/2009/","name":null,"headline":"Bo Jeanes","dateModified":"2009-01-01T00:00:00+00:00","datePublished":"2009-01-01T00:00:00+00:00","sameAs":null,"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://avatars2.githubusercontent.com/u/2560?s=200&v=4"},"name":"Bo Jeanes"},"image":null,"author":{"@type":"Person","name":"Bo Jeanes"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

</head>

<body class="black-90 ">

<div class="flex flex-column items-center">
  <div class="mw7 w-100 ph3 ph4-ns">
    <h1 class="f5 fw4 lh-title mb0 pb2 bb b--light-gray">Posts from 2009</h1>

    
    <a class="link black-80 hover-silver" href="/2009/12/australias-mandatory-internet-filter/">
      <article class="f5 lh-copy fw3 pb4 bb b--light-gray">
        <div class="f6 fw6 lh-title ttu tracked mv4"><time>Dec 2009</time></div>
        <h3 class="f3 fw6 lh-title mb0">Australia&#39;s Mandatory Internet Filter</h3>
        <p class="f5 fw3 lh-copy mv2">I apologise to those who are uninterested for the rant that follows:

I can not stand nor hardly believe that the current government of my
otherwise awesome country would choose to completely ignore the advice
and expertise of industry professionals and the interests of the voters.

Today Steven Conroy, the Australian Minister of Communications, managed
to get a piece of legislation <del>passed</del> introduced that will require
all Australian ISPs to participate in the mandatory filtering of content
delivered to Australian citizen. Welcome to the likes of Iran and China.

The legislation has been disguised as a measure to protect children from
porn and the likes, despite repeated advice from industry professionals
that it will do little to curb illegal content, cost the tax payers
millions of dollars and ultimately make legal browsing a slower and
inferior experience than it already is.

Furthermore, the government has made a effort to <a href="http://www.smh.com.au/articles/2009/03/17/1237054787635.html?page=fullpage">actively
suppress</a>
the contents of the block list, keeping those affected (read: everyone)
completely in the dark at to how it will affect their experience. The
block list was leaked and shown to include content about which the
government should have no say in how or why it is viewed such as some
youtube videos, topics on Euthanasia, a gay dating site, flash and
downloadable games, and sexual education material (contraceptives, etc).

To the Rudd government:

This is not good enough. I am a voter and a tax payer and I will not
stand for this. I will actively participate in removing this ridiculous
action and I will march the streets to show my support for an
unrestricted flow of information like the rest of the world will
continue to enjoy. I will show other tax payers how you have wasted $40
million (or more) of their money on a piece of technology no one wants
and that will not work and remind them that this is done in a time of
financial uncertainty instead of focusing on real issues like our carbon
footprint as a nation. I have the knowledge and the will to undermine
this pointless act, and I will use them to do so.
</p>
  
        <div class="f6 fw3 silver mt0">
          
          <time>15 Dec 2009</time>
          
          <span class="ttl">&middot; 



  
	  1 min read
	

</span>
        </div>
      </article>
    </a>
    
    <a class="link black-80 hover-silver" href="/2009/11/iterative-html5-turning-a-comma-separated-list-into-a-semantic-list/">
      <article class="f5 lh-copy fw3 pb4 bb b--light-gray">
        <div class="f6 fw6 lh-title ttu tracked mv4"><time>Nov 2009</time></div>
        <h3 class="f3 fw6 lh-title mb0">Iterative HTML5 - Turning a comma-separated list into a semantic list</h3>
        <p class="f5 fw3 lh-copy mv2">In the process of going through the redesign of <a href="http://mocra.com">http://mocra.com</a>, I keep finding better ways to make
the HTML more semantic.

<a href="http://chendo.net">Jack Chen</a> and I have been turning the design into 
HTML over the last few days and we’ve been striving to be as semantic as
possible by taking advantage of new HTML5 elements and by separating the
content further from the design code with all the new CSS3 selectors.

Here’s an example of something we just did to make the HTML cleaner and
more meaningful, whilst still maintaining the look and style.

Here’s what we are styling:

<img src="http://img.skitch.com/20091112-qujhy29f4e5mkpradfd3hb9hnj.jpg" alt="image" />

Usually your HTML (or HAML in this case) would look something like this:

<div class="language-haml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">%footer</span>
  <span class="nt">%aside</span>
    <span class="p">=</span> <span class="n">link_to</span> <span class="s1">'Dr Nic Williams'</span><span class="p">,</span> <span class="s1">'http://drnicwilliams.com/'</span>
    ,
    <span class="p">=</span> <span class="n">link_to</span> <span class="s1">'Bodaniel Jeanes'</span><span class="p">,</span> <span class="s1">'http://bjeanes.com/'</span>
    ,
    <span class="p">=</span> <span class="n">link_to</span> <span class="s1">'Jack Chen'</span><span class="p">,</span> <span class="s1">'http://chendo.net/'</span>
    ,                      
    <span class="p">=</span> <span class="n">link_to</span> <span class="s1">'Ryan Bigg'</span><span class="p">,</span> <span class="s1">'http://frozenplague.net/'</span>
</code></pre></div></div>

However, we can make this <strong>list</strong> of people more semantic by using an
<code class="highlighter-rouge">&lt;ul&gt;</code> element and some CSS magic.

Here’s what the new HTML (HAML here) would look like:

<div class="language-haml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">%footer</span>
  <span class="nt">%aside</span>
    <span class="nt">%ul</span>
      <span class="nt">%li</span><span class="p">=</span> <span class="n">link_to</span> <span class="s1">'Dr Nic Williams'</span><span class="p">,</span> <span class="s1">'http://drnicwilliams.com/'</span>
      <span class="nt">%li</span><span class="p">=</span> <span class="n">link_to</span> <span class="s1">'Bodaniel Jeanes'</span><span class="p">,</span> <span class="s1">'http://bjeanes.com/'</span>
      <span class="nt">%li</span><span class="p">=</span> <span class="n">link_to</span> <span class="s1">'Jack Chen'</span><span class="p">,</span>       <span class="s1">'http://chendo.net/'</span>
      <span class="nt">%li</span><span class="p">=</span> <span class="n">link_to</span> <span class="s1">'Ryan Bigg'</span><span class="p">,</span>       <span class="s1">'http://frozenplague.net/'</span>
</code></pre></div></div>

And the CSS (Sass here):

<div class="language-sass highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">body</span>
  <span class="nt">footer</span>
    <span class="nt">aside</span>
      <span class="nl">padding-top</span><span class="p">:</span> <span class="m">6px</span>
      <span class="nl">float</span><span class="p">:</span> <span class="nb">left</span>

      <span class="nt">ul</span>
        <span class="nl">list-style</span><span class="p">:</span> <span class="nb">none</span>
        <span class="nl">margin</span><span class="p">:</span> <span class="m">0</span>
        <span class="nl">padding</span><span class="p">:</span> <span class="m">0</span>
      
        <span class="nt">li</span>
          <span class="nl">display</span><span class="p">:</span> <span class="nb">inline</span>
          
          <span class="k">&amp;</span><span class="nd">:after</span>
            <span class="nl">content</span><span class="p">:</span> <span class="s2">","</span>
            
          <span class="k">&amp;</span><span class="nd">:last-child:after</span>
            <span class="nl">content</span><span class="p">:</span> <span class="s2">""</span>
</code></pre></div></div>
</p>
  
        <div class="f6 fw3 silver mt0">
          
          <time>12 Nov 2009</time>
          
          <span class="ttl">&middot; 



  
	  1 min read
	

</span>
        </div>
      </article>
    </a>
    
    <a class="link black-80 hover-silver" href="/2009/11/using-partial-layouts-to-dry-out-your-views/">
      <article class="f5 lh-copy fw3 pb4 bb b--light-gray">
        <div class="f6 fw6 lh-title ttu tracked mv4"><time>Nov 2009</time></div>
        <h3 class="f3 fw6 lh-title mb0">Using partial layouts to DRY out your views</h3>
        <p class="f5 fw3 lh-copy mv2">The other day we got some HTML from the designer of one of our clients
to implement as the new UI for an app we are building at
<a href="http://mocra.com/">Mocra</a>. Overall the HTML was good but implementing
it started to feel a little moist (i.e. not DRY).

For example, around all the apps form the client’s design had a rounded
white box, the HTML of which went something like this:

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"content-wht"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"content-wht-inside"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;fieldset&gt;</span>
            <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"frow"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;label&gt;</span>Currency:<span class="nt">&lt;/label&gt;</span>
                <span class="nt">&lt;select</span> <span class="na">class=</span><span class="s">"fs"</span><span class="nt">&gt;&lt;option&gt;</span>EUR<span class="nt">&lt;/option&gt;&lt;/select&gt;</span>
            <span class="nt">&lt;/div&gt;</span>

            <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"frow frlast"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;label&gt;</span>File:<span class="nt">&lt;/label&gt;</span>
                <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"file"</span> <span class="na">name=</span><span class="s">""</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;/fieldset&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>

<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"cround"</span> <span class="na">align=</span><span class="s">"center"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">"/images/round-corners-bottom.gif"</span> <span class="na">alt=</span><span class="s">""</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</code></pre></div></div>

It’s a lot of <code class="highlighter-rouge">div</code> tags to have to repeat around every form that has
this style. Luckily a nice feature of Rails partials can help out.
Create a shared partial file that will act as a layout like this:

<div class="language-rhtml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- app/views/shared/_fieldset.html.erb --&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"content-wht"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"content-wht-inside"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;fieldset&gt;</span>
            <span class="cp">&lt;%=</span> <span class="k">yield</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;/fieldset&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>

<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"cround"</span> <span class="na">align=</span><span class="s">"center"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">"/images/round-corners-bottom.gif"</span> <span class="na">alt=</span><span class="s">""</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</code></pre></div></div>

Then in your views that need to have this white box, simply wrap your
content in that layout like so:

<div class="language-rhtml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;%</span> <span class="n">render</span> <span class="ss">:layout</span> <span class="o">=&gt;</span> <span class="s1">'shared/fieldset'</span> <span class="k">do</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"frow"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;label&gt;</span>Currency:<span class="nt">&lt;/label&gt;</span>
      <span class="nt">&lt;select</span> <span class="na">class=</span><span class="s">"fs"</span><span class="nt">&gt;&lt;option&gt;</span>EUR<span class="nt">&lt;/option&gt;&lt;/select&gt;</span>
  <span class="nt">&lt;/div&gt;</span>

  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"frow frlast"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;label&gt;</span>File:<span class="nt">&lt;/label&gt;</span>
      <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"file"</span> <span class="na">name=</span><span class="s">""</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>

<span class="c">&lt;!-- Or, if the inner content is already in a partial --&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">render</span><span class="p">,</span> <span class="ss">:partial</span> <span class="o">=&gt;</span> <span class="s1">'form'</span><span class="p">,</span> <span class="ss">:layout</span> <span class="o">=&gt;</span> <span class="s1">'shared/fieldset'</span> <span class="cp">%&gt;</span>
</code></pre></div></div>
</p>
  
        <div class="f6 fw3 silver mt0">
          
          <time>5 Nov 2009</time>
          
          <span class="ttl">&middot; 



  
	  1 min read
	

</span>
        </div>
      </article>
    </a>
    
    <a class="link black-80 hover-silver" href="/2009/11/64-bit-postgres-and-rails-on-snow-leopard/">
      <article class="f5 lh-copy fw3 pb4 bb b--light-gray">
        <div class="f6 fw6 lh-title ttu tracked mv4"><time>Nov 2009</time></div>
        <h3 class="f3 fw6 lh-title mb0">64-bit Postgres and Rails on Snow Leopard </h3>
        <p class="f5 fw3 lh-copy mv2"><h3 id="dependencies">Dependencies</h3>

Install the GEOS and PROJ frameworks from
<a href="http://www.kyngchaos.com/software:frameworks">here</a>

<h3 id="postgres">Postgres</h3>

<h4 id="download-and-compile">Download and Compile</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://ftp2.au.postgresql.org/pub/postgresql/source/v8.4.1/postgresql-8.4.1.tar.bz2 | <span class="nb">tar </span>xjf -
<span class="nb">cd </span>postgresql-8.4.1
./configure
make <span class="o">&amp;&amp;</span> <span class="nb">sudo </span>make install
</code></pre></div></div>

The files are now all installed in the right places, onwards to making
them usable!

<h4 id="create-a-postgres-user-and-group">Create a <code class="highlighter-rouge">postgres</code> User and Group</h4>

This is adjusted from the instructions in the comments
<a href="http://www.postgresql.org/docs/8.3/interactive/postgres-user.html">here</a>).

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Find unused Group ID and User ID:</span>
<span class="nb">export </span><span class="nv">GROUPID</span><span class="o">=</span><span class="sb">`</span><span class="nb">sudo </span>dscl <span class="nb">.</span> <span class="nt">-list</span> /Groups PrimaryGroupID | ruby <span class="nt">-e</span> <span class="s1">'puts STDIN.read.scan(/\d+/m).map{|i|i.to_i}.uniq.sort.last.succ'</span><span class="sb">`</span>
<span class="nb">export </span><span class="nv">USERID</span><span class="o">=</span><span class="sb">`</span><span class="nb">sudo </span>dscl <span class="nb">.</span> <span class="nt">-list</span> /Users UniqueID | ruby <span class="nt">-e</span> <span class="s1">'puts STDIN.read.scan(/\d+/m).map{|i|i.to_i}.uniq.sort.last.succ'</span><span class="sb">`</span>

<span class="c"># Create group:</span>
<span class="nb">sudo </span>dscl <span class="nb">.</span> <span class="nt">-create</span> /Groups/_postgres
<span class="nb">sudo </span>dscl <span class="nb">.</span> <span class="nt">-create</span> /Groups/_postgres PrimaryGroupID <span class="nv">$GROUPID</span>
<span class="nb">sudo </span>dscl <span class="nb">.</span> <span class="nt">-append</span> /Groups/_postgres RecordName postgres

<span class="c"># Create user:</span>
<span class="nb">sudo </span>dscl <span class="nb">.</span> <span class="nt">-create</span> /Users/_postgres
<span class="nb">sudo </span>dscl <span class="nb">.</span> <span class="nt">-create</span> /Users/_postgres UniqueID <span class="nv">$USERID</span>
<span class="nb">sudo </span>dscl <span class="nb">.</span> <span class="nt">-create</span> /Users/_postgres PrimaryGroupID <span class="nv">$GROUPID</span>
<span class="nb">sudo </span>dscl <span class="nb">.</span> <span class="nt">-create</span> /Users/_postgres UserShell /bin/bash
<span class="nb">sudo </span>dscl <span class="nb">.</span> <span class="nt">-create</span> /Users/_postgres RealName <span class="s2">"PostgreSQL Server"</span>
<span class="nb">sudo </span>dscl <span class="nb">.</span> <span class="nt">-create</span> /Users/_postgres NFSHomeDirectory /usr/local/pgsql
<span class="nb">sudo </span>dscl <span class="nb">.</span> <span class="nt">-append</span> /Users/_postgres RecordName postgres
</code></pre></div></div>

That’s the clean way of making a user (so it doesn’t show up in your
Accounts preference pane, etc.

<h4 id="clean-up">Clean up</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>touch /var/log/psql.log
<span class="nb">sudo </span>mkdir /usr/local/pgsql/data
<span class="nb">sudo </span>chown <span class="nt">-R</span> postgres:postgres /usr/local/pgsql/data /var/log/psql.log

<span class="c"># Put Postgres in your path</span>
<span class="nb">export</span> <span class="nv">$PATH</span><span class="o">=</span><span class="s2">"/usr/local/pgsql/bin:</span><span class="nv">$PATH</span><span class="s2">"</span>
<span class="nb">sudo </span>sh <span class="nt">-c</span> <span class="s1">'echo /usr/local/pgsql/bin &gt; /etc/paths.d/pgsql'</span>
</code></pre></div></div>

Thanks to Apple we have a nice way of setting the PATH across the entire
system so every app should now know how to find the Postgres binaries
and the data directory is now set up to store the database files — now,
we just need to create them.

<h4 id="initialise-the-database">Initialise the Database</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Become the postgres user</span>
<span class="nb">sudo </span>su - postgres

<span class="c"># If this throws next commant throws an error about shared memory, </span>
<span class="c"># try putting "these lines":http://gist.github.com/224815 into </span>
<span class="c"># /etc/sysctl.conf, rebooting, and trying again:</span>
initdb <span class="nt">-D</span> /usr/local/pgsql/data <span class="nt">-E</span> UTF8

<span class="c"># Start the database</span>
postgres <span class="nt">-D</span> /usr/local/pgsql/data <span class="o">&gt;</span>/var/log/psql.log 2&gt;&amp;1 &amp;

<span class="c"># Create a test database and check you can connect to it</span>
createdb <span class="nb">test
</span>psql <span class="nb">test</span>

<span class="c"># Just create a superuser for general dev tasks</span>
createuser postgres

<span class="c"># we don't want to be the postgres user anymore</span>
<span class="nb">exit</span>
</code></pre></div></div>

Your done with the Postgres setup now!

<h3 id="postgis">PostGIS</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl http://postgis.refractions.net/download/postgis-1.3.7SVN.tar.gz | <span class="nb">tar </span>xzf -
<span class="nb">cd </span>postgis-1.3.7SVN
./configure <span class="nt">--with-geosconfig</span><span class="o">=</span>/Library/Frameworks/GEOS.framework/unix/bin/geos-config <span class="nt">--with-projdir</span><span class="o">=</span>/Library/Frameworks/PROJ.framework/unix
make <span class="o">&amp;&amp;</span> <span class="nb">sudo </span>make install
</code></pre></div></div>

Phew! That one was easy.

<h3 id="postgres-ruby-gem">Postgres Ruby Gem</h3>

This is the part that everyone cares about the most. If this works your
Rails apps should start working like a charm.

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>env <span class="nv">ARCHFLAGS</span><span class="o">=</span><span class="s1">'-arch x86_64'</span> gem install pg
</code></pre></div></div>
</p>
  
        <div class="f6 fw3 silver mt0">
          
          <time>3 Nov 2009</time>
          
          <span class="ttl">&middot; 



  
	  2 min read
	

</span>
        </div>
      </article>
    </a>
    
    <a class="link black-80 hover-silver" href="/2009/10/using-fish-shells-event-system-to-behave-like-method-missing/">
      <article class="f5 lh-copy fw3 pb4 bb b--light-gray">
        <div class="f6 fw6 lh-title ttu tracked mv4"><time>Oct 2009</time></div>
        <h3 class="f3 fw6 lh-title mb0">Using Fish shell&#39;s event system to behave like method_missing</h3>
        <p class="f5 fw3 lh-copy mv2">Dr Nic’s latest post, <a href="http://drnicwilliams.com/2009/10/07/hash-bang-cucumber/">hash bang
cucumber</a>,
reminded me of a piece of hax I whipped up a few weeks ago with Ruby and
Fish Shell.

Fish has an event system that allows you to register functions to be
auto-run after or during certain events (such as when a particular
environment variable is changed). One of this events is called
<code class="highlighter-rouge">fish_command_not_found</code>. It is triggered whenever you type a
non-existant command into the prompt.

With this in mind, you can trigger certain commands to run by matching
what fish couldn’t manage to run automatically by catching this event.

For instance:

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function </span>__fish_method_missing <span class="nt">--on-event</span> fish_command_not_found
  method_missing <span class="nv">$argv</span>
end

funcsave method_missing
</code></pre></div></div>

Given that function is created (simply paste the whole code block into
your Fish terminal), I can now create a command called
<code class="highlighter-rouge">method_missing</code> (or whatever you call inside your
<code class="highlighter-rouge">__fish_method_missing</code>) and place it somewhere in your <code class="highlighter-rouge">$PATH</code> — I like
<code class="highlighter-rouge">~/.config/fish/bin</code>.

My <code class="highlighter-rouge">method_missing</code> binary is simply something like this:

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env ruby</span>

<span class="n">command</span> <span class="o">=</span> <span class="no">ARGV</span><span class="p">.</span><span class="nf">shift</span>

<span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
  <span class="nb">puts</span> <span class="s2">"Running </span><span class="si">#{</span><span class="n">cmd</span><span class="p">.</span><span class="nf">inspect</span><span class="si">}</span><span class="s2"> instead"</span>
  <span class="nb">system</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">case</span> <span class="n">command</span>
<span class="k">when</span> <span class="sr">/^git(@|:\/\/).*\.git$/</span>
  <span class="n">run</span><span class="p">(</span><span class="s2">"git clone </span><span class="si">#{</span><span class="n">command</span><span class="p">.</span><span class="nf">inspect</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="k">when</span> <span class="sr">/^(?:ftp|https?):\/\/.+\.t(?:ar\.)?gz$/</span>
  <span class="n">run</span><span class="p">(</span><span class="s2">"curl </span><span class="si">#{</span><span class="n">command</span><span class="p">.</span><span class="nf">inspect</span><span class="si">}</span><span class="s2"> | tar xzv"</span><span class="p">)</span>
<span class="k">else</span>
  <span class="vg">$stderr</span><span class="p">.</span><span class="nf">puts</span> <span class="s2">"No default action defined in </span><span class="si">#{</span><span class="kp">__FILE__</span><span class="p">.</span><span class="nf">inspect</span><span class="si">}</span><span class="s2">"</span>
  <span class="nb">abort</span>
<span class="k">end</span>
</code></pre></div></div>

Each command you want to register just becomes a new <code class="highlighter-rouge">when</code>
statement. For instance, to implement the functionality Dr Nic was
trying to achieve, I simply modify the <code class="highlighter-rouge">case</code> block as such:

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">case</span> <span class="n">command</span>
<span class="k">when</span> <span class="sr">/^[a-z0-9_\-\/]+\.feature(:\d+)?$/</span>
  <span class="n">run</span><span class="p">(</span><span class="s2">"cucumber </span><span class="si">#{</span><span class="n">command</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="c1"># ... </span>
<span class="k">end</span>
</code></pre></div></div>

The existing entries I have in my <code class="highlighter-rouge">method_missing</code> command will
auto-clone the repository of a pasted Git URL and download and expand a
URL for a tar file, respectively. Not too shabby, and dead easy to
implement
</p>
  
        <div class="f6 fw3 silver mt0">
          
          <time>7 Oct 2009</time>
          
          <span class="ttl">&middot; 



  
	  1 min read
	

</span>
        </div>
      </article>
    </a>
    
    <a class="link black-80 hover-silver" href="/2009/10/gotcha-with-hash-new-when-providing-a-default-value/">
      <article class="f5 lh-copy fw3 pb4 bb b--light-gray">
        <div class="f6 fw6 lh-title ttu tracked mv4"><time>Oct 2009</time></div>
        <h3 class="f3 fw6 lh-title mb0">Gotcha with Hash.new when providing a default value</h3>
        <p class="f5 fw3 lh-copy mv2">For a project I am working on at the moment, I needed a <code class="highlighter-rouge">Hash</code>
that returned a different default value, i.e. not <code class="highlighter-rouge">nil</code>.
Specifically, I needed it to return another <code class="highlighter-rouge">Hash</code>, and for that
internal <code class="highlighter-rouge">Hash</code>’s default value to be an <code class="highlighter-rouge">Array</code>, like so:

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">hash</span> <span class="o">=</span> <span class="c1"># ...</span>
<span class="nb">p</span> <span class="nb">hash</span><span class="p">.</span><span class="nf">class</span>                              <span class="c1">#=&gt; Hash</span>
<span class="nb">p</span> <span class="nb">hash</span><span class="p">[</span><span class="ss">:non_existant_key</span><span class="p">].</span><span class="nf">class</span>           <span class="c1">#=&gt; Hash</span>
<span class="nb">p</span> <span class="nb">hash</span><span class="p">[</span><span class="ss">:another</span><span class="p">][</span><span class="ss">:non_existant_key</span><span class="p">].</span><span class="nf">class</span> <span class="c1">#=&gt; Array</span>
</code></pre></div></div>

Naïvely, I threw this into my code, and went along my merry way:
<code class="highlighter-rouge">entries = Hash.new(Hash.new([]))</code>. A few days later, I came back
to this code to finish it and realised that something was awry with the
values I was getting out of the <code class="highlighter-rouge">Hash</code>. It took me a while to figure it
out because the values were all integers being summed together and I was
never looking or setting the values directly.

However, eventually I saw a pattern — many of the values were the same.
For instance, given the following assignments, I should expect
<code class="highlighter-rouge">[ruby]p entries[153][:monday] #=&gt; [12.hours]</code>:

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">entries</span><span class="p">[</span><span class="mi">153</span><span class="p">][</span><span class="ss">:monday</span><span class="p">]</span>  <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">.</span><span class="nf">hours</span>
<span class="n">entries</span><span class="p">[</span><span class="mi">153</span><span class="p">][</span><span class="ss">:tuesday</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">.</span><span class="nf">hours</span>
<span class="n">entries</span><span class="p">[</span><span class="mi">87</span><span class="p">][</span><span class="ss">:monday</span><span class="p">]</span>   <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">.</span><span class="nf">hours</span>
<span class="n">entries</span><span class="p">[</span><span class="mi">87</span><span class="p">][</span><span class="ss">:tuesday</span><span class="p">]</span>  <span class="o">&lt;&lt;</span> <span class="mf">2.5</span><span class="p">.</span><span class="nf">hours</span>
</code></pre></div></div>

However, what I found was the following:

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">p</span> <span class="n">entries</span><span class="p">[</span><span class="mi">153</span><span class="p">][</span><span class="ss">:monday</span><span class="p">]</span>  <span class="c1">#=&gt; [12.hours, 3.hours, 7.hours, 2.5.hours]</span>
<span class="nb">p</span> <span class="n">entries</span><span class="p">[</span><span class="mi">153</span><span class="p">][</span><span class="ss">:tuesday</span><span class="p">]</span> <span class="c1">#=&gt; [12.hours, 3.hours, 7.hours, 2.5.hours]</span>
<span class="nb">p</span> <span class="n">entries</span><span class="p">[</span><span class="mi">87</span><span class="p">][</span><span class="ss">:monday</span><span class="p">]</span>   <span class="c1">#=&gt; [12.hours, 3.hours, 7.hours, 2.5.hours]</span>
<span class="nb">p</span> <span class="n">entries</span><span class="p">[</span><span class="mi">87</span><span class="p">][</span><span class="ss">:tuesday</span><span class="p">]</span>  <span class="c1">#=&gt; [12.hours, 3.hours, 7.hours, 2.5.hours]</span>

<span class="c1"># And in fact:</span>
<span class="nb">p</span> <span class="n">entries</span><span class="p">[</span><span class="ss">:any</span><span class="p">][</span><span class="ss">:thing</span><span class="p">]</span>  <span class="c1">#=&gt; [12.hours, 3.hours, 7.hours, 2.5.hours]</span>
</code></pre></div></div>

Let that soak in for a second. <code class="highlighter-rouge">Hash.new({})</code> uses the <strong>same
instance</strong> of the internal <code class="highlighter-rouge">Array</code> as the default value for each
of the inner-most keys. It also doesn’t set the key you want so
<code class="highlighter-rouge">p entries</code> still printed <code class="highlighter-rouge">{}</code>. In retrospect, it is
blatantly obvious that it does this, but the ramifications are still
huge.

The way to get the intended effect is of course to use the block syntax
of <code class="highlighter-rouge">[ruby]Hash.new</code> which, while much uglier, definitely works as
expected:

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">entries</span> <span class="o">=</span> <span class="no">Hash</span><span class="p">.</span><span class="nf">new</span> <span class="p">{</span><span class="o">|</span><span class="nb">hash</span><span class="p">,</span> <span class="n">key</span><span class="o">|</span> <span class="nb">hash</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="no">Hash</span><span class="p">.</span><span class="nf">new</span> <span class="p">{</span><span class="o">|</span><span class="n">h</span><span class="p">,</span> <span class="n">k</span><span class="o">|</span> <span class="n">h</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span> <span class="p">}}</span>
<span class="n">entries</span><span class="p">[</span><span class="mi">153</span><span class="p">][</span><span class="ss">:monday</span><span class="p">]</span>  <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">.</span><span class="nf">hours</span>
<span class="n">entries</span><span class="p">[</span><span class="mi">153</span><span class="p">][</span><span class="ss">:tuesday</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">.</span><span class="nf">hours</span>
<span class="n">entries</span><span class="p">[</span><span class="mi">87</span><span class="p">][</span><span class="ss">:monday</span><span class="p">]</span>   <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">.</span><span class="nf">hours</span>
<span class="n">entries</span><span class="p">[</span><span class="mi">87</span><span class="p">][</span><span class="ss">:tuesday</span><span class="p">]</span>  <span class="o">&lt;&lt;</span> <span class="mf">2.5</span><span class="p">.</span><span class="nf">hours</span>

<span class="nb">p</span> <span class="n">entries</span> <span class="c1">#=&gt; {87=&gt;{:monday=&gt;[7.hours], :tuesday=&gt;[2.5.hours]}, 153=&gt;{:monday=&gt;[12.hours], :tuesday=&gt;[3.hours]}}</span>
</code></pre></div></div>

Wow. Obvious, but good to remember. I am sure most of you have had this
issue before, but I think it is still worthy of mention…
</p>
  
        <div class="f6 fw3 silver mt0">
          
          <time>1 Oct 2009</time>
          
          <span class="ttl">&middot; 



  
	  1 min read
	

</span>
        </div>
      </article>
    </a>
    
    <a class="link black-80 hover-silver" href="/2009/10/code-formatting-in-rss-feeds/">
      <article class="f5 lh-copy fw3 pb4 bb b--light-gray">
        <div class="f6 fw6 lh-title ttu tracked mv4"><time>Oct 2009</time></div>
        <h3 class="f3 fw6 lh-title mb0">Code formatting in RSS Feeds</h3>
        <p class="f5 fw3 lh-copy mv2">Apologies readers — I just realised that the code formatting is kinda
screwed up in RSS feeds because I am using some HTML5 elements to
represent my code blocks and using CSS to style them appropriately on
the site. The RSS feeds obviously lack these stylesheets and so look
pretty crap. I am not sure what the best solution is yet. Perhaps I
embed a <code class="highlighter-rouge">&lt;style&gt;</code> in each RSS post or simply have the RSS feeds
only show an excerpt of the full post.

</p>
  
        <div class="f6 fw3 silver mt0">
          
          <time>1 Oct 2009</time>
          
          <span class="ttl">&middot; 



  
	  Less than 1 min read
	

</span>
        </div>
      </article>
    </a>
    
    <a class="link black-80 hover-silver" href="/2009/09/proof-that-chendo-is-a-robot/">
      <article class="f5 lh-copy fw3 pb4 bb b--light-gray">
        <div class="f6 fw6 lh-title ttu tracked mv4"><time>Sep 2009</time></div>
        <h3 class="f3 fw6 lh-title mb0">Proof that @chendo is a robot</h3>
        <p class="f5 fw3 lh-copy mv2">Today I casually tweeted a hypothesis that
<a href="http://twitter.com/chendo">@chendo</a> drained my battery. The image below
shows the amusing responses that followed:

</p>
  
        <div class="f6 fw3 silver mt0">
          
          <time>4 Sep 2009</time>
          
          <span class="ttl">&middot; 



  
	  Less than 1 min read
	

</span>
        </div>
      </article>
    </a>
    
    <a class="link black-80 hover-silver" href="/2009/09/using-apache-as-a-basicauth-proxy-to-an-internal-resource/">
      <article class="f5 lh-copy fw3 pb4 bb b--light-gray">
        <div class="f6 fw6 lh-title ttu tracked mv4"><time>Sep 2009</time></div>
        <h3 class="f3 fw6 lh-title mb0">Using Apache as a BasicAuth proxy to an internal resource</h3>
        <p class="f5 fw3 lh-copy mv2">This article isn’t named ideally so if you have a better title, tell me.

This is the scenario: we have a simple HTTP resource on the internal
network at <a href="http://mocra.com">Mocra</a>. This resource is a closed source
tool which is great except that it has one drawback — there are only two
security modes: basic authentication on, or basic authentication off.
There is only one username/password and you can’t control when or by
whom it is required.

Now, my preferred behaviour here is to be able to give out multiple
login/passwords and also to only require authentication <strong>outside</strong> of
our local network. I set out to get this working.

I devised this solution a few months ago (which is why it’s using Apache
at all) but I thought it might be of some use to someone. I created an
Apache VirtualHost to act as a proxy between this resource and its
clients. It looks like this:

<div class="language-apache highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">&lt;</span><span class="nl">VirtualHost</span><span class="sr"> *:80</span><span class="p">&gt;
</span>  <span class="c"># This virtual host proxies requests for the internal resource</span>
  <span class="nc">ServerName</span> external.resource.com

  <span class="c"># Set auth header to base64 encoded 'username:password' </span>
  <span class="c"># where username and password are the credentials for internal resource</span>
  <span class="nc">RequestHeader</span> <span class="ss">set</span> Authorization "Basic dXNlcm5hbWU6cGFzc3dvcmQ="

  <span class="nc">ProxyPass</span> /resource_path/ http://192.168.1.123:1337/resource_path/
  <span class="nc">ProxyPassReverse</span> /resource_path/ http://192.168.1.123:1337/resource_path/

  <span class="p">&lt;</span><span class="nl">Location</span><span class="sr"> /</span><span class="p">&gt;
</span>    <span class="nc">Order</span> allow,deny
    <span class="nc">Allow</span> <span class="ss">from</span> 192.168.1.0/24 <span class="c"># our local subnet</span>
    <span class="nc">Allow</span> <span class="ss">from</span> 127.0.0.1 <span class="c"># duh</span>
    <span class="nc">Allow</span> <span class="ss">from</span> 1.3.3.7 <span class="c"># our external router IP</span>

    <span class="nc">AuthType</span> basic
    <span class="nc">AuthName</span> "Our Internal Resource"
    <span class="c"># where all the external login/passwords are</span>
    <span class="nc">AuthUserFile</span> /var/www/.htpasswd 
    Require <span class="ss">valid-user</span>

    <span class="c"># this is the secret sauce that allows EITHER</span>
    <span class="c"># local access or Basic Auth access</span>
    <span class="nc">Satisfy</span> Any 
  &lt;/Location&gt;

  <span class="nc">RewriteEngine</span> <span class="ss">on</span>
  <span class="nc">RewriteRule</span> ^/?$ http://external.resource.com:80/resource_path/ [R]
<span class="p">&lt;/</span><span class="nl">VirtualHost</span><span class="p">&gt;
</span></code></pre></div></div>
</p>
  
        <div class="f6 fw3 silver mt0">
          
          <time>2 Sep 2009</time>
          
          <span class="ttl">&middot; 



  
	  1 min read
	

</span>
        </div>
      </article>
    </a>
    
    <a class="link black-80 hover-silver" href="/2009/07/using-fields-for-can-generate-invalid-html/">
      <article class="f5 lh-copy fw3 pb4 bb b--light-gray">
        <div class="f6 fw6 lh-title ttu tracked mv4"><time>Jul 2009</time></div>
        <h3 class="f3 fw6 lh-title mb0">Using fields_for can generate invalid HTML</h3>
        <p class="f5 fw3 lh-copy mv2">Just a quick post so show you how <code class="highlighter-rouge">fields_for</code> form
helper can cause invalid HTML when used in combination with
<code class="highlighter-rouge">accepts_nested_attributes_for</code> in your views.

If you are for any reason editing/creating your child objects in a
tabular form, your view might look something like this:

<div class="language-rhtml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;%</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@todo_list</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">label</span>      <span class="ss">:name</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">text_field</span> <span class="ss">:name</span> <span class="cp">%&gt;</span>

  <span class="nt">&lt;h3&gt;</span>To Do Items:<span class="nt">&lt;/h3&gt;</span>
  <span class="nt">&lt;table&gt;</span>
    <span class="nt">&lt;thead&gt;</span>
      <span class="nt">&lt;tr&gt;</span>
        <span class="nt">&lt;th&gt;</span>To Do Item<span class="nt">&lt;/th&gt;</span>
        <span class="nt">&lt;th&gt;</span>Due Date<span class="nt">&lt;/th&gt;</span>
        <span class="nt">&lt;th&gt;</span>Done?<span class="nt">&lt;/th&gt;</span>
      <span class="nt">&lt;/tr&gt;</span>
    <span class="nt">&lt;/thead&gt;</span>
    <span class="nt">&lt;tbody&gt;</span>
      <span class="cp">&lt;%</span> <span class="n">f</span><span class="p">.</span><span class="nf">fields_for</span> <span class="ss">:items</span> <span class="k">do</span> <span class="o">|</span><span class="n">item</span><span class="o">|</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;tr&gt;</span>
          <span class="nt">&lt;td&gt;</span><span class="cp">&lt;%=</span> <span class="n">item</span><span class="p">.</span><span class="nf">text_field</span> <span class="ss">:content</span> <span class="cp">%&gt;</span><span class="nt">&lt;/td&gt;</span>
          <span class="nt">&lt;td&gt;</span><span class="cp">&lt;%=</span> <span class="n">item</span><span class="p">.</span><span class="nf">text_field</span> <span class="ss">:due_date</span> <span class="cp">%&gt;</span><span class="nt">&lt;/td&gt;</span>
          <span class="nt">&lt;td&gt;</span><span class="cp">&lt;%=</span> <span class="n">item</span><span class="p">.</span><span class="nf">check_box</span>  <span class="ss">:done</span> <span class="cp">%&gt;</span><span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;/tr&gt;</span>
      <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/tbody&gt;</span>
  <span class="nt">&lt;/table&gt;</span>
  
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">submit</span> <span class="s1">'Save'</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</code></pre></div></div>

At first glance this looks fine. However, when the <code class="highlighter-rouge">ToDoList</code>
model has <code class="highlighter-rouge">accepts_nested_attributes_for :items</code>, the
<code class="highlighter-rouge">fields_for</code> helper also outputs a hidden field for each
existing <code class="highlighter-rouge">Item</code> instance with it’s ID.

This means that we get the following HTML:

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">"/to_do_lists/1"</span> <span class="na">class=</span><span class="s">"edit_to_do_list"</span> <span class="na">id=</span><span class="s">"edit_to_do_list_1"</span> <span class="na">method=</span><span class="s">"post"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">style=</span><span class="s">"margin:0;padding:0;display:inline"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">"_method"</span> <span class="na">type=</span><span class="s">"hidden"</span> <span class="na">value=</span><span class="s">"put"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">"authenticity_token"</span> <span class="na">type=</span><span class="s">"hidden"</span> <span class="na">value=</span><span class="s">"CE2jyRoewbwsqu4eX8AFWFqsgrMfCN35Jzy6b43MhsA="</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"to_do_list_name"</span><span class="nt">&gt;</span>Name<span class="nt">&lt;/label&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">"to_do_list_name"</span> <span class="na">name=</span><span class="s">"to_do_list[name]"</span> <span class="na">size=</span><span class="s">"30"</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">value=</span><span class="s">"Sup"</span> <span class="nt">/&gt;</span>

  <span class="nt">&lt;h3&gt;</span>To Do Items:<span class="nt">&lt;/h3&gt;</span>
  <span class="nt">&lt;table&gt;</span>
    <span class="nt">&lt;thead&gt;</span>
      <span class="nt">&lt;tr&gt;</span>
        <span class="nt">&lt;th&gt;</span>To Do Item<span class="nt">&lt;/th&gt;</span>
        <span class="nt">&lt;th&gt;</span>Due Date<span class="nt">&lt;/th&gt;</span>
        <span class="nt">&lt;th&gt;</span>Done?<span class="nt">&lt;/th&gt;</span>
      <span class="nt">&lt;/tr&gt;</span>
    <span class="nt">&lt;/thead&gt;</span>
    <span class="nt">&lt;tbody&gt;</span>
      <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">"to_do_list_items_attributes_0_id"</span> <span class="na">name=</span><span class="s">"to_do_list[items_attributes][0][id]"</span> <span class="na">type=</span><span class="s">"hidden"</span> <span class="na">value=</span><span class="s">"1"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;tr&gt;</span>
          <span class="nt">&lt;td&gt;&lt;input</span> <span class="na">id=</span><span class="s">"to_do_list_items_attributes_0_content"</span> <span class="na">name=</span><span class="s">"to_do_list[items_attributes][0][content]"</span> <span class="na">size=</span><span class="s">"30"</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">value=</span><span class="s">"arst"</span> <span class="nt">/&gt;&lt;/td&gt;</span>
          <span class="nt">&lt;td&gt;&lt;input</span> <span class="na">id=</span><span class="s">"to_do_list_items_attributes_0_due_date"</span> <span class="na">name=</span><span class="s">"to_do_list[items_attributes][0][due_date]"</span> <span class="na">size=</span><span class="s">"30"</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">value=</span><span class="s">"2009-07-30"</span> <span class="nt">/&gt;&lt;/td&gt;</span>
          <span class="nt">&lt;td&gt;&lt;input</span> <span class="na">name=</span><span class="s">"to_do_list[items_attributes][0][done]"</span> <span class="na">type=</span><span class="s">"hidden"</span> <span class="na">value=</span><span class="s">"0"</span> <span class="nt">/&gt;&lt;input</span> <span class="na">id=</span><span class="s">"to_do_list_items_attributes_0_done"</span> <span class="na">name=</span><span class="s">"to_do_list[items_attributes][0][done]"</span> <span class="na">type=</span><span class="s">"checkbox"</span> <span class="na">value=</span><span class="s">"1"</span> <span class="nt">/&gt;&lt;/td&gt;</span>
        <span class="nt">&lt;/tr&gt;</span>
      <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">"to_do_list_items_attributes_1_id"</span> <span class="na">name=</span><span class="s">"to_do_list[items_attributes][1][id]"</span> <span class="na">type=</span><span class="s">"hidden"</span> <span class="na">value=</span><span class="s">"2"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;tr&gt;</span>
          <span class="nt">&lt;td&gt;&lt;input</span> <span class="na">id=</span><span class="s">"to_do_list_items_attributes_1_content"</span> <span class="na">name=</span><span class="s">"to_do_list[items_attributes][1][content]"</span> <span class="na">size=</span><span class="s">"30"</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">value=</span><span class="s">"arst"</span> <span class="nt">/&gt;&lt;/td&gt;</span>
          <span class="nt">&lt;td&gt;&lt;input</span> <span class="na">id=</span><span class="s">"to_do_list_items_attributes_1_due_date"</span> <span class="na">name=</span><span class="s">"to_do_list[items_attributes][1][due_date]"</span> <span class="na">size=</span><span class="s">"30"</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">value=</span><span class="s">"2009-07-30"</span> <span class="nt">/&gt;&lt;/td&gt;</span>
          <span class="nt">&lt;td&gt;&lt;input</span> <span class="na">name=</span><span class="s">"to_do_list[items_attributes][1][done]"</span> <span class="na">type=</span><span class="s">"hidden"</span> <span class="na">value=</span><span class="s">"0"</span> <span class="nt">/&gt;&lt;input</span> <span class="na">id=</span><span class="s">"to_do_list_items_attributes_1_done"</span> <span class="na">name=</span><span class="s">"to_do_list[items_attributes][1][done]"</span> <span class="na">type=</span><span class="s">"checkbox"</span> <span class="na">value=</span><span class="s">"1"</span> <span class="nt">/&gt;&lt;/td&gt;</span>
        <span class="nt">&lt;/tr&gt;</span>
    <span class="nt">&lt;/tbody&gt;</span>
  <span class="nt">&lt;/table&gt;</span>
  
  <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">"to_do_list_submit"</span> <span class="na">name=</span><span class="s">"commit"</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">value=</span><span class="s">"Save"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/form&gt;</span>
</code></pre></div></div>

The keen eye will notice the hidden <code class="highlighter-rouge">&lt;input&gt;</code> tags that are direct
children of the <code class="highlighter-rouge">tbody</code>:

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;tbody&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">"to_do_list_items_attributes_0_id"</span> <span class="na">name=</span><span class="s">"to_do_list[items_attributes][0][id]"</span> <span class="na">type=</span><span class="s">"hidden"</span> <span class="na">value=</span><span class="s">"1"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;tr&gt;</span><span class="c">&lt;!-- clip! --&gt;</span><span class="nt">&lt;/tr&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">"to_do_list_items_attributes_1_id"</span> <span class="na">name=</span><span class="s">"to_do_list[items_attributes][1][id]"</span> <span class="na">type=</span><span class="s">"hidden"</span> <span class="na">value=</span><span class="s">"2"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;tr&gt;</span><span class="c">&lt;!-- clip! --&gt;</span><span class="nt">&lt;/tr&gt;</span>
<span class="nt">&lt;/tbody&gt;</span>
</code></pre></div></div>

This is not a valid place for an <code class="highlighter-rouge">&lt;input&gt;</code> tag.

I’ve put an example project demonstrating this on <a href="http://github.com/bjeanes/fields_for_invalid_html">my
GitHub</a>
</p>
  
        <div class="f6 fw3 silver mt0">
          
          <time>30 Jul 2009</time>
          
          <span class="ttl">&middot; 



  
	  1 min read
	

</span>
        </div>
      </article>
    </a>
    
    <a class="link black-80 hover-silver" href="/2009/07/ultraviolet-tools/">
      <article class="f5 lh-copy fw3 pb4 bb b--light-gray">
        <div class="f6 fw6 lh-title ttu tracked mv4"><time>Jul 2009</time></div>
        <h3 class="f3 fw6 lh-title mb0">Ultraviolet Tools</h3>
        <p class="f5 fw3 lh-copy mv2">A few weeks ago, I was modifying my clone of Enki (my blogging platform)
to use <a href="http://ultraviolet.rubyforge.org/">Ultraviolet</a> instead of
<a href="http://coderay.rubychan.de/">CodeRay</a>, as it supports using both
<a href="http://macromates.com">TextMate</a> themes and syntaxes. This means I can
extend it fairly limitlessly and use TextMate itself to modify the
themes an syntaxes.

However, Ultraviolet doesn’t come with the best tools to turn the
TextMate syntax and theme files into files Ultraviolet can use, and the
ones that it does provide puts those translated files INTO the gem on
your system. This means that you can’t easily deploy or share them.

So, to remedy this I made a small gem <a href="http://github.com/bjeanes/ultraviolet-tools">Ultraviolet
Tools</a> that provides two
command line tools: <code class="highlighter-rouge">uv-create-syntax</code> and <code class="highlighter-rouge">uv-create-theme</code>.

They aren’t very complicated, nor very documented, but they are
straight-forward to use:

<h3 id="install">Install</h3>

Install Ultraviolet Tools with
<code class="highlighter-rouge">sudo gem install bjeanes-ultraviolet-tools -s http://gems.github.com</code>.

<h3 id="usage">Usage</h3>

<h4 id="themes">Themes</h4>

Run <code class="highlighter-rouge">uv-create-theme path/to/theme.tmTheme</code>

<h4 id="syntaxes">Syntaxes</h4>

Run <code class="highlighter-rouge">uv-create_syntax path/to/syntax.plist</code> or
<code class="highlighter-rouge">uv-create_syntax path/to/bundle/with/syntaxes.tmBundle</code>

<h3 id="using-the-resulting-files">Using the resulting files</h3>

Use <a href="http://github.com/bjeanes/ultraviolet">my fork of ultraviolet</a> as
it has an option to change the load path for themes and syntaxes so that
you can load them out of your application files.
</p>
  
        <div class="f6 fw3 silver mt0">
          
          <time>30 Jul 2009</time>
          
          <span class="ttl">&middot; 



  
	  1 min read
	

</span>
        </div>
      </article>
    </a>
    
    <a class="link black-80 hover-silver" href="/2009/07/creating-new-postgres-user-and-db/">
      <article class="f5 lh-copy fw3 pb4 bb b--light-gray">
        <div class="f6 fw6 lh-title ttu tracked mv4"><time>Jul 2009</time></div>
        <h3 class="f3 fw6 lh-title mb0">Creating new Postgres User and DB</h3>
        <p class="f5 fw3 lh-copy mv2">This post is mostly a reminder for me in the future. However, others may
find it useful also.

I love Postgres but more often than not I get frustrated and confused
trying to get authentication working with a new database. By looking
through the Deprec source code, I pulled out these two lines of code and
so far they haven’t failed me:

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>su - postgres <span class="nt">-c</span> <span class="s2">"createuser -P -D -A -E </span><span class="nv">$DBUSER</span><span class="s2">"</span>
su - postgres <span class="nt">-c</span> <span class="s2">"createdb -O </span><span class="nv">$DBUSER</span><span class="s2"> </span><span class="nv">$DBNAME</span><span class="s2">"</span>
</code></pre></div></div>

Of course, replace <code class="highlighter-rouge">$DBUSER</code> and
<code class="highlighter-rouge">$DBNAME</code> with your desired username and database
name, or define them as shell variables. The
<code class="highlighter-rouge">$DBUSER</code> creates that user as the owner of the
database (so it has permission to read/write etc).
</p>
  
        <div class="f6 fw3 silver mt0">
          
          <time>21 Jul 2009</time>
          
          <span class="ttl">&middot; 



  
	  Less than 1 min read
	

</span>
        </div>
      </article>
    </a>
    
    <a class="link black-80 hover-silver" href="/2009/07/fix-for-dynamic-pager-cannot-open-swap-directory-private-var-vm-in-os-x-possibly-just-snow-leopard/">
      <article class="f5 lh-copy fw3 pb4 bb b--light-gray">
        <div class="f6 fw6 lh-title ttu tracked mv4"><time>Jul 2009</time></div>
        <h3 class="f3 fw6 lh-title mb0">Fix for &quot;dynamic_pager: cannot open swap directory /private/var/vm&quot; in OS X (possibly just Snow Leopard)</h3>
        <p class="f5 fw3 lh-copy mv2">Today my Snow Leopard install was going so slow it felt like I was
trying to swim through molasses. The system was literally so slow that
typing text into some text fields (especially TextMate) lagged at about
a rate of 1 character per second, and opening files (or even running
<code class="highlighter-rouge">touch</code> on them) took a couple of seconds.

After a few fruitless restarts and a keen eye on my logs I started
noticing these errors in Console.app:

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>9/07/09 3:01:37 PM com.apple.launchd[1] (com.apple.dynamic*pager) Exited
with exit code: 1\
9/07/09 3:01:37 PM com.apple.launchd Throttling respawn: Will start in
10 seconds\
9/07/09 3:01:47 PM com.apple.dynamic*pager[2481] dynamic*pager: cannot
open swap directory /private/var/vm\
9/07/09 3:01:47 PM com.apple.launchd Exited with exit code: 1\
9/07/09 3:01:47 PM com.apple.launchd Throttling respawn: Will start in
10 seconds\
9/07/09 3:01:57 PM com.apple.dynamic*pager[2546] dynamic*pager: cannot
open swap directory /private/var/vm\
9/07/09 3:01:57 PM com.apple.launchd Exited with exit code: 1\
9/07/09 3:01:57 PM com.apple.launchd Throttling respawn: Will start in
10 seconds\
9/07/09 3:02:07 PM com.apple.dynamic*pager[2547] dynamic\_pager: cannot
open swap directory /private/var/vm\
9/07/09 3:02:07 PM com.apple.launchd[1] (com.apple.dynamic\_pager[2547])
Exited with exit code: 1\
9/07/09 3:02:07 PM com.apple.launchd[1] (com.apple.dynamic\_pager)
Throttling respawn: Will start in 10 seconds\
</code></pre></div></div>

I don’t know how or why they started but I was able to fix it by simply
running <code class="highlighter-rouge">sudo mkdir /private/var/vm</code> in Terminal. Within a few seconds
of creating the directory, the errors ceased and I could see a swapfile
created inside the directory.

I have no idea what caused the directory to be deleted in the first
place or why OS X isn’t smart enough to try creating it, but the fix is
simple and instantly effective.

Note: I am not sure if this is a Snow Leopard specific issue or not, but
it very well might be. Also, these started right after installing Adobe
CS4, so I feel pretty confident blaming that for now.
</p>
  
        <div class="f6 fw3 silver mt0">
          
          <time>9 Jul 2009</time>
          
          <span class="ttl">&middot; 



  
	  1 min read
	

</span>
        </div>
      </article>
    </a>
    
    <a class="link black-80 hover-silver" href="/2009/07/using-accepts-nested-attributes-for-when-the-child-object-validates-presence-of-parent/">
      <article class="f5 lh-copy fw3 pb4 bb b--light-gray">
        <div class="f6 fw6 lh-title ttu tracked mv4"><time>Jul 2009</time></div>
        <h3 class="f3 fw6 lh-title mb0">Using accepts_nested_attributes_for When the Child Object validates_presence_of Parent</h3>
        <p class="f5 fw3 lh-copy mv2">I came across an interesting dilemma today in Rails 2.3 whilst trying to
use <code class="highlighter-rouge">accepts_nested_attributes_for</code>.

The models I have were:

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Organization</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">has_many</span> <span class="ss">:users</span>
  <span class="n">accepts_nested_attributes_for</span> <span class="ss">:users</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">belongs_to</span> <span class="ss">:organization</span>
  <span class="n">validates_presence_of</span> <span class="ss">:organization</span>
<span class="k">end</span>
</code></pre></div></div>

I had an “Organization” creation form which allowed an administrator to
create an Organization and an initial user for it. However, even though
I had filled in all the required fields to pass the validations I was
constantly getting the following error: <code class="highlighter-rouge">Organization can not be blank</code>.

Digging deeper I found that when an object is added to an association
via the <code class="highlighter-rouge">association.build</code> method, the parent object
isn’t actually set:

<div class="language-irb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">&gt;&gt; o = Organization.new(:name =&gt; "Test")
</span><span class="p">=&gt;</span> <span class="kt">#&lt;</span><span class="no">Organization</span> <span class="ss">id: </span><span class="kp">nil</span><span class="p">,</span> <span class="ss">name: </span><span class="s2">"Test"</span><span class="kt">&gt;</span>
<span class="o">&gt;&gt;</span> <span class="n">u</span> <span class="o">=</span> <span class="n">o</span><span class="p">.</span><span class="nf">users</span><span class="p">.</span><span class="nf">build</span><span class="p">(</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">"Test User"</span><span class="p">)</span>  
<span class="o">=&gt;</span> <span class="kt">#&lt;</span><span class="no">User</span> <span class="ss">id: </span><span class="kp">nil</span><span class="p">,</span> <span class="ss">organization_id: </span><span class="kp">nil</span><span class="p">,</span> <span class="ss">name: </span><span class="s2">"Test User"</span><span class="kt">&gt;</span>
<span class="o">&gt;&gt;</span> <span class="n">u</span><span class="p">.</span><span class="nf">organization</span>
<span class="o">=&gt;</span> <span class="kp">nil</span>
</code></pre></div></div>

Apparently this flaw also applies to
<code class="highlighter-rouge">accepts_nested_attributes_for</code>. When I send through the
User <code class="highlighter-rouge">params</code> through from my form normally with the
<code class="highlighter-rouge">Organization</code> params, it creates the
<code class="highlighter-rouge">User</code> object in the <code class="highlighter-rouge">users</code> association
as you’d expect, but raises a validation error because the
<code class="highlighter-rouge">User</code> instance doesn’t recognise that it is has a parent
<code class="highlighter-rouge">Organization</code>

My quick 5 minute fix was to modify the <code class="highlighter-rouge">Organization</code>
model thusly:

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Organization</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">has_many</span> <span class="ss">:users</span>
  <span class="n">accepts_nested_attributes_for</span> <span class="ss">:users</span>

  <span class="k">def</span> <span class="nf">users_attributes_with_self_assignment</span><span class="o">=</span><span class="p">(</span><span class="n">attributes</span><span class="p">)</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">users_attributes_without_self_assignment</span> <span class="o">=</span> <span class="n">attributes</span>
    <span class="n">users</span><span class="p">.</span><span class="nf">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">u</span><span class="o">|</span> <span class="n">u</span><span class="p">.</span><span class="nf">organization</span> <span class="o">=</span> <span class="nb">self</span> <span class="p">}</span>
  <span class="k">end</span>
  <span class="n">alias_method_chain</span> <span class="ss">:users_attributes</span><span class="o">=</span><span class="p">,</span> <span class="ss">:self_assignment</span>
<span class="k">end</span>
</code></pre></div></div>

Related Rails bugs seem to be
<a href="https://rails.lighthouseapp.com/projects/8994-ruby-on-rails/tickets/1943">here</a>
and
<a href="https://rails.lighthouseapp.com/projects/8994-ruby-on-rails/tickets/2815">here</a>.
<a href="https://rails.lighthouseapp.com/projects/8994/tickets/1619-patch-support-for-inverse-option-in-associations">This
patch</a>
will also solve the problem and is currently <a href="http://github.com/rails/rails/commit/ccea98389abbf150b886c9f964b1def47f00f237">in
edge</a>,
but didn’t make it in time for Rails 2.3.
</p>
  
        <div class="f6 fw3 silver mt0">
          
          <time>6 Jul 2009</time>
          
          <span class="ttl">&middot; 



  
	  1 min read
	

</span>
        </div>
      </article>
    </a>
    
    <a class="link black-80 hover-silver" href="/2009/07/fish-shell-version-of-git-ps1-function-that-is-bundled-with-git/">
      <article class="f5 lh-copy fw3 pb4 bb b--light-gray">
        <div class="f6 fw6 lh-title ttu tracked mv4"><time>Jul 2009</time></div>
        <h3 class="f3 fw6 lh-title mb0">Fish Shell version of __git_ps1 Function That is Bundled with Git</h3>
        <p class="f5 fw3 lh-copy mv2">Today at ActionHack, I was showing off Fish Shell to
“`geoffreyd”:http://twitter.com/geoffreyd. I was showing off all the cool fish prompt features I had, but pointed out that my git branch portion needed some beefing up, as it didn’t show the current mode nor commit shas when not in a branch.

Knowing that git came with a `_<em>git</em>ps1 ()@ function for Bash
that achieves this, I decided to port it to Fish tonight. My shell
scripting fu is pretty weak but as far as I can tell it works great and
I am now using it in my shell.

Here is the Fish function (I’ve kept the function name the same as the
bash one):

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function </span>__git_ps1
  <span class="nb">set</span> <span class="nt">-l</span> g <span class="o">(</span>git rev-parse <span class="nt">--git-dir</span> ^/dev/null<span class="o">)</span>
  <span class="k">if</span> <span class="o">[</span> <span class="nt">-n</span> <span class="s2">"</span><span class="nv">$g</span><span class="s2">"</span> <span class="o">]</span>
    <span class="nb">set</span> <span class="nt">-l</span> r <span class="s2">""</span>
    <span class="nb">set</span> <span class="nt">-l</span> b <span class="s2">""</span>

    <span class="k">if</span> <span class="o">[</span> <span class="nt">-d</span> <span class="s2">"</span><span class="nv">$g</span><span class="s2">/../.dotest"</span> <span class="o">]</span>
      <span class="k">if</span> <span class="o">[</span> <span class="nt">-f</span> <span class="s2">"</span><span class="nv">$g</span><span class="s2">/../.dotest/rebasing"</span> <span class="o">]</span>
        <span class="nb">set </span>r <span class="s2">"|REBASE"</span>
      elseif <span class="o">[</span> <span class="nt">-f</span> <span class="s2">"</span><span class="nv">$g</span><span class="s2">/../.dotest/applying"</span> <span class="o">]</span>
        <span class="nb">set </span>r <span class="s2">"|AM"</span>
      <span class="k">else
        </span><span class="nb">set </span>r <span class="s2">"|AM/REBASE"</span>
      end

      <span class="nb">set </span>b <span class="o">(</span>git symbolic-ref HEAD ^/dev/null<span class="o">)</span>
    elseif <span class="o">[</span> <span class="nt">-f</span> <span class="s2">"</span><span class="nv">$g</span><span class="s2">/.dotest-merge/interactive"</span> <span class="o">]</span>
      <span class="nb">set </span>r <span class="s2">"|REBASE-i"</span>
      <span class="nb">set </span>b <span class="o">(</span><span class="nb">cat</span> <span class="s2">"</span><span class="nv">$g</span><span class="s2">/.dotest-merge/head-name"</span><span class="o">)</span>
    elseif <span class="o">[</span> <span class="nt">-d</span> <span class="s2">"</span><span class="nv">$g</span><span class="s2">/.dotest-merge"</span> <span class="o">]</span>
      <span class="nb">set </span>r <span class="s2">"|REBASE-m"</span>
      <span class="nb">set </span>b <span class="o">(</span><span class="nb">cat</span> <span class="s2">"</span><span class="nv">$g</span><span class="s2">/.dotest-merge/head-name"</span><span class="o">)</span>
    elseif <span class="o">[</span> <span class="nt">-f</span> <span class="s2">"</span><span class="nv">$g</span><span class="s2">/MERGE_HEAD"</span> <span class="o">]</span>
      <span class="nb">set </span>r <span class="s2">"|MERGING"</span>
      <span class="nb">set </span>b <span class="o">(</span>git symbolic-ref HEAD ^/dev/null<span class="o">)</span>
    <span class="k">else
      if</span> <span class="o">[</span> <span class="nt">-f</span> <span class="s2">"</span><span class="nv">$g</span><span class="s2">/BISECT_LOG"</span> <span class="o">]</span>
        <span class="nb">set </span>r <span class="s2">"|BISECTING"</span>
      end

      <span class="nb">set </span>b <span class="o">(</span>git symbolic-ref HEAD ^/dev/null<span class="o">)</span>
      <span class="k">if</span> <span class="o">[</span> <span class="nt">-z</span> <span class="nv">$b</span> <span class="o">]</span>
        <span class="nb">set </span>b <span class="o">(</span>git describe <span class="nt">--exact-match</span> HEAD ^/dev/null<span class="o">)</span>
        <span class="k">if</span> <span class="o">[</span> <span class="nt">-z</span> <span class="nv">$b</span> <span class="o">]</span>
          <span class="nb">set </span>b <span class="o">(</span>cut <span class="nt">-c1-7</span> <span class="s2">"</span><span class="nv">$g</span><span class="s2">/HEAD"</span><span class="o">)</span>
          <span class="nb">set </span>b <span class="s2">"</span><span class="nv">$b</span><span class="s2">..."</span>
        end
      end
    end

    <span class="k">if </span>not <span class="nb">test</span> <span class="nv">$argv</span>
  		<span class="nb">set </span>argv <span class="s2">" (%s)"</span>
  	end

  	<span class="nb">set </span>b <span class="o">(</span><span class="nb">echo</span> <span class="nv">$b</span> | sed <span class="nt">-e</span> <span class="s1">'s|^refs/heads/||'</span><span class="o">)</span>

    <span class="nb">printf</span> <span class="nv">$argv</span> <span class="s2">"</span><span class="nv">$b$r</span><span class="s2">"</span> ^/dev/null
  end
end
</code></pre></div></div>
I have also pushed it to my <code class="highlighter-rouge">dot-files</code> repository
<a href="http://github.com/bjeanes/dot-files/blob/master/fish/functions/__git_ps1.fish">here</a>.

Enjoy :)
</p>
  
        <div class="f6 fw3 silver mt0">
          
          <time>4 Jul 2009</time>
          
          <span class="ttl">&middot; 



  
	  1 min read
	

</span>
        </div>
      </article>
    </a>
    
    <a class="link black-80 hover-silver" href="/2009/07/using-fields-for-with-nested-attributes-calling-it-multiple-times/">
      <article class="f5 lh-copy fw3 pb4 bb b--light-gray">
        <div class="f6 fw6 lh-title ttu tracked mv4"><time>Jul 2009</time></div>
        <h3 class="f3 fw6 lh-title mb0">Using fields_for with Nested Attributes, Calling it Multiple Times</h3>
        <p class="f5 fw3 lh-copy mv2">There has been quite an annoying problem that has been bugging
<a href="http://twitter.com/chendo">@chendo</a> and I today.

In short, <a href="http://api.rubyonrails.org/classes/ActionView/Helpers/FormHelper.html#M001895"><code class="highlighter-rouge">fields_for</code></a> when used with <code class="highlighter-rouge">accepts_nested_attributes_for</code>does not reset it’s index when it’s called multiple times for the same attribute.

Our scenario was the following:

We had a 3 levels of hierarchical data that we had to display in a
<code class="highlighter-rouge">&lt;table&gt;</code>. Because of the nature of the data we were
displaying one level as columns and the other level as rows.
Unfortunately, HTML mandates that we group everything by rows — each
column is really just a single cell. This means that we have to iterate
over the “column” values not just once, but once for every row.

Now, <code class="highlighter-rouge">fields_for</code> takes care of naming your
<code class="highlighter-rouge">&lt;input&gt;</code> tags magically with the correct indexes so that
your models can accept the params directly and magic happens. However,
evidently calling <code class="highlighter-rouge">fields_for</code> multiple times was not
part of the original intention, and it seems resetting the index after
each call was neglected.

`chendo couldn’t see a cleaner way of doing this so we added our own option to reset the index. We didn’t just override the behaviour in case there is a good reason to leave it, but here is our code:

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ActionView</span><span class="o">::</span><span class="no">Helpers</span><span class="o">::</span><span class="no">FormBuilder</span>
  <span class="k">def</span> <span class="nf">fields_for_with_nested_attributes_with_index_reset</span><span class="p">(</span><span class="n">association_name</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">block</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="nf">last</span><span class="p">.</span><span class="nf">is_a?</span><span class="p">(</span><span class="no">Hash</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">args</span><span class="p">.</span><span class="nf">last</span><span class="p">[</span><span class="ss">:reset_index</span><span class="p">]</span>
      <span class="vi">@nested_child_index</span> <span class="o">=</span> <span class="kp">nil</span>
    <span class="k">end</span>

    <span class="n">fields_for_without_nested_attributes_without_index_reset</span><span class="p">(</span><span class="n">association_name</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">block</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">alias_method_change</span> <span class="ss">:fields_for_with_nested_attributes</span><span class="p">,</span> <span class="ss">:index_reset</span>
<span class="k">end</span>
</code></pre></div></div>
</p>
  
        <div class="f6 fw3 silver mt0">
          
          <time>3 Jul 2009</time>
          
          <span class="ttl">&middot; 



  
	  1 min read
	

</span>
        </div>
      </article>
    </a>
    
    <a class="link black-80 hover-silver" href="/2009/07/using-alterego-with-activerecord/">
      <article class="f5 lh-copy fw3 pb4 bb b--light-gray">
        <div class="f6 fw6 lh-title ttu tracked mv4"><time>Jul 2009</time></div>
        <h3 class="f3 fw6 lh-title mb0">Using AlterEgo with ActiveRecord</h3>
        <p class="f5 fw3 lh-copy mv2">Today after finding the gem AlterEgo and falling in love with the API,
<a href="http://twitter.com/chendo">@chendo</a> and I came to a sad realisation that its beauty was skin-deep. It seems it is not ActiveRecord-aware and overrides <code class="highlighter-rouge">#state</code> and <code class="highlighter-rouge">#state=</code> on your models. This means that your <code class="highlighter-rouge">state</code> column goes
untouched and your models are always in the default state.

To get around this, @chendo and I hacked together this little monkey patch which does two things:

<ol>
  <li>It adds question methods for each of your defined states. So if you have states: <code class="highlighter-rouge">active</code>, <code class="highlighter-rouge">inactive</code>, and <code class="highlighter-rouge">banned</code>
on your <code class="highlighter-rouge">User</code> model, your instances will have <code class="highlighter-rouge">#active?</code>, <code class="highlighter-rouge">#inactive?</code>, and <code class="highlighter-rouge">#banned?</code></li>
  <li>It properly sets and gets the state of the row and loads it into AlterEgo.</li>
</ol>

Here is the code:

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="nn">AlterEgo</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">included</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
    <span class="n">base</span><span class="p">.</span><span class="nf">instance_eval</span> <span class="k">do</span>
      
      <span class="c1"># This will allow us to define a question method for each state in a class</span>
      <span class="c1"># For instance if user has states :active and :inactive, methods active? and inactive?</span>
      <span class="c1"># will be defined when first called</span>
      <span class="k">def</span> <span class="nf">method_missing_with_states</span><span class="p">(</span><span class="nb">method</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
        <span class="k">begin</span>
          <span class="n">method_missing_without_states</span><span class="p">(</span><span class="nb">method</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
        <span class="k">rescue</span> <span class="no">NoMethodError</span> <span class="o">=&gt;</span> <span class="n">e</span>
          <span class="n">state_found</span> <span class="o">=</span> <span class="kp">false</span>
          <span class="n">result</span> <span class="o">=</span> <span class="kp">nil</span>
          
          <span class="n">base</span><span class="p">.</span><span class="nf">states</span><span class="p">.</span><span class="nf">keys</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">state</span><span class="o">|</span>
            <span class="k">if</span> <span class="nb">method</span><span class="p">.</span><span class="nf">to_s</span> <span class="o">==</span> <span class="s2">"</span><span class="si">#{</span><span class="n">state</span><span class="si">}</span><span class="s2">?"</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">state_found</span>
              <span class="nb">self</span><span class="p">.</span><span class="nf">class</span><span class="p">.</span><span class="nf">send</span> <span class="ss">:define_method</span><span class="p">,</span> <span class="s2">"</span><span class="si">#{</span><span class="n">state</span><span class="si">}</span><span class="s2">?"</span> <span class="k">do</span>
                <span class="nb">self</span><span class="p">.</span><span class="nf">state</span> <span class="o">==</span> <span class="n">state</span>
              <span class="k">end</span>
              <span class="n">state_found</span> <span class="o">=</span> <span class="kp">true</span>
              <span class="n">result</span> <span class="o">=</span> <span class="nb">self</span><span class="p">.</span><span class="nf">__send__</span><span class="p">(</span><span class="nb">method</span><span class="p">)</span>
            <span class="k">end</span>
          <span class="k">end</span>
          <span class="k">raise</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">unless</span> <span class="n">state_found</span>
          <span class="n">result</span>
        <span class="k">end</span>
      <span class="k">end</span>
      <span class="n">alias_method_chain</span> <span class="ss">:method_missing</span><span class="p">,</span> <span class="ss">:states</span>
      
      <span class="c1"># state setter to write to database</span>
      <span class="n">define_method</span> <span class="ss">:state</span><span class="o">=</span> <span class="k">do</span> <span class="o">|</span><span class="n">value</span><span class="o">|</span>
        <span class="n">write_attribute</span><span class="p">(</span><span class="ss">:state</span><span class="p">,</span> <span class="n">value</span><span class="p">.</span><span class="nf">to_s</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="c1"># state getter to read from database</span>
      <span class="n">define_method</span> <span class="ss">:state_with_active_record</span> <span class="k">do</span>
        <span class="p">(</span><span class="n">read_attribute</span><span class="p">(</span><span class="ss">:state</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nb">self</span><span class="p">.</span><span class="nf">state</span> <span class="o">=</span> <span class="n">state_without_active_record</span><span class="p">)).</span><span class="nf">to_sym</span>
      <span class="k">end</span>
      <span class="n">alias_method_chain</span> <span class="ss">:state</span><span class="p">,</span> <span class="ss">:active_record</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>
</p>
  
        <div class="f6 fw3 silver mt0">
          
          <time>3 Jul 2009</time>
          
          <span class="ttl">&middot; 



  
	  1 min read
	

</span>
        </div>
      </article>
    </a>
    
    <a class="link black-80 hover-silver" href="/2009/07/how-to-prepare-your-mac-for-resale/">
      <article class="f5 lh-copy fw3 pb4 bb b--light-gray">
        <div class="f6 fw6 lh-title ttu tracked mv4"><time>Jul 2009</time></div>
        <h3 class="f3 fw6 lh-title mb0">How to Prepare Your Mac for Resale</h3>
        <p class="f5 fw3 lh-copy mv2">First thing is first: you want to re-install Mac OS X (this guide
requires Leopard). Insert your OS X disk and boot off it. Make sure you
do a “Clean Install” so as not to leave any of your files on the system.

When the install is finished, your computer will restart and you’ll see
the traditional OS X welcome screen and the setup assistant. Go through
all the settings, choosing anything just to get the system booted up.
However, make sure you take note of the user account login you use. For
this guide, I will assume login of <code class="highlighter-rouge">temp</code>, and if you don’t have a good
reason not to, you should do the same.

At this point you want to download any Apple updates and install them,
as well as install any bundled software you plan to advertise the
machine coming with. When all your installs are finished and the machine
is as you want it for the customer/recipient, shut down the machine.

Next, turn the machine back on but as soon as you hear the Mac chime
noise, press and hold ⌘S until you are taken to a console (white text on
black screen — looks real nerdy and sci-fi).

The next step is to run all the commands in the code block below

NOTE: If you didn’t use <code class="highlighter-rouge">temp</code> as your username you created in the setup
assistant, make sure you replace <strong>all</strong> instances of <code class="highlighter-rouge">temp</code> with your
actual username.

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Mount the file system so we can modify it</span>
/sbin/fsck <span class="nt">-fy</span>
/sbin/mount <span class="nt">-uw</span> /

<span class="c"># Activate directory services</span>
/bin/launchctl load /System/Library/LaunchDaemons/com.apple.DirectoryServices.plist &amp;

<span class="c"># Delete all traces of the temporary account</span>
/usr/bin/dscl <span class="nb">.</span> <span class="nt">-delete</span> /Users/temp
/usr/bin/dscl <span class="nb">.</span> <span class="nt">-delete</span> /Groups/admin GroupMembership temp
/bin/rm <span class="nt">-rf</span> /Users/temp

<span class="c"># Get rid of a few other files</span>
/bin/rm <span class="nt">-R</span> /Library/Preferences
/bin/rm <span class="nt">-f</span> /root/.bash_history

<span class="c"># Now we make it appear as though the initial setup assistant</span>
<span class="c"># still needs to run</span>
/bin/rm /var/db/.AppleSetupDone

<span class="c"># Reboot and check that it seems like</span>
<span class="c"># it is a new mac, then turn off your computer</span>
<span class="c"># and sell it!</span>
/sbin/reboot
</code></pre></div></div>
</p>
  
        <div class="f6 fw3 silver mt0">
          
          <time>1 Jul 2009</time>
          
          <span class="ttl">&middot; 



  
	  1 min read
	

</span>
        </div>
      </article>
    </a>
    
    <a class="link black-80 hover-silver" href="/2009/06/unescaping-utf-8-strings-in-ruby-1-9/">
      <article class="f5 lh-copy fw3 pb4 bb b--light-gray">
        <div class="f6 fw6 lh-title ttu tracked mv4"><time>Jun 2009</time></div>
        <h3 class="f3 fw6 lh-title mb0">Unescaping UTF-8 Strings in Ruby 1.9</h3>
        <p class="f5 fw3 lh-copy mv2">Today <a href="http://frozenplague.net">Radar</a> and I encountered a little issue
with <code class="highlighter-rouge">String</code> encodings in Ruby 1.9. In this project, some Merb UTF-8
params needed to be unescaped. We spent some trying to force strings
into UTF-8 encoding but for some reason while the encoding was UTF–8,
the actual contents of the strings were getting massacred.

Long story short:

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># In Ruby 1.9</span>

<span class="c1"># Broken</span>
<span class="nb">puts</span> <span class="no">URI</span><span class="o">::</span><span class="n">unescape</span><span class="p">(</span><span class="s2">"Baden-W%C3%BCrttemberg"</span><span class="p">)</span> <span class="c1"># =&gt; "Baden-WÃ¼rttemberg"</span>

<span class="c1"># Working</span>
<span class="nb">puts</span> <span class="no">CGI</span><span class="o">::</span><span class="n">unescape</span><span class="p">(</span><span class="s2">"Baden-W%C3%BCrttemberg"</span><span class="p">)</span> <span class="c1"># =&gt; "Baden-Württemberg"</span>
</code></pre></div></div>

Another lesson we learnt on our adventures today is the following:

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">m1</span> <span class="o">=</span> <span class="s2">"Munich"</span>
<span class="nb">puts</span> <span class="o">=</span> <span class="n">m1</span><span class="p">.</span><span class="nf">encoding</span>  <span class="c1"># let's suppose it is something other than UTF-8, such as ASCII-8Bit</span>

<span class="n">m2</span> <span class="o">=</span> <span class="s2">"München"</span>
<span class="nb">puts</span> <span class="o">=</span> <span class="n">m2</span><span class="p">.</span><span class="nf">encoding</span>  <span class="c1"># let's suppose we have a UTF-8 encoded string</span>


<span class="c1"># The following will raise an exception about mismatched encodings</span>
<span class="n">m3</span> <span class="o">=</span> <span class="n">m1</span> <span class="o">&lt;&lt;</span> <span class="n">m2</span>

<span class="c1"># The easiest way to get around this is to do the concatenation like so:</span>
<span class="n">m3</span> <span class="o">=</span> <span class="n">m3</span> <span class="o">=</span> <span class="n">m1</span> <span class="o">&lt;&lt;</span> <span class="n">m2</span><span class="p">.</span><span class="nf">force_encoding</span><span class="p">(</span><span class="s2">"UTF-8"</span><span class="p">)</span>
</code></pre></div></div>
</p>
  
        <div class="f6 fw3 silver mt0">
          
          <time>30 Jun 2009</time>
          
          <span class="ttl">&middot; 



  
	  Less than 1 min read
	

</span>
        </div>
      </article>
    </a>
    
    <a class="link black-80 hover-silver" href="/2009/06/rubycocoa-and-keychain-access/">
      <article class="f5 lh-copy fw3 pb4 bb b--light-gray">
        <div class="f6 fw6 lh-title ttu tracked mv4"><time>Jun 2009</time></div>
        <h3 class="f3 fw6 lh-title mb0">RubyCocoa and Keychain access</h3>
        <p class="f5 fw3 lh-copy mv2">There have been a few posts asking how to access and manipulate the
Keychain from within RubyCocoa but no answers supplied. As someone who
is just getting into RubyCocoa (and Cocoa all together for that matter),
I thought I’d document once and for all the process I took to get it
working.

I am running on Leopard and while 10.5 is supposed to ship with
BridgeSupport for most frameworks, the Security framework must have been
left out. After playing around with using other frameworks (such as the
AddressBook framework) and seeing how they were used, I did a bit of
digging in the Apple Developer Documentation (incredible resource for
anyone starting out) and stumbled across this gem: <a href="http://developer.apple.com/documentation/Cocoa/Conceptual/RubyPythonCocoa/Articles/GenerateFrameworkMetadata.html#//apple_ref/doc/uid/TP40005426">Generate Framework
Metadata</a>

After reading this, I was accessing the keychain within 5 minutes.
Here’s how:

<ol>
  <li>
    Run the following commands (first one will take some time):

    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">gen_bridge_metadata -f Security -o Security.bridgesupport
mkdir -p /Library/BridgeSupport
mv Security.bridgesupport /Library/BridgeSupport
</span></code></pre></div>    </div>
  </li>
  <li>
    Open an IRB session to test it:
  </li>
</ol>

<div class="language-irb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">&gt;&gt; require 'osx/cocoa'
</span><span class="p">=&gt;</span> <span class="kp">true</span>
<span class="o">&gt;&gt;</span> <span class="no">OSX</span><span class="p">.</span><span class="nf">require_framework</span> <span class="s1">'Security'</span>
<span class="o">=&gt;</span> <span class="kp">true</span>
<span class="o">&gt;&gt;</span> <span class="n">defined?</span> <span class="no">OSX</span><span class="o">::</span><span class="no">SecKeychainAddGenericPassword</span><span class="p">()</span>
<span class="o">=&gt;</span> <span class="s2">"method"</span>
</code></pre></div></div>
Hoorah! Two steps! Well, one because the second one was just testing…
Now go make password-able RubyCocoa application! I am not sure how to
pull this off with deployable apps but I suggest your apps could ship
with the file or run those commands on first-run or if the
Security.bridgesupport file doesn’t exist. Note: I have not tested
either of those scenarios, but I would guess the latter would be more
reliable for cross-version development (i.e. Tiger + Leopard)

<h3 id="how-to-use-these-methods">How to use these methods</h3>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Require needed libraries</span>

<span class="nb">require</span> <span class="s1">'osx/cocoa'</span>
<span class="kp">include</span> <span class="no">OSX</span>
<span class="n">require_framework</span> <span class="s1">'Security'</span>

<span class="c1"># Set up some relevant variables</span>

<span class="n">service</span> <span class="o">=</span> <span class="s2">"Test Service"</span>
<span class="n">account</span> <span class="o">=</span> <span class="s2">"MyUsername"</span>
<span class="n">password</span> <span class="o">=</span> <span class="s2">"MyPassword"</span>

<span class="c1"># Add password to default keychain (first param)</span>

<span class="no">SecKeychainAddGenericPassword</span><span class="p">(</span><span class="kp">nil</span><span class="p">,</span> <span class="n">service</span><span class="p">.</span><span class="nf">length</span><span class="p">,</span> <span class="n">service</span><span class="p">,</span> <span class="n">account</span><span class="p">.</span><span class="nf">length</span><span class="p">,</span> <span class="n">account</span><span class="p">,</span> <span class="n">password</span><span class="p">.</span><span class="nf">length</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="kp">nil</span><span class="p">)</span>

<span class="c1"># Finding a password in default keychain (first param)</span>

<span class="n">status</span><span class="p">,</span> <span class="o">*</span><span class="n">password</span> <span class="o">=</span> <span class="no">SecKeychainFindGenericPassword</span><span class="p">(</span><span class="kp">nil</span><span class="p">,</span> <span class="n">service</span><span class="p">.</span><span class="nf">length</span><span class="p">,</span> <span class="n">service</span><span class="p">,</span> <span class="n">account</span><span class="p">.</span><span class="nf">length</span><span class="p">,</span> <span class="n">account</span><span class="p">)</span>

<span class="c1"># Password-related data</span>
<span class="n">password_length</span> <span class="o">=</span> <span class="n">password</span><span class="p">.</span><span class="nf">shift</span> <span class="c1"># =&gt; 10</span>
<span class="n">password_data</span> <span class="o">=</span> <span class="n">password</span><span class="p">.</span><span class="nf">shift</span> <span class="c1"># OSX::ObjcPtr object</span>
<span class="n">password</span> <span class="o">=</span> <span class="n">password_data</span><span class="p">.</span><span class="nf">bytestr</span><span class="p">(</span><span class="n">password_length</span><span class="p">)</span>

<span class="c1"># The last item is another OSX::ObjcPtr. I haven't figured </span>
<span class="c1"># out how to cast or use this yet but will post when I've</span>
<span class="c1"># figured it out</span>
<span class="n">keychain_item</span> <span class="o">=</span> <span class="n">password</span><span class="p">.</span><span class="nf">shift</span>

<span class="c1"># Yay it works! You can also check the password exists</span>
<span class="c1"># in the Keychain Access utility. I've confirmed that</span>
<span class="c1"># this works</span>
<span class="nb">puts</span> <span class="n">password</span> <span class="c1"># =&gt; "MyPassword"</span>
</code></pre></div></div>

<h3 id="update-4808-below-is-a-fix-for-the-rexml-bug-some-people-have">[UPDATE 4/8/08]: Below is a fix for the REXML bug some people have</h3>
been getting (myself included)

There is good news for anyone that has been getting the following error:

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>undefined local variable or method `trans’ for &lt;UNDEFINED&gt; … &lt;/&gt;:REXML::Document
Usage: gen_bridge_metadata [options] &lt;headers…&gt;
Use the `-h’ flag or consult gen_bridge_metadata(1) for help.
</code></pre></div></div>

There is a very simple fix. This is caused by a typo in the source of
REXML. It’s such a massive bug I can’t believe it made it into the
release of Ruby but i did some poking around and it looks like they
renamed a method and didn’t change all references to it.

There are two ways to fix it—patching REXML; and patching <code class="highlighter-rouge">gen_bridge_metadata</code>.

Personally I prefer patching the generator for peace of mind and have submitted the patch at
<a href="http://bridgesupport.macosforge.org/trac/ticket/1">http://bridgesupport.macosforge.org/trac/ticket/1</a>,
but I’ll show both fixes.

<h4 id="patching-genbridgemetadata">Patching gen<em>bridge</em>metadata</h4>

<ol>
  <li>Open <code class="highlighter-rouge">/usr/bin/gen_bridge_metadata and find the method definition for
</code>generate_xml`</li>
  <li>Replace <code class="highlighter-rouge">0</code> in the <code class="highlighter-rouge">xml_document.write()</code> with <code class="highlighter-rouge">-1</code> (both occurrences)</li>
  <li>Save!</li>
</ol>

<h4 id="patching-rexml">Patching REXML</h4>

<ol>
  <li>Open
<code class="highlighter-rouge">/System/Library/Frameworks/Ruby.framework/Versions/1.8/usr/lib/ruby/1.8/rexml/document.rb</code></li>
  <li>Find the line that has <code class="highlighter-rouge">if trans</code> and change it to <code class="highlighter-rouge">if transitive</code></li>
  <li>Save!</li>
</ol>

</p>
  
        <div class="f6 fw3 silver mt0">
          
          <time>29 Jun 2009</time>
          
          <span class="ttl">&middot; 



  
	  2 min read
	

</span>
        </div>
      </article>
    </a>
    
    <a class="link black-80 hover-silver" href="/2009/06/generating-sound-from-sine-waves-on-the-iphone/">
      <article class="f5 lh-copy fw3 pb4 bb b--light-gray">
        <div class="f6 fw6 lh-title ttu tracked mv4"><time>Jun 2009</time></div>
        <h3 class="f3 fw6 lh-title mb0">Generating Sound from Sine Waves on the iPhone</h3>
        <p class="f5 fw3 lh-copy mv2">A few months ago I saw this extremely addictive flash game/toy called
<a href="http://lab.andre-michelle.com/tonematrix">ToneMatrix</a>.

My immediate thought was: “This would make quite possibly the coolest iPhone application ever.”

So my good friend, <a href="http://twitter.com/sync1983">Anthony Mittaz</a>, and I
decided to have a crack at it but hit one immediate hurdle; however
proficient an iPhone developer Anthony is, he hadn’t done anything to do
with sound, and nor had I, in <em>any</em> language/framework, let alone on the
iPhone. Let me tell you this: Apple’s documentation in this area is
severely lacking. Tangent: well, almost all Apple documentation on
specialised things is pretty sparse.

I think we spent about two weeks’ worth of nights reading documentation,
source code (Cocoa, iPhone, Java, C, and others), and plain outright
stabbing in the dark code-wise getting not much more than ugly pops and
crackles. Whenever we thought we had a clean note working, we’d change
the frequency to what <strong>should</strong> be another nice clean note, and would
instead get ear-shattering screeches.

Nonetheless we persevered and were even able to come up with a nifty
little piece of code that could take an array of frequencies and play
them together in what could be made to sound like a pleasant chord.

Here is the relevant code:

<h2 id="code">Code</h2>

<strong>TonePlayer.h</strong>

<pre><code class="language-objective-c">#import &lt;Foundation/Foundation.h&gt;
#include &lt;AudioUnit/AudioUnit.h&gt;
#include &lt;math.h&gt;

#define kTonesAvailable 16
#define kOutputBus 0
#define kInputBus 1
#define kNumChannels 2

@interface TonePlayer : NSObject {
  AudioComponentInstance audioUnit;
  AudioStreamBasicDescription audioFormat;
  float phase[kTonesAvailable];
  float frequencies[kTonesAvailable];
}

-(OSStatus)start;
-(OSStatus)stop;
-(void)resetFrequencies;
-(void)cleanUp;
-(void)intialiseAudio;
@end

// Some C function headers to get arount compile errors while I refactor to be more readable
float phaseOffsetFromFrequency(float);
OSStatus RenderCallback(void*, AudioUnitRenderActionFlags*, const AudioTimeStamp*, UInt32, UInt32, AudioBufferList*);
</code></pre>

<strong>TonePlayer.m</strong>

<pre><code class="language-objective-c">#import "TonePlayer.h"

typedef struct {
  @defs(TonePlayer);
} SinewaveDef;

@implementation TonePlayer

static float gSampleRate = 44100.;
static float notes[111]  = {
      8.1758, 8.6620, 9.1770, 9.7227, 10.3009, 10.9134, 11.5623, 12.2499, 
      12.9783, 13.7500, 14.5676, 15.4339, 16.3516, 17.3239, 18.3540, 19.4454,
      20.6017, 21.8268, 23.1247, 24.4997, 25.9565, 27.5000, 29.1352, 30.8677, 
      32.7032, 34.6478, 36.7081, 38.8909, 41.2034, 43.6535, 46.2493, 48.9994, 
      51.9131, 55.0000, 58.2705, 61.7354, 65.4064, 69.2957, 73.4162, 77.7817, 
      82.4069, 87.3071, 92.4986, 97.9989, 103.8262, 110.0000, 116.5409, 123.4708,
      130.8128, 138.5913, 146.8324, 155.5635, 164.8138, 174.6141, 184.9972, 
      195.9977, 207.6523, 220.0000, 233.0819, 246.9417, 261.6256, 277.1826, 
      293.6648, 311.1270, 329.6276, 349.2282, 369.9944, 391.9954, 415.3047, 
      440.0000, 466.1638, 493.8833, 523.2511, 554.3653, 587.3295, 622.2540, 
      659.2551, 698.4565, 739.9888, 783.9909, 830.6094, 880.0000, 932.3275, 
      987.7666, 1046.5023, 1108.7305, 1174.6591, 1244.5079, 1318.5102, 1396.9129, 
      1479.9777, 1567.9817, 1661.2188, 1760.0000, 1864.6550, 1975.5332, 2093.0045, 
      2217.4610, 2349.3181, 2489.0159, 2637.0205, 2793.8259, 2959.9554, 3135.9635, 
      3322.4376, 3520.0000, 3729.3101, 3951.0664, 4186.0090, 4434.9221, 4698.6363
  };

OSStatus    RenderCallback(void                          *inRefCon,
                           AudioUnitRenderActionFlags    *ioActionFlags,
                           const AudioTimeStamp          *inTimeStamp,
                           UInt32                        inBusNumber,
                           UInt32                        inNumberFrames,
                           AudioBufferList               *ioData)
{
  SinewaveDef* def = inRefCon;
  
  float *outL = ioData-&gt;mBuffers[0].mData;
  float *outR = ioData-&gt;mBuffers[1].mData;

  float wave, j;
  float freqs[kTonesAvailable];
  
  memset(freqs, 0.0f, sizeof(freqs));
  
  for (int i=0; i&lt; inNumberFrames; i++){
    wave = 0.0f;
    j = 0.0f;
    
    for(int m = 0; m &lt; kTonesAvailable; ++m) {
      if(def-&gt;frequencies[m] != 0) {
        if(freqs[m] == 0) freqs[m] = phaseOffsetFromFrequency(def-&gt;frequencies[m]);

        wave += 0.5 * sinf(def-&gt;phase[m]);
        def-&gt;phase[m] += freqs[m];
        
        ++j;
      }
    }
    
    wave /= j;
    
    *outL++ = wave;
    *outR++ = wave;
  }

  return noErr;
}

float phaseOffsetFromFrequency(float frequency) {
  return (float)(frequency * 2.0 * M_PI / gSampleRate);
}

-(void)resetFrequencies{
  memset(frequencies, 0.0f, sizeof(frequencies));
  memset(phase, 0.0f, sizeof(phase));
}

-(OSStatus)start{
  [self resetFrequencies];
  OSStatus status = AudioOutputUnitStart(audioUnit);
  
  // See http://www.phys.unsw.edu.au/jw/notes.html for note numbers
  frequencies[0] = notes[60]; // C
  frequencies[1] = notes[64]; // E
  frequencies[2] = notes[67]; // G
  
  sleep(1);
  
  frequencies[0] = notes[64];
  frequencies[1] = notes[67];
  frequencies[2] = notes[71];
  
  sleep(1);
  
  frequencies[0] = notes[74];
  frequencies[1] = notes[67];
  frequencies[2] = notes[70];
  
  
  return status;
}

-(OSStatus)stop{
  return AudioOutputUnitStop(audioUnit);
}

-(void)cleanUp{
  AudioUnitUninitialize(audioUnit);
}

-(AudioStreamBasicDescription)audioFormat{
  return audioFormat;
}

// Below code is a cut down version (for output only) of the code written by
// Micheal "Code Fighter" Tyson (punch on Mike)
// See http://michael.tyson.id.au/2008/11/04/using-remoteio-audio-unit/ for details
-(void)intialiseAudio{
  OSStatus status;
  
  // Describe audio component
  AudioComponentDescription desc;
  desc.componentType = kAudioUnitType_Output;
  desc.componentSubType = kAudioUnitSubType_RemoteIO;
  desc.componentFlags = 0;
  desc.componentFlagsMask = 0;
  desc.componentManufacturer = kAudioUnitManufacturer_Apple;
  
  // Get component
  AudioComponent inputComponent = AudioComponentFindNext(NULL, &amp;desc);
  
  // Get audio units
  status = AudioComponentInstanceNew(inputComponent, &amp;audioUnit);
  
  UInt32 flag = 1;
  // Enable IO for playback
  status = AudioUnitSetProperty(audioUnit, 
                  kAudioOutputUnitProperty_EnableIO, 
                  kAudioUnitScope_Output, 
                  kOutputBus,
                  &amp;flag, 
                  sizeof(flag));

  // Describe format
        audioFormat.mSampleRate = gSampleRate;
  audioFormat.mFormatID = kAudioFormatLinearPCM;
  audioFormat.mFormatFlags = kAudioFormatFlagsNativeFloatPacked | kAudioFormatFlagIsNonInterleaved;
  audioFormat.mFramesPerPacket = 1;
  audioFormat.mBytesPerPacket = sizeof(Float32);
  audioFormat.mBytesPerFrame = sizeof(Float32);
  audioFormat.mChannelsPerFrame = kNumChannels;
  audioFormat.mBitsPerChannel = 32;
  
  //Apply format
  status = AudioUnitSetProperty(audioUnit, 
                  kAudioUnitProperty_StreamFormat, 
                  kAudioUnitScope_Input, 
                  kOutputBus, 
                  &amp;audioFormat, 
                  sizeof(audioFormat));
   
  // Set up the playback  callback
  AURenderCallbackStruct callbackStruct;
  callbackStruct.inputProc = RenderCallback;
  //set the reference to "self" this becomes *inRefCon in the playback callback
  callbackStruct.inputProcRefCon = self;
  
  status = AudioUnitSetProperty(audioUnit, 
                  kAudioUnitProperty_SetRenderCallback, 
                  kAudioUnitScope_Global, 
                  kOutputBus,
                  &amp;callbackStruct, 
                  sizeof(callbackStruct));
  
  // Initialise
  status = AudioUnitInitialize(audioUnit);
}

@end
</code></pre>

I really wish that I could remember how most of it worked, or, more
importantly, the multitude of projects whose code we had to look at to
get it working. If you recognise any of the code or can help add
references on how people can build up a nice list of references for
people to use if are following a similar pursuit.

If you are wondering what ever happened to the application we were
building, it seems we weren’t the only ones who recognised the potential
of ToneMatrix as an iPhone application. During the 2-3 weeks of us
developing the sound generation code, about 5-6 ToneMatrix clones were
added to the AppStore. While most were crap, there was one that we felt
left little to be improved upon and we therefore recommend everyone goes
and downloads
<a href="http://itunes.apple.com/WebObjects/MZStore.woa/wa/viewSoftware?id=313573137&amp;mt=8">Melodica</a>.
It’s just as addictive as the Flash version, only portable!
</p>
  
        <div class="f6 fw3 silver mt0">
          
          <time>29 Jun 2009</time>
          
          <span class="ttl">&middot; 



  
	  4 min read
	

</span>
        </div>
      </article>
    </a>
    
    <a class="link black-80 hover-silver" href="/2009/06/colemak/">
      <article class="f5 lh-copy fw3 pb4 bb b--light-gray">
        <div class="f6 fw6 lh-title ttu tracked mv4"><time>Jun 2009</time></div>
        <h3 class="f3 fw6 lh-title mb0">Colemak</h3>
        <p class="f5 fw3 lh-copy mv2">About a year ago I found out about the <a href="http://colemak.com">Colemak</a>
keyboard layout. This is what it looks like:

<img src="http://colemak.com/wiki/images/8/80/Colemak_layout_2.png" alt="image" />

I was instantly intrigued and was drawn to a few key features:

<ul>
  <li>Easy to learn</li>
  <li>Caps lock is replaced with backspace (making backspace closer to
fingers and getting rid of the useless caps lock)</li>
  <li>Obvious health benefits (just look how much your fingers need to
move when using QWERTY <a href="http://colemak.com/Compare">here</a>)</li>
  <li>It’s not QWERTY, which was designed <a href="http://colemak.com/FAQ#What.27s_wrong_with_the_QWERTY_layout.3F">without any consideration to
ergonomic or efficiency
aspects</a>.</li>
</ul>

Long story short: it took me a few tries to commit to learning it (3
tries over year in fact). Eventually I went cold turkey for a week and
haven’t looked back. Typing is more comfortable and faster already.

Getting Colemak on OS X is as simple as following <a href="http://colemak.com/Mac">the simple
Installation instructions</a>. The instructions
seem out of date when it comes to re-mapping caps lock to backspace. It
is as simple as downloading
<a href="http://www.pqrs.org/tekezo/macosx/keyremap4macbook/extra.html">PCKeyboardHack</a>,
installing it, rebooting, and choosing the option in its preference pane
to remap caps lock to delete (key code 51).

<h3 id="snow-leopard">Snow Leopard</h3>

Colemak itself works fine under Snow Leopard, however the PCKeyboardHack
utility does not work, because it is hardcoded to only load the kernel
driver if it recognises the OS version. Luckily it is open source, and I
was able to import the Mercurial project into a
<a href="http://github.com">GitHub</a>
<a href="http://github.com/bjeanes/PCKeyboardHack">project</a>, modify it, and
build a version that works fine on Snow Leopard.

<h3 id="dead-keys-that-apple-uses-on-the-qwerty-layout">Dead Keys that Apple uses on the QWERTY layout</h3>

One thing I loved about the QWERTY layout on OS X was the sensible dead
key and alternate character behaviours, allowing users to quickly and
logically input characters such as: , é, ¡, ¿, », ‡, °, etc. The
version of Colemak, for one reason or another, moved or simply didn’t
have many of these shortcuts.

So, I created my own Colemak layout bundle that moves the dead key
positions to preserve the associations with the character position
changes from QWERTY to Colemak. This means, for example,  can be
created by pressing ⌥⇧K on either keyboard layout (where K is the key
that outputs K, not the key that physically says K on it).

My version of the Colemak bundle is available on <a href="http://github.com/bjeanes/colemak">my
GitHub</a> and a direct download to a
zip file is available
<a href="http://cloud.github.com/downloads/bjeanes/colemak/ColemakKeyboardLayouts.bundle.zip">here</a>.
Simply put the .bundle file in your <code class="highlighter-rouge">~/Library/Keyboard Layouts</code>
directory. The bundle includes both the original keyboard layout and my
re-created one so you can switch between them if you need both, for any
reason.
</p>
  
        <div class="f6 fw3 silver mt0">
          
          <time>29 Jun 2009</time>
          
          <span class="ttl">&middot; 



  
	  2 min read
	

</span>
        </div>
      </article>
    </a>
    
    <a class="link black-80 hover-silver" href="/2009/06/snow-leopard-for-the-ruby-developer/">
      <article class="f5 lh-copy fw3 pb4 bb b--light-gray">
        <div class="f6 fw6 lh-title ttu tracked mv4"><time>Jun 2009</time></div>
        <h3 class="f3 fw6 lh-title mb0">Snow Leopard for the Ruby Developer</h3>
        <p class="f5 fw3 lh-copy mv2">After the 2009 WWDC release, I decided to give Snow Leopard a try on my
production machine. Crossing my fingers, expecting a plethora of broken
gems and databases, I wiped my hard drive clean and installed the latest
build.

Much to my surprise, most things worked flawlessly and exactly as it did
on Leopard.

<h3 id="what-ships-with-snow-leopard">What Ships with Snow Leopard</h3>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span> gem <span class="nt">--version</span>
<span class="go">1.3.1

</span><span class="gp">$</span> ruby <span class="nt">--version</span>
<span class="go">ruby 1.8.7 (2008-08-11 patchlevel 72) [universal-darwin10.0]

</span><span class="gp">$</span> gem list
<span class="go">
*** LOCAL GEMS ***
 
actionmailer (2.2.2, 1.3.6)
actionpack (2.2.2, 1.13.6)
actionwebservice (1.2.6)
activerecord (2.2.2, 1.15.6)
activeresource (2.2.2)
activesupport (2.2.2, 1.4.4)
acts_as_ferret (0.4.3)
capistrano (2.5.2)
cgi_multipart_eof_fix (2.5.0)
daemons (1.0.10)
dnssd (0.6.0)
fastthread (1.0.1)
fcgi (0.8.7)
ferret (0.11.6)
gem_plugin (0.2.3)
highline (1.5.0)
hpricot (0.6.164)
libxml-ruby (1.1.2)
mongrel (1.1.5)
needle (1.3.0)
net-scp (1.0.1)
net-sftp (2.0.1, 1.1.1)
net-ssh (2.0.4, 1.1.4)
net-ssh-gateway (1.0.0)
rails (2.2.2, 1.2.6)
rake (0.8.3)
RedCloth (4.1.1)
ruby-openid (2.1.2)
ruby-yadis (0.3.4)
rubynode (0.1.5)
sqlite3-ruby (1.2.4)
termios (0.9.4)
xmpp4r (0.4)
</span></code></pre></div></div>

Quite possibly these default gems and versions will change between now
and the final release of Snow Leopard. For instance, this seed comes
with Rails 2.2.2, even though we are already at 2.3.2. Snow Leopard
doesn’t come out till September and by then we could have an even newer
version of Rails that might be bundled.

<h3 id="what-doesnt-work-and-how-to-fix-it">What doesn’t work, and how to fix it.</h3>

<strong>Textmate</strong> - Everything works fine except for the following shortcuts:
⌘←, ⌘→, ⌘⇧←, and ⌘⇧→. These shortcuts are for moving the text insertion
point to beginning and end of line, and selecting to beginning and end
of line, respectively. The fix is easy, simply download and double click
the TextMate macros attached to <a href="http://ticket.macromates.com/show?ticket_id=0FDE7076">this
ticket</a>

<strong>Nokogiri</strong> - Nokogiri installs fine but gives error “native.bundle:
mach-o, but wrong architecture” when used. Getting around this is as
easy as running
<code class="highlighter-rouge">sudo gem install nokogiri -s http://tenderlovemaking.com/</code> to get the
latest development release which includes a fix for this.

<strong>do_sqlite3</strong> - I haven’t personally used this or tried to fix it but
I saw report of it not working <a href="http://twitter.com/benlovell/status/2182275909">by
@benlovell</a>

<strong>Passenger PrefPane</strong> - Preference pane does not load. No known fix
(it’s probably an easy fix but I haven’t looked enough into it to try).
</p>
  
        <div class="f6 fw3 silver mt0">
          
          <time>28 Jun 2009</time>
          
          <span class="ttl">&middot; 



  
	  1 min read
	

</span>
        </div>
      </article>
    </a>
    
    <a class="link black-80 hover-silver" href="/2009/06/ghost-manage-hostnames-effortlessly/">
      <article class="f5 lh-copy fw3 pb4 bb b--light-gray">
        <div class="f6 fw6 lh-title ttu tracked mv4"><time>Jun 2009</time></div>
        <h3 class="f3 fw6 lh-title mb0">Ghost - Manage hostnames effortlessly</h3>
        <p class="f5 fw3 lh-copy mv2"><h3 id="background">Background</h3>

Ghost is a gem that provides a command and a Ruby API for managing
hostnames locally, much as people do manually by editing <code class="highlighter-rouge">/etc/hosts</code>
now.

Sometime last year I was having to add lots of
<a href="http://modrails.com/">Passenger</a> virtual hosts on my development
machine and felt that having to constantly edit the <code class="highlighter-rouge">/etc/hosts</code> file
was a bit archaic for my liking and that there must be a nicer way of
accomplishing the same task.

Having seen the <a href="http://www.fngtps.com/2008/09/passenger-preference-pane-v1-1">Passenger Preference
Pane</a>
added hostnames without requiring the user to do anything special, I had
a peak into its <a href="http://github.com/alloy/passengerpane">source</a> and
discovered the <code class="highlighter-rouge">dscl</code> (<a href="http://developer.apple.com/documentation/Darwin/Reference/ManPages/man1/dscl.1.html">man
page</a>)
command that comes with Leopard.

For the hell of it I decided to write my
<a href="http://github.com/bjeanes/ghost">Ghost</a> gem using this command and use
it to make a nice wrapper that has an easier syntax than <code class="highlighter-rouge">dscl</code>, and
that is less effort than manually editing my hosts file. Happy with the
result, a few other people requested support for other unix systems and
<a href="http://newtonsinlaws.com">Mitchell V Riley</a> was kind enough to patch
Ghost to fall back to processing and editing the <code class="highlighter-rouge">/etc/hosts</code> file when
not on Leopard.

<h3 id="usage">Usage</h3>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span> ghost add mydevsite.local
<span class="gp">  [Adding] mydevsite.local -&gt;</span> 127.0.0.1
<span class="go">
</span><span class="gp">$</span> ghost add staging-server.local 67.207.136.164
<span class="gp">  [Adding] staging-server.local -&gt;</span> 67.207.136.164
<span class="go">
</span><span class="gp">$</span> ghost list
<span class="go">Listing 2 host(s):
</span><span class="gp">  mydevsite.local      -&gt;</span> 127.0.0.1
<span class="gp">  staging-server.local -&gt;</span> 67.207.136.164
<span class="go">
</span><span class="gp">$</span> ghost delete mydevsite.local
<span class="go">  [Deleting] mydevsite.local

</span><span class="gp">$</span> ghost list
<span class="go">Listing 1 host(s):
</span><span class="gp">  staging-server.local -&gt;</span> 67.207.136.164
<span class="go">
</span><span class="gp">$</span> ghost modify staging-server.local 64.233.167.99
<span class="gp">  [Modifying] staging-server.local -&gt;</span> 64.233.167.99
<span class="go">
</span><span class="gp">$</span> ghost list
<span class="go">Listing 1 host(s):
</span><span class="gp">  staging-server.local -&gt;</span> 64.233.167.99
<span class="go">
</span><span class="gp">$</span> ghost empty
<span class="go">  [Emptying] Done.

</span><span class="gp">$</span> ghost list
<span class="go">Listing 0 host(s):
</span></code></pre></div></div>

<h3 id="other">Other</h3>

Since creating Ghost I’ve used the Ruby library to add an initializer to
my Rails projects that add the domain locally if running under Passenger
in development mode (some configuration is needed to let it do this as
it needs sudo).

Also, I have heard reports that entries in the <code class="highlighter-rouge">/etc/hosts</code> file are
ignored in Snow Leopard. I haven’t tried because I only ever use Ghost
now, but I do know that Ghost still works well.

<h3 id="caveats">Caveats</h3>

It only works on Unix-based systems and the <code class="highlighter-rouge">/etc/hosts</code> path is
hard-coded. Windows support is entirely possible if somebody wants to
use it. It isn’t something I am likely to do as I haven’t booted Windows
in at least a year. In fact, I don’t think I have even ever installed
Ruby on Windows before…
</p>
  
        <div class="f6 fw3 silver mt0">
          
          <time>28 Jun 2009</time>
          
          <span class="ttl">&middot; 



  
	  1 min read
	

</span>
        </div>
      </article>
    </a>
    

  </div>
</div>

<footer class="flex justify-start items-baseline mw7 center w-100 ph3 ph4-ns mt4 mb2 lh-copy">
  <nav class="flex flex-row flex-wrap">
    <span class="f7 fw3 silver mr3 ttc"><a href="https://bjeanes.com/" class="f7 fw5 silver hover-silver link underline-hover" title="Bo Jeanes">Bo jeanes</a> &copy; 2020</span>
    

    
    <span class="f7 fw3 silver mr3">Designed with <a href="https://desiredpersona.com/themes/" class="f7 fw3 silver hover-silver link underline-hover mr3" target="_blank">Minimal Theme</a></span>
    
  </nav>
</footer>

</body>
</html>