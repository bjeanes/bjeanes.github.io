<!DOCTYPE html>
<html lang="">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Meta Robots Tag -->
  <meta name="robots" content="all">

  <!-- Site Author -->
  <meta name="author" content="bo">

  <!-- Atom Feed -->
  <link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Bo Jeanes Feed">
  
  <!-- Stylesheet -->
  <link rel="stylesheet" href="/assets/css/minimal.css">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="/favicon.png">

  <!-- Analytics -->
  

  <!-- SEO -->
  <!-- Begin Jekyll SEO tag v2.3.0 -->
<title>Using AlterEgo with ActiveRecord | Bo Jeanes</title>
<meta property="og:title" content="Using AlterEgo with ActiveRecord" />
<meta name="author" content="Bo Jeanes" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Today after finding the gem AlterEgo and falling in love with the API, @chendo and I came to a sad realisation that its beauty was skin-deep. It seems it is not ActiveRecord-aware and overrides #state and #state= on your models. This means that your state column goes untouched and your models are always in the default state. To get around this, @chendo and I hacked together this little monkey patch which does two things: It adds question methods for each of your defined states. So if you have states: active, inactive, and banned on your User model, your instances will have #active?, #inactive?, and #banned? It properly sets and gets the state of the row and loads it into AlterEgo. Here is the code: module AlterEgo def self.included(base) base.instance_eval do # This will allow us to define a question method for each state in a class # For instance if user has states :active and :inactive, methods active? and inactive? # will be defined when first called def method_missing_with_states(method, *args, &amp;block) begin method_missing_without_states(method, *args, &amp;block) rescue NoMethodError =&gt; e state_found = false result = nil base.states.keys.each do |state| if method.to_s == &quot;#{state}?&quot; &amp;&amp; !state_found self.class.send :define_method, &quot;#{state}?&quot; do self.state == state end state_found = true result = self.__send__(method) end end raise(e) unless state_found result end end alias_method_chain :method_missing, :states # state setter to write to database define_method :state= do |value| write_attribute(:state, value.to_s) end # state getter to read from database define_method :state_with_active_record do (read_attribute(:state) || (self.state = state_without_active_record)).to_sym end alias_method_chain :state, :active_record end end end" />
<meta property="og:description" content="Today after finding the gem AlterEgo and falling in love with the API, @chendo and I came to a sad realisation that its beauty was skin-deep. It seems it is not ActiveRecord-aware and overrides #state and #state= on your models. This means that your state column goes untouched and your models are always in the default state. To get around this, @chendo and I hacked together this little monkey patch which does two things: It adds question methods for each of your defined states. So if you have states: active, inactive, and banned on your User model, your instances will have #active?, #inactive?, and #banned? It properly sets and gets the state of the row and loads it into AlterEgo. Here is the code: module AlterEgo def self.included(base) base.instance_eval do # This will allow us to define a question method for each state in a class # For instance if user has states :active and :inactive, methods active? and inactive? # will be defined when first called def method_missing_with_states(method, *args, &amp;block) begin method_missing_without_states(method, *args, &amp;block) rescue NoMethodError =&gt; e state_found = false result = nil base.states.keys.each do |state| if method.to_s == &quot;#{state}?&quot; &amp;&amp; !state_found self.class.send :define_method, &quot;#{state}?&quot; do self.state == state end state_found = true result = self.__send__(method) end end raise(e) unless state_found result end end alias_method_chain :method_missing, :states # state setter to write to database define_method :state= do |value| write_attribute(:state, value.to_s) end # state getter to read from database define_method :state_with_active_record do (read_attribute(:state) || (self.state = state_without_active_record)).to_sym end alias_method_chain :state, :active_record end end end" />
<link rel="canonical" href="https://bjeanes.com/2009/07/using-alterego-with-activerecord/" />
<meta property="og:url" content="https://bjeanes.com/2009/07/using-alterego-with-activerecord/" />
<meta property="og:site_name" content="Bo Jeanes" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2009-07-03T00:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@bjeanes" />
<meta name="twitter:creator" content="@bjeanes" />
<script type="application/ld+json">
{"mainEntityOfPage":{"@type":"WebPage","@id":"https://bjeanes.com/2009/07/using-alterego-with-activerecord/"},"description":"Today after finding the gem AlterEgo and falling in love with the API, @chendo and I came to a sad realisation that its beauty was skin-deep. It seems it is not ActiveRecord-aware and overrides #state and #state= on your models. This means that your state column goes untouched and your models are always in the default state. To get around this, @chendo and I hacked together this little monkey patch which does two things: It adds question methods for each of your defined states. So if you have states: active, inactive, and banned on your User model, your instances will have #active?, #inactive?, and #banned? It properly sets and gets the state of the row and loads it into AlterEgo. Here is the code: module AlterEgo def self.included(base) base.instance_eval do # This will allow us to define a question method for each state in a class # For instance if user has states :active and :inactive, methods active? and inactive? # will be defined when first called def method_missing_with_states(method, *args, &amp;block) begin method_missing_without_states(method, *args, &amp;block) rescue NoMethodError =&gt; e state_found = false result = nil base.states.keys.each do |state| if method.to_s == &quot;#{state}?&quot; &amp;&amp; !state_found self.class.send :define_method, &quot;#{state}?&quot; do self.state == state end state_found = true result = self.__send__(method) end end raise(e) unless state_found result end end alias_method_chain :method_missing, :states # state setter to write to database define_method :state= do |value| write_attribute(:state, value.to_s) end # state getter to read from database define_method :state_with_active_record do (read_attribute(:state) || (self.state = state_without_active_record)).to_sym end alias_method_chain :state, :active_record end end end","@type":"BlogPosting","url":"https://bjeanes.com/2009/07/using-alterego-with-activerecord/","name":null,"headline":"Using AlterEgo with ActiveRecord","dateModified":"2009-07-03T00:00:00+00:00","datePublished":"2009-07-03T00:00:00+00:00","sameAs":null,"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://avatars2.githubusercontent.com/u/2560?s=200&v=4"},"name":"Bo Jeanes"},"image":null,"author":{"@type":"Person","name":"Bo Jeanes"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

</head>

<body class="black-80 ">



<div class="flex-l justify-between items-center mw7 mw8-l w-100 center pt3 pb3 pl3 pr3-ns ph4-m">

<a class="black-80 hover-black-80 link f2 f3-l fw4 mr3" href="https://bjeanes.com/" title="Home">Bo Jeanes</a>


  <div class="flex-l items-center mt3 mt0-l">
    <nav class="nowrap overflow-x-auto">
    
      
      <a href="https://bjeanes.com/archive/" class="black-80 hover-black-80 link f4 f5-l fw3 mr3 mt2" >Blog</a>
    
      
      <a href="mailto:blog@bjeanes.com" class="black-80 hover-black-80 link f4 f5-l fw3 mr3 mt2" >Contact</a>
    
    </nav>
  </div>
</div>










<main class="flex flex-column items-center">
  <article class="mw7 w-100 ph3 ph4-ns">

    <header class="">
    
    




<div class="flex w-100 mt4 lh-copy">
  <div class="pt1 pt0-ns">
    
      <a href="http://bjeanes.com" target="_blank"><img src="/assets/images/bo.jpg" alt="Bo Jeanes" class="w2 h2 w3-ns h3-ns br-100"></a>
    
  </div>

  <div class="flex flex-column w-90 w-80-ns pl2 pl3-ns">
    <div class="flex items-center">
      
      <a class="f5 fw4 lh-title black-80 hover-black-80 link mr2" href="http://bjeanes.com" target="_blank">Bo Jeanes</a>
      

      
      <a class="f6 fw4 lh-copy link nested-author-cta ba br-pill ph2" href="https://twitter.com/bjeanes" target="_blank">Follow</a>
      
    </div>

    <div class="f6 fw3 lh-copy silver"></div>

    <div class="f6 fw3 lh-copy silver">
      
      <span><time>3 Jul 2009</time></span>
      

      <span class="ttl"> &middot;
        



  
	  1 min read
	


      </span>
    </div>
  </div>
</div>


    

    
    <h1 class="f2 fw6 lh-title mb1">Using AlterEgo with ActiveRecord</h1>
    
    
    </header>


    <div class="mw7 w-100 f5 f4-ns fw3 lh-copy mb0">
    <p>Today after finding the gem AlterEgo and falling in love with the API,
<a href="http://twitter.com/chendo">@chendo</a> and I came to a sad realisation that its beauty was skin-deep. It seems it is not ActiveRecord-aware and overrides <code class="highlighter-rouge">#state</code> and <code class="highlighter-rouge">#state=</code> on your models. This means that your <code class="highlighter-rouge">state</code> column goes
untouched and your models are always in the default state.</p>

<p>To get around this, @chendo and I hacked together this little monkey patch which does two things:</p>

<ol>
  <li>It adds question methods for each of your defined states. So if you have states: <code class="highlighter-rouge">active</code>, <code class="highlighter-rouge">inactive</code>, and <code class="highlighter-rouge">banned</code>
on your <code class="highlighter-rouge">User</code> model, your instances will have <code class="highlighter-rouge">#active?</code>, <code class="highlighter-rouge">#inactive?</code>, and <code class="highlighter-rouge">#banned?</code></li>
  <li>It properly sets and gets the state of the row and loads it into AlterEgo.</li>
</ol>

<p>Here is the code:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="nn">AlterEgo</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">included</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
    <span class="n">base</span><span class="p">.</span><span class="nf">instance_eval</span> <span class="k">do</span>
      
      <span class="c1"># This will allow us to define a question method for each state in a class</span>
      <span class="c1"># For instance if user has states :active and :inactive, methods active? and inactive?</span>
      <span class="c1"># will be defined when first called</span>
      <span class="k">def</span> <span class="nf">method_missing_with_states</span><span class="p">(</span><span class="nb">method</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
        <span class="k">begin</span>
          <span class="n">method_missing_without_states</span><span class="p">(</span><span class="nb">method</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
        <span class="k">rescue</span> <span class="no">NoMethodError</span> <span class="o">=&gt;</span> <span class="n">e</span>
          <span class="n">state_found</span> <span class="o">=</span> <span class="kp">false</span>
          <span class="n">result</span> <span class="o">=</span> <span class="kp">nil</span>
          
          <span class="n">base</span><span class="p">.</span><span class="nf">states</span><span class="p">.</span><span class="nf">keys</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">state</span><span class="o">|</span>
            <span class="k">if</span> <span class="nb">method</span><span class="p">.</span><span class="nf">to_s</span> <span class="o">==</span> <span class="s2">"</span><span class="si">#{</span><span class="n">state</span><span class="si">}</span><span class="s2">?"</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">state_found</span>
              <span class="nb">self</span><span class="p">.</span><span class="nf">class</span><span class="p">.</span><span class="nf">send</span> <span class="ss">:define_method</span><span class="p">,</span> <span class="s2">"</span><span class="si">#{</span><span class="n">state</span><span class="si">}</span><span class="s2">?"</span> <span class="k">do</span>
                <span class="nb">self</span><span class="p">.</span><span class="nf">state</span> <span class="o">==</span> <span class="n">state</span>
              <span class="k">end</span>
              <span class="n">state_found</span> <span class="o">=</span> <span class="kp">true</span>
              <span class="n">result</span> <span class="o">=</span> <span class="nb">self</span><span class="p">.</span><span class="nf">__send__</span><span class="p">(</span><span class="nb">method</span><span class="p">)</span>
            <span class="k">end</span>
          <span class="k">end</span>
          <span class="k">raise</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">unless</span> <span class="n">state_found</span>
          <span class="n">result</span>
        <span class="k">end</span>
      <span class="k">end</span>
      <span class="n">alias_method_chain</span> <span class="ss">:method_missing</span><span class="p">,</span> <span class="ss">:states</span>
      
      <span class="c1"># state setter to write to database</span>
      <span class="n">define_method</span> <span class="ss">:state</span><span class="o">=</span> <span class="k">do</span> <span class="o">|</span><span class="n">value</span><span class="o">|</span>
        <span class="n">write_attribute</span><span class="p">(</span><span class="ss">:state</span><span class="p">,</span> <span class="n">value</span><span class="p">.</span><span class="nf">to_s</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="c1"># state getter to read from database</span>
      <span class="n">define_method</span> <span class="ss">:state_with_active_record</span> <span class="k">do</span>
        <span class="p">(</span><span class="n">read_attribute</span><span class="p">(</span><span class="ss">:state</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nb">self</span><span class="p">.</span><span class="nf">state</span> <span class="o">=</span> <span class="n">state_without_active_record</span><span class="p">)).</span><span class="nf">to_sym</span>
      <span class="k">end</span>
      <span class="n">alias_method_chain</span> <span class="ss">:state</span><span class="p">,</span> <span class="ss">:active_record</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>


    </div>

    <div class="mw7 w-100 lh-copy">
    
    
<div class="flex flex-row justify-start flex-wrap list mb2">
  

  

  

</div>

    

    
    
<div class="flex flex-row justify-end">


  <a class="link black-60 hover-dark-gray w2 ml3" href="https://twitter.com/intent/tweet?text=Using AlterEgo with ActiveRecord https://bjeanes.com/2009/07/using-alterego-with-activerecord/" title="Share on Twitter" aria-hidden="true">
    <svg viewBox="0 0 20 20" data-icon="twitter" style="fill:currentcolor">
      <path xmlns="http://www.w3.org/2000/svg" d="M14.467,6.707c-0.34,0.198-0.715,0.342-1.115,0.419c-0.318-0.335-0.775-0.545-1.279-0.545c-0.969,0-1.754,0.773-1.754,1.727c0,0.135,0.015,0.267,0.045,0.394C8.905,8.628,7.612,7.94,6.747,6.896C6.596,7.151,6.509,7.448,6.509,7.764c0,0.599,0.31,1.128,0.78,1.438C7.002,9.192,6.732,9.115,6.495,8.985c0,0.007,0,0.014,0,0.021c0,0.837,0.605,1.535,1.408,1.694c-0.147,0.04-0.302,0.06-0.462,0.06c-0.113,0-0.223-0.011-0.33-0.031c0.223,0.687,0.871,1.186,1.638,1.199c-0.6,0.464-1.356,0.739-2.179,0.739c-0.142,0-0.281-0.007-0.418-0.023c0.777,0.489,1.699,0.775,2.689,0.775c3.228,0,4.991-2.63,4.991-4.913c0-0.075-0.002-0.149-0.004-0.223c0.342-0.244,0.639-0.547,0.875-0.894c-0.316,0.137-0.652,0.23-1.008,0.272C14.057,7.448,14.336,7.11,14.467,6.707 M10,0.594c-5.195,0-9.406,4.211-9.406,9.406c0,5.195,4.211,9.406,9.406,9.406c5.196,0,9.407-4.211,9.407-9.406C19.406,4.805,15.195,0.594,10,0.594 M10,18.552c-4.723,0-8.551-3.829-8.551-8.552S5.277,1.449,10,1.449c4.723,0,8.551,3.829,8.551,8.551S14.723,18.552,10,18.552"></path>
    </svg>
  </a>



  <a class="link black-60 hover-dark-gray w2 ml3" href="https://www.facebook.com/sharer/sharer.php?u=https://bjeanes.com/2009/07/using-alterego-with-activerecord/" title="Share on Facebook" aria-hidden="true">
    <svg viewBox="0 0 20 20" data-icon="facebook" style="fill:currentcolor">
      <path xmlns="http://www.w3.org/2000/svg" d="M10,0.5c-5.247,0-9.5,4.253-9.5,9.5c0,5.247,4.253,9.5,9.5,9.5c5.247,0,9.5-4.253,9.5-9.5C19.5,4.753,15.247,0.5,10,0.5 M10,18.637c-4.77,0-8.636-3.867-8.636-8.637S5.23,1.364,10,1.364S18.637,5.23,18.637,10S14.77,18.637,10,18.637 M10.858,7.949c0-0.349,0.036-0.536,0.573-0.536h0.719v-1.3H11c-1.38,0-1.866,0.65-1.866,1.743v0.845h-0.86V10h0.86v3.887h1.723V10h1.149l0.152-1.299h-1.302L10.858,7.949z"></path>
    </svg>
  </a>




  <a class="link black-60 hover-dark-gray w2 ml3" href="https://plus.google.com/share?url=https://bjeanes.com/2009/07/using-alterego-with-activerecord/" title="Share on Google+" aria-hidden="true">
    <svg viewBox="0 0 20 20" data-icon="google plus" style="fill:currentcolor">
      <path xmlns="http://www.w3.org/2000/svg" d="M10,0.562c-5.212,0-9.438,4.226-9.438,9.438c0,5.213,4.226,9.438,9.438,9.438c5.212,0,9.438-4.225,9.438-9.438C19.438,4.788,15.212,0.562,10,0.562 M10,18.58c-4.738,0-8.58-3.841-8.58-8.58c0-4.738,3.842-8.58,8.58-8.58c4.737,0,8.579,3.841,8.579,8.58C18.579,14.739,14.737,18.58,10,18.58 M10.033,10.346C9.813,10.183,9.608,9.94,9.6,9.865c0-0.128,0-0.188,0.303-0.435c0.393-0.322,0.609-0.745,0.609-1.192c0-0.387-0.108-0.731-0.293-0.982h0.164l0.908-0.688H8.832c-0.986,0-1.851,0.774-1.851,1.657c0,0.912,0.667,1.604,1.565,1.642C8.533,9.933,8.525,9.996,8.525,10.06c0,0.131,0.03,0.257,0.09,0.378c-1.113,0.007-2.05,0.752-2.05,1.632c0,0.789,0.902,1.362,2.145,1.362c1.343,0,2.067-0.84,2.067-1.631C10.778,11.143,10.576,10.748,10.033,10.346 M8.026,8.198C7.985,7.869,8.054,7.565,8.212,7.384c0.096-0.11,0.22-0.169,0.358-0.169V7.036l0.016,0.179c0.412,0.014,0.807,0.501,0.88,1.086c0.042,0.335-0.03,0.647-0.191,0.833c-0.096,0.11-0.217,0.169-0.367,0.168h0C8.503,9.29,8.1,8.784,8.026,8.198 M8.707,12.749c-0.612,0-1.093-0.394-1.093-0.897c0-0.461,0.562-0.865,1.202-0.865v-0.18h0l0.017,0.18c0.138,0.002,0.272,0.022,0.399,0.062l0.126,0.092c0.326,0.231,0.498,0.363,0.549,0.575c0.013,0.056,0.019,0.111,0.019,0.167C9.927,12.458,9.517,12.749,8.707,12.749M13.43,6.993h-0.858v1.288H11.28V9.14h1.291v1.283h0.858V9.14h1.293V8.281H13.43V6.993z"></path>
    </svg>
  </a>


</div>


    

    
    



<div class="flex w-100 mt2 lh-copy bt b--light-gray pv3">
  <div>
    
      <a href="http://bjeanes.com" target="_blank"><img src="/assets/images/bo.jpg" alt="Bo Jeanes" class="w2 h2 w3-ns h3-ns br-100"></a>
    
  </div>

  <div class="flex flex-column w-90 w-80-ns pl2 pl3-ns">
    <div class="flex items-center-ns">
      
      <a class="f5 f4-ns fw4 lh-title black-80 hover-black-80 link mr2" href="http://bjeanes.com" target="_blank">Bo Jeanes</a>
      

      
      <a class="f6 fw4 link nested-author-cta ba br-pill ph2" href="https://twitter.com/bjeanes" target="_blank">Follow</a>
      
    </div>


    <div class="f6 f5-ns fw3 lh-copy silver">Bo is a software engineer who cares deeply about simplicity in design and
building complex behaviours out of simple primitives. Bo primarily works in
Ruby day-to-day, though is a functional programmer at heart and a fan of
programming languages generally, with particular soft spots for Clojure,
Elixir, and Rust.
</div>
  </div>

</div>



    

    

    
    <script
  src="https://utteranc.es/client.js"
  repo="bjeanes/bjeanes.github.io"
  issue-term="og:title"
  label="blog-comments"
  theme="github-light"
  crossorigin="anonymous"
  async
></script>
<noscript
  >Go to
  <a href="https://github.com/bjeanes/bjeanes.github.io/issues">GH issues</a> to
  view/leave comments</noscript
>

    
    </div>

  </article>
</main>




<footer class="flex justify-start items-baseline mw7 center w-100 ph3 ph4-ns mt4 mb2 lh-copy">
  <nav class="flex flex-row flex-wrap">
    <span class="f7 fw3 silver mr3 ttc"><a href="https://bjeanes.com/" class="f7 fw5 silver hover-silver link underline-hover" title="Bo Jeanes">Bo jeanes</a> &copy; 2020</span>
    

    
    <span class="f7 fw3 silver mr3">Designed with <a href="https://desiredpersona.com/themes/" class="f7 fw3 silver hover-silver link underline-hover mr3" target="_blank">Minimal Theme</a></span>
    
  </nav>
</footer>



</body>
</html>
