<!DOCTYPE html>
<html lang="">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Meta Robots Tag -->
  <meta name="robots" content="all">

  <!-- Site Author -->
  <meta name="author" content="bo">

  <!-- Atom Feed -->
  <link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Bo Jeanes Feed">
  
  <!-- Stylesheet -->
  <link rel="stylesheet" href="/assets/css/minimal.css">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="/favicon.png">

  <!-- Analytics -->
  

  <!-- SEO -->
  <!-- Begin Jekyll SEO tag v2.3.0 -->
<title>Generating Sound from Sine Waves on the iPhone | Bo Jeanes</title>
<meta property="og:title" content="Generating Sound from Sine Waves on the iPhone" />
<meta name="author" content="Bo Jeanes" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="A few months ago I saw this extremely addictive flash game/toy called ToneMatrix. My immediate thought was: “This would make quite possibly the coolest iPhone application ever.” So my good friend, Anthony Mittaz, and I decided to have a crack at it but hit one immediate hurdle; however proficient an iPhone developer Anthony is, he hadn’t done anything to do with sound, and nor had I, in any language/framework, let alone on the iPhone. Let me tell you this: Apple’s documentation in this area is severely lacking. Tangent: well, almost all Apple documentation on specialised things is pretty sparse. I think we spent about two weeks’ worth of nights reading documentation, source code (Cocoa, iPhone, Java, C, and others), and plain outright stabbing in the dark code-wise getting not much more than ugly pops and crackles. Whenever we thought we had a clean note working, we’d change the frequency to what should be another nice clean note, and would instead get ear-shattering screeches. Nonetheless we persevered and were even able to come up with a nifty little piece of code that could take an array of frequencies and play them together in what could be made to sound like a pleasant chord. Here is the relevant code: Code TonePlayer.h #import &lt;Foundation/Foundation.h&gt; #include &lt;AudioUnit/AudioUnit.h&gt; #include &lt;math.h&gt; #define kTonesAvailable 16 #define kOutputBus 0 #define kInputBus 1 #define kNumChannels 2 @interface TonePlayer : NSObject { AudioComponentInstance audioUnit; AudioStreamBasicDescription audioFormat; float phase[kTonesAvailable]; float frequencies[kTonesAvailable]; } -(OSStatus)start; -(OSStatus)stop; -(void)resetFrequencies; -(void)cleanUp; -(void)intialiseAudio; @end // Some C function headers to get arount compile errors while I refactor to be more readable float phaseOffsetFromFrequency(float); OSStatus RenderCallback(void*, AudioUnitRenderActionFlags*, const AudioTimeStamp*, UInt32, UInt32, AudioBufferList*); TonePlayer.m #import &quot;TonePlayer.h&quot; typedef struct { @defs(TonePlayer); } SinewaveDef; @implementation TonePlayer static float gSampleRate = 44100.; static float notes[111] = { 8.1758, 8.6620, 9.1770, 9.7227, 10.3009, 10.9134, 11.5623, 12.2499, 12.9783, 13.7500, 14.5676, 15.4339, 16.3516, 17.3239, 18.3540, 19.4454, 20.6017, 21.8268, 23.1247, 24.4997, 25.9565, 27.5000, 29.1352, 30.8677, 32.7032, 34.6478, 36.7081, 38.8909, 41.2034, 43.6535, 46.2493, 48.9994, 51.9131, 55.0000, 58.2705, 61.7354, 65.4064, 69.2957, 73.4162, 77.7817, 82.4069, 87.3071, 92.4986, 97.9989, 103.8262, 110.0000, 116.5409, 123.4708, 130.8128, 138.5913, 146.8324, 155.5635, 164.8138, 174.6141, 184.9972, 195.9977, 207.6523, 220.0000, 233.0819, 246.9417, 261.6256, 277.1826, 293.6648, 311.1270, 329.6276, 349.2282, 369.9944, 391.9954, 415.3047, 440.0000, 466.1638, 493.8833, 523.2511, 554.3653, 587.3295, 622.2540, 659.2551, 698.4565, 739.9888, 783.9909, 830.6094, 880.0000, 932.3275, 987.7666, 1046.5023, 1108.7305, 1174.6591, 1244.5079, 1318.5102, 1396.9129, 1479.9777, 1567.9817, 1661.2188, 1760.0000, 1864.6550, 1975.5332, 2093.0045, 2217.4610, 2349.3181, 2489.0159, 2637.0205, 2793.8259, 2959.9554, 3135.9635, 3322.4376, 3520.0000, 3729.3101, 3951.0664, 4186.0090, 4434.9221, 4698.6363 }; OSStatus RenderCallback(void *inRefCon, AudioUnitRenderActionFlags *ioActionFlags, const AudioTimeStamp *inTimeStamp, UInt32 inBusNumber, UInt32 inNumberFrames, AudioBufferList *ioData) { SinewaveDef* def = inRefCon; float *outL = ioData-&gt;mBuffers[0].mData; float *outR = ioData-&gt;mBuffers[1].mData; float wave, j; float freqs[kTonesAvailable]; memset(freqs, 0.0f, sizeof(freqs)); for (int i=0; i&lt; inNumberFrames; i++){ wave = 0.0f; j = 0.0f; for(int m = 0; m &lt; kTonesAvailable; ++m) { if(def-&gt;frequencies[m] != 0) { if(freqs[m] == 0) freqs[m] = phaseOffsetFromFrequency(def-&gt;frequencies[m]); wave += 0.5 * sinf(def-&gt;phase[m]); def-&gt;phase[m] += freqs[m]; ++j; } } wave /= j; *outL++ = wave; *outR++ = wave; } return noErr; } float phaseOffsetFromFrequency(float frequency) { return (float)(frequency * 2.0 * M_PI / gSampleRate); } -(void)resetFrequencies{ memset(frequencies, 0.0f, sizeof(frequencies)); memset(phase, 0.0f, sizeof(phase)); } -(OSStatus)start{ [self resetFrequencies]; OSStatus status = AudioOutputUnitStart(audioUnit); // See http://www.phys.unsw.edu.au/jw/notes.html for note numbers frequencies[0] = notes[60]; // C frequencies[1] = notes[64]; // E frequencies[2] = notes[67]; // G sleep(1); frequencies[0] = notes[64]; frequencies[1] = notes[67]; frequencies[2] = notes[71]; sleep(1); frequencies[0] = notes[74]; frequencies[1] = notes[67]; frequencies[2] = notes[70]; return status; } -(OSStatus)stop{ return AudioOutputUnitStop(audioUnit); } -(void)cleanUp{ AudioUnitUninitialize(audioUnit); } -(AudioStreamBasicDescription)audioFormat{ return audioFormat; } // Below code is a cut down version (for output only) of the code written by // Micheal &quot;Code Fighter&quot; Tyson (punch on Mike) // See http://michael.tyson.id.au/2008/11/04/using-remoteio-audio-unit/ for details -(void)intialiseAudio{ OSStatus status; // Describe audio component AudioComponentDescription desc; desc.componentType = kAudioUnitType_Output; desc.componentSubType = kAudioUnitSubType_RemoteIO; desc.componentFlags = 0; desc.componentFlagsMask = 0; desc.componentManufacturer = kAudioUnitManufacturer_Apple; // Get component AudioComponent inputComponent = AudioComponentFindNext(NULL, &amp;desc); // Get audio units status = AudioComponentInstanceNew(inputComponent, &amp;audioUnit); UInt32 flag = 1; // Enable IO for playback status = AudioUnitSetProperty(audioUnit, kAudioOutputUnitProperty_EnableIO, kAudioUnitScope_Output, kOutputBus, &amp;flag, sizeof(flag)); // Describe format audioFormat.mSampleRate = gSampleRate; audioFormat.mFormatID = kAudioFormatLinearPCM; audioFormat.mFormatFlags = kAudioFormatFlagsNativeFloatPacked | kAudioFormatFlagIsNonInterleaved; audioFormat.mFramesPerPacket = 1; audioFormat.mBytesPerPacket = sizeof(Float32); audioFormat.mBytesPerFrame = sizeof(Float32); audioFormat.mChannelsPerFrame = kNumChannels; audioFormat.mBitsPerChannel = 32; //Apply format status = AudioUnitSetProperty(audioUnit, kAudioUnitProperty_StreamFormat, kAudioUnitScope_Input, kOutputBus, &amp;audioFormat, sizeof(audioFormat)); // Set up the playback callback AURenderCallbackStruct callbackStruct; callbackStruct.inputProc = RenderCallback; //set the reference to &quot;self&quot; this becomes *inRefCon in the playback callback callbackStruct.inputProcRefCon = self; status = AudioUnitSetProperty(audioUnit, kAudioUnitProperty_SetRenderCallback, kAudioUnitScope_Global, kOutputBus, &amp;callbackStruct, sizeof(callbackStruct)); // Initialise status = AudioUnitInitialize(audioUnit); } @end I really wish that I could remember how most of it worked, or, more importantly, the multitude of projects whose code we had to look at to get it working. If you recognise any of the code or can help add references on how people can build up a nice list of references for people to use if are following a similar pursuit. If you are wondering what ever happened to the application we were building, it seems we weren’t the only ones who recognised the potential of ToneMatrix as an iPhone application. During the 2-3 weeks of us developing the sound generation code, about 5-6 ToneMatrix clones were added to the AppStore. While most were crap, there was one that we felt left little to be improved upon and we therefore recommend everyone goes and downloads Melodica. It’s just as addictive as the Flash version, only portable!" />
<meta property="og:description" content="A few months ago I saw this extremely addictive flash game/toy called ToneMatrix. My immediate thought was: “This would make quite possibly the coolest iPhone application ever.” So my good friend, Anthony Mittaz, and I decided to have a crack at it but hit one immediate hurdle; however proficient an iPhone developer Anthony is, he hadn’t done anything to do with sound, and nor had I, in any language/framework, let alone on the iPhone. Let me tell you this: Apple’s documentation in this area is severely lacking. Tangent: well, almost all Apple documentation on specialised things is pretty sparse. I think we spent about two weeks’ worth of nights reading documentation, source code (Cocoa, iPhone, Java, C, and others), and plain outright stabbing in the dark code-wise getting not much more than ugly pops and crackles. Whenever we thought we had a clean note working, we’d change the frequency to what should be another nice clean note, and would instead get ear-shattering screeches. Nonetheless we persevered and were even able to come up with a nifty little piece of code that could take an array of frequencies and play them together in what could be made to sound like a pleasant chord. Here is the relevant code: Code TonePlayer.h #import &lt;Foundation/Foundation.h&gt; #include &lt;AudioUnit/AudioUnit.h&gt; #include &lt;math.h&gt; #define kTonesAvailable 16 #define kOutputBus 0 #define kInputBus 1 #define kNumChannels 2 @interface TonePlayer : NSObject { AudioComponentInstance audioUnit; AudioStreamBasicDescription audioFormat; float phase[kTonesAvailable]; float frequencies[kTonesAvailable]; } -(OSStatus)start; -(OSStatus)stop; -(void)resetFrequencies; -(void)cleanUp; -(void)intialiseAudio; @end // Some C function headers to get arount compile errors while I refactor to be more readable float phaseOffsetFromFrequency(float); OSStatus RenderCallback(void*, AudioUnitRenderActionFlags*, const AudioTimeStamp*, UInt32, UInt32, AudioBufferList*); TonePlayer.m #import &quot;TonePlayer.h&quot; typedef struct { @defs(TonePlayer); } SinewaveDef; @implementation TonePlayer static float gSampleRate = 44100.; static float notes[111] = { 8.1758, 8.6620, 9.1770, 9.7227, 10.3009, 10.9134, 11.5623, 12.2499, 12.9783, 13.7500, 14.5676, 15.4339, 16.3516, 17.3239, 18.3540, 19.4454, 20.6017, 21.8268, 23.1247, 24.4997, 25.9565, 27.5000, 29.1352, 30.8677, 32.7032, 34.6478, 36.7081, 38.8909, 41.2034, 43.6535, 46.2493, 48.9994, 51.9131, 55.0000, 58.2705, 61.7354, 65.4064, 69.2957, 73.4162, 77.7817, 82.4069, 87.3071, 92.4986, 97.9989, 103.8262, 110.0000, 116.5409, 123.4708, 130.8128, 138.5913, 146.8324, 155.5635, 164.8138, 174.6141, 184.9972, 195.9977, 207.6523, 220.0000, 233.0819, 246.9417, 261.6256, 277.1826, 293.6648, 311.1270, 329.6276, 349.2282, 369.9944, 391.9954, 415.3047, 440.0000, 466.1638, 493.8833, 523.2511, 554.3653, 587.3295, 622.2540, 659.2551, 698.4565, 739.9888, 783.9909, 830.6094, 880.0000, 932.3275, 987.7666, 1046.5023, 1108.7305, 1174.6591, 1244.5079, 1318.5102, 1396.9129, 1479.9777, 1567.9817, 1661.2188, 1760.0000, 1864.6550, 1975.5332, 2093.0045, 2217.4610, 2349.3181, 2489.0159, 2637.0205, 2793.8259, 2959.9554, 3135.9635, 3322.4376, 3520.0000, 3729.3101, 3951.0664, 4186.0090, 4434.9221, 4698.6363 }; OSStatus RenderCallback(void *inRefCon, AudioUnitRenderActionFlags *ioActionFlags, const AudioTimeStamp *inTimeStamp, UInt32 inBusNumber, UInt32 inNumberFrames, AudioBufferList *ioData) { SinewaveDef* def = inRefCon; float *outL = ioData-&gt;mBuffers[0].mData; float *outR = ioData-&gt;mBuffers[1].mData; float wave, j; float freqs[kTonesAvailable]; memset(freqs, 0.0f, sizeof(freqs)); for (int i=0; i&lt; inNumberFrames; i++){ wave = 0.0f; j = 0.0f; for(int m = 0; m &lt; kTonesAvailable; ++m) { if(def-&gt;frequencies[m] != 0) { if(freqs[m] == 0) freqs[m] = phaseOffsetFromFrequency(def-&gt;frequencies[m]); wave += 0.5 * sinf(def-&gt;phase[m]); def-&gt;phase[m] += freqs[m]; ++j; } } wave /= j; *outL++ = wave; *outR++ = wave; } return noErr; } float phaseOffsetFromFrequency(float frequency) { return (float)(frequency * 2.0 * M_PI / gSampleRate); } -(void)resetFrequencies{ memset(frequencies, 0.0f, sizeof(frequencies)); memset(phase, 0.0f, sizeof(phase)); } -(OSStatus)start{ [self resetFrequencies]; OSStatus status = AudioOutputUnitStart(audioUnit); // See http://www.phys.unsw.edu.au/jw/notes.html for note numbers frequencies[0] = notes[60]; // C frequencies[1] = notes[64]; // E frequencies[2] = notes[67]; // G sleep(1); frequencies[0] = notes[64]; frequencies[1] = notes[67]; frequencies[2] = notes[71]; sleep(1); frequencies[0] = notes[74]; frequencies[1] = notes[67]; frequencies[2] = notes[70]; return status; } -(OSStatus)stop{ return AudioOutputUnitStop(audioUnit); } -(void)cleanUp{ AudioUnitUninitialize(audioUnit); } -(AudioStreamBasicDescription)audioFormat{ return audioFormat; } // Below code is a cut down version (for output only) of the code written by // Micheal &quot;Code Fighter&quot; Tyson (punch on Mike) // See http://michael.tyson.id.au/2008/11/04/using-remoteio-audio-unit/ for details -(void)intialiseAudio{ OSStatus status; // Describe audio component AudioComponentDescription desc; desc.componentType = kAudioUnitType_Output; desc.componentSubType = kAudioUnitSubType_RemoteIO; desc.componentFlags = 0; desc.componentFlagsMask = 0; desc.componentManufacturer = kAudioUnitManufacturer_Apple; // Get component AudioComponent inputComponent = AudioComponentFindNext(NULL, &amp;desc); // Get audio units status = AudioComponentInstanceNew(inputComponent, &amp;audioUnit); UInt32 flag = 1; // Enable IO for playback status = AudioUnitSetProperty(audioUnit, kAudioOutputUnitProperty_EnableIO, kAudioUnitScope_Output, kOutputBus, &amp;flag, sizeof(flag)); // Describe format audioFormat.mSampleRate = gSampleRate; audioFormat.mFormatID = kAudioFormatLinearPCM; audioFormat.mFormatFlags = kAudioFormatFlagsNativeFloatPacked | kAudioFormatFlagIsNonInterleaved; audioFormat.mFramesPerPacket = 1; audioFormat.mBytesPerPacket = sizeof(Float32); audioFormat.mBytesPerFrame = sizeof(Float32); audioFormat.mChannelsPerFrame = kNumChannels; audioFormat.mBitsPerChannel = 32; //Apply format status = AudioUnitSetProperty(audioUnit, kAudioUnitProperty_StreamFormat, kAudioUnitScope_Input, kOutputBus, &amp;audioFormat, sizeof(audioFormat)); // Set up the playback callback AURenderCallbackStruct callbackStruct; callbackStruct.inputProc = RenderCallback; //set the reference to &quot;self&quot; this becomes *inRefCon in the playback callback callbackStruct.inputProcRefCon = self; status = AudioUnitSetProperty(audioUnit, kAudioUnitProperty_SetRenderCallback, kAudioUnitScope_Global, kOutputBus, &amp;callbackStruct, sizeof(callbackStruct)); // Initialise status = AudioUnitInitialize(audioUnit); } @end I really wish that I could remember how most of it worked, or, more importantly, the multitude of projects whose code we had to look at to get it working. If you recognise any of the code or can help add references on how people can build up a nice list of references for people to use if are following a similar pursuit. If you are wondering what ever happened to the application we were building, it seems we weren’t the only ones who recognised the potential of ToneMatrix as an iPhone application. During the 2-3 weeks of us developing the sound generation code, about 5-6 ToneMatrix clones were added to the AppStore. While most were crap, there was one that we felt left little to be improved upon and we therefore recommend everyone goes and downloads Melodica. It’s just as addictive as the Flash version, only portable!" />
<link rel="canonical" href="https://bjeanes.com/2009/06/generating-sound-from-sine-waves-on-the-iphone/" />
<meta property="og:url" content="https://bjeanes.com/2009/06/generating-sound-from-sine-waves-on-the-iphone/" />
<meta property="og:site_name" content="Bo Jeanes" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2009-06-29T00:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@bjeanes" />
<meta name="twitter:creator" content="@bjeanes" />
<script type="application/ld+json">
{"mainEntityOfPage":{"@type":"WebPage","@id":"https://bjeanes.com/2009/06/generating-sound-from-sine-waves-on-the-iphone/"},"description":"A few months ago I saw this extremely addictive flash game/toy called ToneMatrix. My immediate thought was: “This would make quite possibly the coolest iPhone application ever.” So my good friend, Anthony Mittaz, and I decided to have a crack at it but hit one immediate hurdle; however proficient an iPhone developer Anthony is, he hadn’t done anything to do with sound, and nor had I, in any language/framework, let alone on the iPhone. Let me tell you this: Apple’s documentation in this area is severely lacking. Tangent: well, almost all Apple documentation on specialised things is pretty sparse. I think we spent about two weeks’ worth of nights reading documentation, source code (Cocoa, iPhone, Java, C, and others), and plain outright stabbing in the dark code-wise getting not much more than ugly pops and crackles. Whenever we thought we had a clean note working, we’d change the frequency to what should be another nice clean note, and would instead get ear-shattering screeches. Nonetheless we persevered and were even able to come up with a nifty little piece of code that could take an array of frequencies and play them together in what could be made to sound like a pleasant chord. Here is the relevant code: Code TonePlayer.h #import &lt;Foundation/Foundation.h&gt; #include &lt;AudioUnit/AudioUnit.h&gt; #include &lt;math.h&gt; #define kTonesAvailable 16 #define kOutputBus 0 #define kInputBus 1 #define kNumChannels 2 @interface TonePlayer : NSObject { AudioComponentInstance audioUnit; AudioStreamBasicDescription audioFormat; float phase[kTonesAvailable]; float frequencies[kTonesAvailable]; } -(OSStatus)start; -(OSStatus)stop; -(void)resetFrequencies; -(void)cleanUp; -(void)intialiseAudio; @end // Some C function headers to get arount compile errors while I refactor to be more readable float phaseOffsetFromFrequency(float); OSStatus RenderCallback(void*, AudioUnitRenderActionFlags*, const AudioTimeStamp*, UInt32, UInt32, AudioBufferList*); TonePlayer.m #import &quot;TonePlayer.h&quot; typedef struct { @defs(TonePlayer); } SinewaveDef; @implementation TonePlayer static float gSampleRate = 44100.; static float notes[111] = { 8.1758, 8.6620, 9.1770, 9.7227, 10.3009, 10.9134, 11.5623, 12.2499, 12.9783, 13.7500, 14.5676, 15.4339, 16.3516, 17.3239, 18.3540, 19.4454, 20.6017, 21.8268, 23.1247, 24.4997, 25.9565, 27.5000, 29.1352, 30.8677, 32.7032, 34.6478, 36.7081, 38.8909, 41.2034, 43.6535, 46.2493, 48.9994, 51.9131, 55.0000, 58.2705, 61.7354, 65.4064, 69.2957, 73.4162, 77.7817, 82.4069, 87.3071, 92.4986, 97.9989, 103.8262, 110.0000, 116.5409, 123.4708, 130.8128, 138.5913, 146.8324, 155.5635, 164.8138, 174.6141, 184.9972, 195.9977, 207.6523, 220.0000, 233.0819, 246.9417, 261.6256, 277.1826, 293.6648, 311.1270, 329.6276, 349.2282, 369.9944, 391.9954, 415.3047, 440.0000, 466.1638, 493.8833, 523.2511, 554.3653, 587.3295, 622.2540, 659.2551, 698.4565, 739.9888, 783.9909, 830.6094, 880.0000, 932.3275, 987.7666, 1046.5023, 1108.7305, 1174.6591, 1244.5079, 1318.5102, 1396.9129, 1479.9777, 1567.9817, 1661.2188, 1760.0000, 1864.6550, 1975.5332, 2093.0045, 2217.4610, 2349.3181, 2489.0159, 2637.0205, 2793.8259, 2959.9554, 3135.9635, 3322.4376, 3520.0000, 3729.3101, 3951.0664, 4186.0090, 4434.9221, 4698.6363 }; OSStatus RenderCallback(void *inRefCon, AudioUnitRenderActionFlags *ioActionFlags, const AudioTimeStamp *inTimeStamp, UInt32 inBusNumber, UInt32 inNumberFrames, AudioBufferList *ioData) { SinewaveDef* def = inRefCon; float *outL = ioData-&gt;mBuffers[0].mData; float *outR = ioData-&gt;mBuffers[1].mData; float wave, j; float freqs[kTonesAvailable]; memset(freqs, 0.0f, sizeof(freqs)); for (int i=0; i&lt; inNumberFrames; i++){ wave = 0.0f; j = 0.0f; for(int m = 0; m &lt; kTonesAvailable; ++m) { if(def-&gt;frequencies[m] != 0) { if(freqs[m] == 0) freqs[m] = phaseOffsetFromFrequency(def-&gt;frequencies[m]); wave += 0.5 * sinf(def-&gt;phase[m]); def-&gt;phase[m] += freqs[m]; ++j; } } wave /= j; *outL++ = wave; *outR++ = wave; } return noErr; } float phaseOffsetFromFrequency(float frequency) { return (float)(frequency * 2.0 * M_PI / gSampleRate); } -(void)resetFrequencies{ memset(frequencies, 0.0f, sizeof(frequencies)); memset(phase, 0.0f, sizeof(phase)); } -(OSStatus)start{ [self resetFrequencies]; OSStatus status = AudioOutputUnitStart(audioUnit); // See http://www.phys.unsw.edu.au/jw/notes.html for note numbers frequencies[0] = notes[60]; // C frequencies[1] = notes[64]; // E frequencies[2] = notes[67]; // G sleep(1); frequencies[0] = notes[64]; frequencies[1] = notes[67]; frequencies[2] = notes[71]; sleep(1); frequencies[0] = notes[74]; frequencies[1] = notes[67]; frequencies[2] = notes[70]; return status; } -(OSStatus)stop{ return AudioOutputUnitStop(audioUnit); } -(void)cleanUp{ AudioUnitUninitialize(audioUnit); } -(AudioStreamBasicDescription)audioFormat{ return audioFormat; } // Below code is a cut down version (for output only) of the code written by // Micheal &quot;Code Fighter&quot; Tyson (punch on Mike) // See http://michael.tyson.id.au/2008/11/04/using-remoteio-audio-unit/ for details -(void)intialiseAudio{ OSStatus status; // Describe audio component AudioComponentDescription desc; desc.componentType = kAudioUnitType_Output; desc.componentSubType = kAudioUnitSubType_RemoteIO; desc.componentFlags = 0; desc.componentFlagsMask = 0; desc.componentManufacturer = kAudioUnitManufacturer_Apple; // Get component AudioComponent inputComponent = AudioComponentFindNext(NULL, &amp;desc); // Get audio units status = AudioComponentInstanceNew(inputComponent, &amp;audioUnit); UInt32 flag = 1; // Enable IO for playback status = AudioUnitSetProperty(audioUnit, kAudioOutputUnitProperty_EnableIO, kAudioUnitScope_Output, kOutputBus, &amp;flag, sizeof(flag)); // Describe format audioFormat.mSampleRate = gSampleRate; audioFormat.mFormatID = kAudioFormatLinearPCM; audioFormat.mFormatFlags = kAudioFormatFlagsNativeFloatPacked | kAudioFormatFlagIsNonInterleaved; audioFormat.mFramesPerPacket = 1; audioFormat.mBytesPerPacket = sizeof(Float32); audioFormat.mBytesPerFrame = sizeof(Float32); audioFormat.mChannelsPerFrame = kNumChannels; audioFormat.mBitsPerChannel = 32; //Apply format status = AudioUnitSetProperty(audioUnit, kAudioUnitProperty_StreamFormat, kAudioUnitScope_Input, kOutputBus, &amp;audioFormat, sizeof(audioFormat)); // Set up the playback callback AURenderCallbackStruct callbackStruct; callbackStruct.inputProc = RenderCallback; //set the reference to &quot;self&quot; this becomes *inRefCon in the playback callback callbackStruct.inputProcRefCon = self; status = AudioUnitSetProperty(audioUnit, kAudioUnitProperty_SetRenderCallback, kAudioUnitScope_Global, kOutputBus, &amp;callbackStruct, sizeof(callbackStruct)); // Initialise status = AudioUnitInitialize(audioUnit); } @end I really wish that I could remember how most of it worked, or, more importantly, the multitude of projects whose code we had to look at to get it working. If you recognise any of the code or can help add references on how people can build up a nice list of references for people to use if are following a similar pursuit. If you are wondering what ever happened to the application we were building, it seems we weren’t the only ones who recognised the potential of ToneMatrix as an iPhone application. During the 2-3 weeks of us developing the sound generation code, about 5-6 ToneMatrix clones were added to the AppStore. While most were crap, there was one that we felt left little to be improved upon and we therefore recommend everyone goes and downloads Melodica. It’s just as addictive as the Flash version, only portable!","@type":"BlogPosting","url":"https://bjeanes.com/2009/06/generating-sound-from-sine-waves-on-the-iphone/","name":null,"headline":"Generating Sound from Sine Waves on the iPhone","dateModified":"2009-06-29T00:00:00+00:00","datePublished":"2009-06-29T00:00:00+00:00","sameAs":null,"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://avatars2.githubusercontent.com/u/2560?s=200&v=4"},"name":"Bo Jeanes"},"image":null,"author":{"@type":"Person","name":"Bo Jeanes"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

</head>

<body class="black-80 ">



<div class="flex-l justify-between items-center mw7 mw8-l w-100 center pt3 pb3 pl3 pr3-ns ph4-m">

<a class="black-80 hover-black-80 link f2 f3-l fw4 mr3" href="https://bjeanes.com/" title="Home">Bo Jeanes</a>


  <div class="flex-l items-center mt3 mt0-l">
    <nav class="nowrap overflow-x-auto">
    
      
      <a href="https://bjeanes.com/archive/" class="black-80 hover-black-80 link f4 f5-l fw3 mr3 mt2" >Blog</a>
    
      
      <a href="mailto:blog@bjeanes.com" class="black-80 hover-black-80 link f4 f5-l fw3 mr3 mt2" >Contact</a>
    
    </nav>
  </div>
</div>










<main class="flex flex-column items-center">
  <article class="mw7 w-100 ph3 ph4-ns">

    <header class="">
    
    




<div class="flex w-100 mt4 lh-copy">
  <div class="pt1 pt0-ns">
    
      <a href="http://bjeanes.com" target="_blank"><img src="/assets/images/bo.jpg" alt="Bo Jeanes" class="w2 h2 w3-ns h3-ns br-100"></a>
    
  </div>

  <div class="flex flex-column w-90 w-80-ns pl2 pl3-ns">
    <div class="flex items-center">
      
      <a class="f5 fw4 lh-title black-80 hover-black-80 link mr2" href="http://bjeanes.com" target="_blank">Bo Jeanes</a>
      

      
      <a class="f6 fw4 lh-copy link nested-author-cta ba br-pill ph2" href="https://twitter.com/bjeanes" target="_blank">Follow</a>
      
    </div>

    <div class="f6 fw3 lh-copy silver"></div>

    <div class="f6 fw3 lh-copy silver">
      
      <span><time>29 Jun 2009</time></span>
      

      <span class="ttl"> &middot;
        



  
	  4 min read
	


      </span>
    </div>
  </div>
</div>


    

    
    <h1 class="f2 fw6 lh-title mb1">Generating Sound from Sine Waves on the iPhone</h1>
    
    
    </header>


    <div class="mw7 w-100 f5 f4-ns fw3 lh-copy mb0">
    <p>A few months ago I saw this extremely addictive flash game/toy called
<a href="http://lab.andre-michelle.com/tonematrix">ToneMatrix</a>.</p>

<p>My immediate thought was: “This would make quite possibly the coolest iPhone application ever.”</p>

<p>So my good friend, <a href="http://twitter.com/sync1983">Anthony Mittaz</a>, and I
decided to have a crack at it but hit one immediate hurdle; however
proficient an iPhone developer Anthony is, he hadn’t done anything to do
with sound, and nor had I, in <em>any</em> language/framework, let alone on the
iPhone. Let me tell you this: Apple’s documentation in this area is
severely lacking. Tangent: well, almost all Apple documentation on
specialised things is pretty sparse.</p>

<p>I think we spent about two weeks’ worth of nights reading documentation,
source code (Cocoa, iPhone, Java, C, and others), and plain outright
stabbing in the dark code-wise getting not much more than ugly pops and
crackles. Whenever we thought we had a clean note working, we’d change
the frequency to what <strong>should</strong> be another nice clean note, and would
instead get ear-shattering screeches.</p>

<p>Nonetheless we persevered and were even able to come up with a nifty
little piece of code that could take an array of frequencies and play
them together in what could be made to sound like a pleasant chord.</p>

<p>Here is the relevant code:</p>

<h2 id="code">Code</h2>

<p><strong>TonePlayer.h</strong></p>

<pre><code class="language-objective-c">#import &lt;Foundation/Foundation.h&gt;
#include &lt;AudioUnit/AudioUnit.h&gt;
#include &lt;math.h&gt;

#define kTonesAvailable 16
#define kOutputBus 0
#define kInputBus 1
#define kNumChannels 2

@interface TonePlayer : NSObject {
  AudioComponentInstance audioUnit;
  AudioStreamBasicDescription audioFormat;
  float phase[kTonesAvailable];
  float frequencies[kTonesAvailable];
}

-(OSStatus)start;
-(OSStatus)stop;
-(void)resetFrequencies;
-(void)cleanUp;
-(void)intialiseAudio;
@end

// Some C function headers to get arount compile errors while I refactor to be more readable
float phaseOffsetFromFrequency(float);
OSStatus RenderCallback(void*, AudioUnitRenderActionFlags*, const AudioTimeStamp*, UInt32, UInt32, AudioBufferList*);
</code></pre>

<p><strong>TonePlayer.m</strong></p>

<pre><code class="language-objective-c">#import "TonePlayer.h"

typedef struct {
  @defs(TonePlayer);
} SinewaveDef;

@implementation TonePlayer

static float gSampleRate = 44100.;
static float notes[111]  = {
      8.1758, 8.6620, 9.1770, 9.7227, 10.3009, 10.9134, 11.5623, 12.2499, 
      12.9783, 13.7500, 14.5676, 15.4339, 16.3516, 17.3239, 18.3540, 19.4454,
      20.6017, 21.8268, 23.1247, 24.4997, 25.9565, 27.5000, 29.1352, 30.8677, 
      32.7032, 34.6478, 36.7081, 38.8909, 41.2034, 43.6535, 46.2493, 48.9994, 
      51.9131, 55.0000, 58.2705, 61.7354, 65.4064, 69.2957, 73.4162, 77.7817, 
      82.4069, 87.3071, 92.4986, 97.9989, 103.8262, 110.0000, 116.5409, 123.4708,
      130.8128, 138.5913, 146.8324, 155.5635, 164.8138, 174.6141, 184.9972, 
      195.9977, 207.6523, 220.0000, 233.0819, 246.9417, 261.6256, 277.1826, 
      293.6648, 311.1270, 329.6276, 349.2282, 369.9944, 391.9954, 415.3047, 
      440.0000, 466.1638, 493.8833, 523.2511, 554.3653, 587.3295, 622.2540, 
      659.2551, 698.4565, 739.9888, 783.9909, 830.6094, 880.0000, 932.3275, 
      987.7666, 1046.5023, 1108.7305, 1174.6591, 1244.5079, 1318.5102, 1396.9129, 
      1479.9777, 1567.9817, 1661.2188, 1760.0000, 1864.6550, 1975.5332, 2093.0045, 
      2217.4610, 2349.3181, 2489.0159, 2637.0205, 2793.8259, 2959.9554, 3135.9635, 
      3322.4376, 3520.0000, 3729.3101, 3951.0664, 4186.0090, 4434.9221, 4698.6363
  };

OSStatus    RenderCallback(void                          *inRefCon,
                           AudioUnitRenderActionFlags    *ioActionFlags,
                           const AudioTimeStamp          *inTimeStamp,
                           UInt32                        inBusNumber,
                           UInt32                        inNumberFrames,
                           AudioBufferList               *ioData)
{
  SinewaveDef* def = inRefCon;
  
  float *outL = ioData-&gt;mBuffers[0].mData;
  float *outR = ioData-&gt;mBuffers[1].mData;

  float wave, j;
  float freqs[kTonesAvailable];
  
  memset(freqs, 0.0f, sizeof(freqs));
  
  for (int i=0; i&lt; inNumberFrames; i++){
    wave = 0.0f;
    j = 0.0f;
    
    for(int m = 0; m &lt; kTonesAvailable; ++m) {
      if(def-&gt;frequencies[m] != 0) {
        if(freqs[m] == 0) freqs[m] = phaseOffsetFromFrequency(def-&gt;frequencies[m]);

        wave += 0.5 * sinf(def-&gt;phase[m]);
        def-&gt;phase[m] += freqs[m];
        
        ++j;
      }
    }
    
    wave /= j;
    
    *outL++ = wave;
    *outR++ = wave;
  }

  return noErr;
}

float phaseOffsetFromFrequency(float frequency) {
  return (float)(frequency * 2.0 * M_PI / gSampleRate);
}

-(void)resetFrequencies{
  memset(frequencies, 0.0f, sizeof(frequencies));
  memset(phase, 0.0f, sizeof(phase));
}

-(OSStatus)start{
  [self resetFrequencies];
  OSStatus status = AudioOutputUnitStart(audioUnit);
  
  // See http://www.phys.unsw.edu.au/jw/notes.html for note numbers
  frequencies[0] = notes[60]; // C
  frequencies[1] = notes[64]; // E
  frequencies[2] = notes[67]; // G
  
  sleep(1);
  
  frequencies[0] = notes[64];
  frequencies[1] = notes[67];
  frequencies[2] = notes[71];
  
  sleep(1);
  
  frequencies[0] = notes[74];
  frequencies[1] = notes[67];
  frequencies[2] = notes[70];
  
  
  return status;
}

-(OSStatus)stop{
  return AudioOutputUnitStop(audioUnit);
}

-(void)cleanUp{
  AudioUnitUninitialize(audioUnit);
}

-(AudioStreamBasicDescription)audioFormat{
  return audioFormat;
}

// Below code is a cut down version (for output only) of the code written by
// Micheal "Code Fighter" Tyson (punch on Mike)
// See http://michael.tyson.id.au/2008/11/04/using-remoteio-audio-unit/ for details
-(void)intialiseAudio{
  OSStatus status;
  
  // Describe audio component
  AudioComponentDescription desc;
  desc.componentType = kAudioUnitType_Output;
  desc.componentSubType = kAudioUnitSubType_RemoteIO;
  desc.componentFlags = 0;
  desc.componentFlagsMask = 0;
  desc.componentManufacturer = kAudioUnitManufacturer_Apple;
  
  // Get component
  AudioComponent inputComponent = AudioComponentFindNext(NULL, &amp;desc);
  
  // Get audio units
  status = AudioComponentInstanceNew(inputComponent, &amp;audioUnit);
  
  UInt32 flag = 1;
  // Enable IO for playback
  status = AudioUnitSetProperty(audioUnit, 
                  kAudioOutputUnitProperty_EnableIO, 
                  kAudioUnitScope_Output, 
                  kOutputBus,
                  &amp;flag, 
                  sizeof(flag));

  // Describe format
        audioFormat.mSampleRate = gSampleRate;
  audioFormat.mFormatID = kAudioFormatLinearPCM;
  audioFormat.mFormatFlags = kAudioFormatFlagsNativeFloatPacked | kAudioFormatFlagIsNonInterleaved;
  audioFormat.mFramesPerPacket = 1;
  audioFormat.mBytesPerPacket = sizeof(Float32);
  audioFormat.mBytesPerFrame = sizeof(Float32);
  audioFormat.mChannelsPerFrame = kNumChannels;
  audioFormat.mBitsPerChannel = 32;
  
  //Apply format
  status = AudioUnitSetProperty(audioUnit, 
                  kAudioUnitProperty_StreamFormat, 
                  kAudioUnitScope_Input, 
                  kOutputBus, 
                  &amp;audioFormat, 
                  sizeof(audioFormat));
   
  // Set up the playback  callback
  AURenderCallbackStruct callbackStruct;
  callbackStruct.inputProc = RenderCallback;
  //set the reference to "self" this becomes *inRefCon in the playback callback
  callbackStruct.inputProcRefCon = self;
  
  status = AudioUnitSetProperty(audioUnit, 
                  kAudioUnitProperty_SetRenderCallback, 
                  kAudioUnitScope_Global, 
                  kOutputBus,
                  &amp;callbackStruct, 
                  sizeof(callbackStruct));
  
  // Initialise
  status = AudioUnitInitialize(audioUnit);
}

@end
</code></pre>

<p>I really wish that I could remember how most of it worked, or, more
importantly, the multitude of projects whose code we had to look at to
get it working. If you recognise any of the code or can help add
references on how people can build up a nice list of references for
people to use if are following a similar pursuit.</p>

<p>If you are wondering what ever happened to the application we were
building, it seems we weren’t the only ones who recognised the potential
of ToneMatrix as an iPhone application. During the 2-3 weeks of us
developing the sound generation code, about 5-6 ToneMatrix clones were
added to the AppStore. While most were crap, there was one that we felt
left little to be improved upon and we therefore recommend everyone goes
and downloads
<a href="http://itunes.apple.com/WebObjects/MZStore.woa/wa/viewSoftware?id=313573137&amp;mt=8">Melodica</a>.
It’s just as addictive as the Flash version, only portable!</p>


    </div>

    <div class="mw7 w-100 lh-copy">
    
    
<div class="flex flex-row justify-start flex-wrap list mb2">
  

  

  

</div>

    

    
    
<div class="flex flex-row justify-end">


  <a class="link black-60 hover-dark-gray w2 ml3" href="https://twitter.com/intent/tweet?text=Generating Sound from Sine Waves on the iPhone https://bjeanes.com/2009/06/generating-sound-from-sine-waves-on-the-iphone/" title="Share on Twitter" aria-hidden="true">
    <svg viewBox="0 0 20 20" data-icon="twitter" style="fill:currentcolor">
      <path xmlns="http://www.w3.org/2000/svg" d="M14.467,6.707c-0.34,0.198-0.715,0.342-1.115,0.419c-0.318-0.335-0.775-0.545-1.279-0.545c-0.969,0-1.754,0.773-1.754,1.727c0,0.135,0.015,0.267,0.045,0.394C8.905,8.628,7.612,7.94,6.747,6.896C6.596,7.151,6.509,7.448,6.509,7.764c0,0.599,0.31,1.128,0.78,1.438C7.002,9.192,6.732,9.115,6.495,8.985c0,0.007,0,0.014,0,0.021c0,0.837,0.605,1.535,1.408,1.694c-0.147,0.04-0.302,0.06-0.462,0.06c-0.113,0-0.223-0.011-0.33-0.031c0.223,0.687,0.871,1.186,1.638,1.199c-0.6,0.464-1.356,0.739-2.179,0.739c-0.142,0-0.281-0.007-0.418-0.023c0.777,0.489,1.699,0.775,2.689,0.775c3.228,0,4.991-2.63,4.991-4.913c0-0.075-0.002-0.149-0.004-0.223c0.342-0.244,0.639-0.547,0.875-0.894c-0.316,0.137-0.652,0.23-1.008,0.272C14.057,7.448,14.336,7.11,14.467,6.707 M10,0.594c-5.195,0-9.406,4.211-9.406,9.406c0,5.195,4.211,9.406,9.406,9.406c5.196,0,9.407-4.211,9.407-9.406C19.406,4.805,15.195,0.594,10,0.594 M10,18.552c-4.723,0-8.551-3.829-8.551-8.552S5.277,1.449,10,1.449c4.723,0,8.551,3.829,8.551,8.551S14.723,18.552,10,18.552"></path>
    </svg>
  </a>



  <a class="link black-60 hover-dark-gray w2 ml3" href="https://www.facebook.com/sharer/sharer.php?u=https://bjeanes.com/2009/06/generating-sound-from-sine-waves-on-the-iphone/" title="Share on Facebook" aria-hidden="true">
    <svg viewBox="0 0 20 20" data-icon="facebook" style="fill:currentcolor">
      <path xmlns="http://www.w3.org/2000/svg" d="M10,0.5c-5.247,0-9.5,4.253-9.5,9.5c0,5.247,4.253,9.5,9.5,9.5c5.247,0,9.5-4.253,9.5-9.5C19.5,4.753,15.247,0.5,10,0.5 M10,18.637c-4.77,0-8.636-3.867-8.636-8.637S5.23,1.364,10,1.364S18.637,5.23,18.637,10S14.77,18.637,10,18.637 M10.858,7.949c0-0.349,0.036-0.536,0.573-0.536h0.719v-1.3H11c-1.38,0-1.866,0.65-1.866,1.743v0.845h-0.86V10h0.86v3.887h1.723V10h1.149l0.152-1.299h-1.302L10.858,7.949z"></path>
    </svg>
  </a>




  <a class="link black-60 hover-dark-gray w2 ml3" href="https://plus.google.com/share?url=https://bjeanes.com/2009/06/generating-sound-from-sine-waves-on-the-iphone/" title="Share on Google+" aria-hidden="true">
    <svg viewBox="0 0 20 20" data-icon="google plus" style="fill:currentcolor">
      <path xmlns="http://www.w3.org/2000/svg" d="M10,0.562c-5.212,0-9.438,4.226-9.438,9.438c0,5.213,4.226,9.438,9.438,9.438c5.212,0,9.438-4.225,9.438-9.438C19.438,4.788,15.212,0.562,10,0.562 M10,18.58c-4.738,0-8.58-3.841-8.58-8.58c0-4.738,3.842-8.58,8.58-8.58c4.737,0,8.579,3.841,8.579,8.58C18.579,14.739,14.737,18.58,10,18.58 M10.033,10.346C9.813,10.183,9.608,9.94,9.6,9.865c0-0.128,0-0.188,0.303-0.435c0.393-0.322,0.609-0.745,0.609-1.192c0-0.387-0.108-0.731-0.293-0.982h0.164l0.908-0.688H8.832c-0.986,0-1.851,0.774-1.851,1.657c0,0.912,0.667,1.604,1.565,1.642C8.533,9.933,8.525,9.996,8.525,10.06c0,0.131,0.03,0.257,0.09,0.378c-1.113,0.007-2.05,0.752-2.05,1.632c0,0.789,0.902,1.362,2.145,1.362c1.343,0,2.067-0.84,2.067-1.631C10.778,11.143,10.576,10.748,10.033,10.346 M8.026,8.198C7.985,7.869,8.054,7.565,8.212,7.384c0.096-0.11,0.22-0.169,0.358-0.169V7.036l0.016,0.179c0.412,0.014,0.807,0.501,0.88,1.086c0.042,0.335-0.03,0.647-0.191,0.833c-0.096,0.11-0.217,0.169-0.367,0.168h0C8.503,9.29,8.1,8.784,8.026,8.198 M8.707,12.749c-0.612,0-1.093-0.394-1.093-0.897c0-0.461,0.562-0.865,1.202-0.865v-0.18h0l0.017,0.18c0.138,0.002,0.272,0.022,0.399,0.062l0.126,0.092c0.326,0.231,0.498,0.363,0.549,0.575c0.013,0.056,0.019,0.111,0.019,0.167C9.927,12.458,9.517,12.749,8.707,12.749M13.43,6.993h-0.858v1.288H11.28V9.14h1.291v1.283h0.858V9.14h1.293V8.281H13.43V6.993z"></path>
    </svg>
  </a>


</div>


    

    
    



<div class="flex w-100 mt2 lh-copy bt b--light-gray pv3">
  <div>
    
      <a href="http://bjeanes.com" target="_blank"><img src="/assets/images/bo.jpg" alt="Bo Jeanes" class="w2 h2 w3-ns h3-ns br-100"></a>
    
  </div>

  <div class="flex flex-column w-90 w-80-ns pl2 pl3-ns">
    <div class="flex items-center-ns">
      
      <a class="f5 f4-ns fw4 lh-title black-80 hover-black-80 link mr2" href="http://bjeanes.com" target="_blank">Bo Jeanes</a>
      

      
      <a class="f6 fw4 link nested-author-cta ba br-pill ph2" href="https://twitter.com/bjeanes" target="_blank">Follow</a>
      
    </div>


    <div class="f6 f5-ns fw3 lh-copy silver">Bo is a software engineer who cares deeply about simplicity in design and
building complex behaviours out of simple primitives. Bo primarily works in
Ruby day-to-day, though is a functional programmer at heart and a fan of
programming languages generally, with particular soft spots for Clojure,
Elixir, and Rust.
</div>
  </div>

</div>



    

    

    
    <script
  src="https://utteranc.es/client.js"
  repo="bjeanes/bjeanes.github.io"
  issue-term="og:title"
  label="blog-comments"
  theme="github-light"
  crossorigin="anonymous"
  async
></script>
<noscript
  >Go to
  <a href="https://github.com/bjeanes/bjeanes.github.io/issues">GH issues</a> to
  view/leave comments</noscript
>

    
    </div>

  </article>
</main>




<footer class="flex justify-start items-baseline mw7 center w-100 ph3 ph4-ns mt4 mb2 lh-copy">
  <nav class="flex flex-row flex-wrap">
    <span class="f7 fw3 silver mr3 ttc"><a href="https://bjeanes.com/" class="f7 fw5 silver hover-silver link underline-hover" title="Bo Jeanes">Bo jeanes</a> &copy; 2020</span>
    

    
    <span class="f7 fw3 silver mr3">Designed with <a href="https://desiredpersona.com/themes/" class="f7 fw3 silver hover-silver link underline-hover mr3" target="_blank">Minimal Theme</a></span>
    
  </nav>
</footer>



</body>
</html>
