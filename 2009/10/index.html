<!DOCTYPE html>
<html lang="">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Meta Robots Tag -->
  <meta name="robots" content="all">

  <!-- Site Author -->
  <meta name="author" content="bo">

  <!-- Atom Feed -->
  <link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Bo Jeanes Feed">
  
  <!-- Stylesheet -->
  <link rel="stylesheet" href="/assets/css/minimal.css">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="/favicon.png">

  <!-- Analytics -->
  

  <!-- SEO -->
  <!-- Begin Jekyll SEO tag v2.3.0 -->
<title>Bo Jeanes</title>
<meta property="og:title" content="Bo Jeanes" />
<meta name="author" content="Bo Jeanes" />
<meta property="og:locale" content="en_US" />
<link rel="canonical" href="https://bjeanes.com/2009/10/" />
<meta property="og:url" content="https://bjeanes.com/2009/10/" />
<meta property="og:site_name" content="Bo Jeanes" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2009-10-01T00:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@bjeanes" />
<meta name="twitter:creator" content="@bjeanes" />
<script type="application/ld+json">
{"mainEntityOfPage":{"@type":"WebPage","@id":"https://bjeanes.com/2009/10/"},"description":null,"@type":"BlogPosting","url":"https://bjeanes.com/2009/10/","name":null,"headline":"Bo Jeanes","dateModified":"2009-10-01T00:00:00+00:00","datePublished":"2009-10-01T00:00:00+00:00","sameAs":null,"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://avatars2.githubusercontent.com/u/2560?s=200&v=4"},"name":"Bo Jeanes"},"image":null,"author":{"@type":"Person","name":"Bo Jeanes"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

</head>

<body class="black-90 ">

<div class="flex flex-column items-center">
  <div class="mw7 w-100 ph3 ph4-ns">
    <h1 class="f5 fw4 lh-title mb0 pb2 bb b--light-gray">Posts from October 2009</h1>

    
    <a class="link black-80 hover-silver" href="/2009/10/using-fish-shells-event-system-to-behave-like-method-missing/">
      <article class="f5 lh-copy fw3 pb4 bb b--light-gray">
        <div class="f6 fw6 lh-title ttu tracked mv4"><time>Oct 2009</time></div>
        <h3 class="f3 fw6 lh-title mb0">Using Fish shell&#39;s event system to behave like method_missing</h3>
        <p class="f5 fw3 lh-copy mv2">Dr Nic’s latest post, <a href="http://drnicwilliams.com/2009/10/07/hash-bang-cucumber/">hash bang
cucumber</a>,
reminded me of a piece of hax I whipped up a few weeks ago with Ruby and
Fish Shell.

Fish has an event system that allows you to register functions to be
auto-run after or during certain events (such as when a particular
environment variable is changed). One of this events is called
<code class="highlighter-rouge">fish_command_not_found</code>. It is triggered whenever you type a
non-existant command into the prompt.

With this in mind, you can trigger certain commands to run by matching
what fish couldn’t manage to run automatically by catching this event.

For instance:

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function </span>__fish_method_missing <span class="nt">--on-event</span> fish_command_not_found
  method_missing <span class="nv">$argv</span>
end

funcsave method_missing
</code></pre></div></div>

Given that function is created (simply paste the whole code block into
your Fish terminal), I can now create a command called
<code class="highlighter-rouge">method_missing</code> (or whatever you call inside your
<code class="highlighter-rouge">__fish_method_missing</code>) and place it somewhere in your <code class="highlighter-rouge">$PATH</code> — I like
<code class="highlighter-rouge">~/.config/fish/bin</code>.

My <code class="highlighter-rouge">method_missing</code> binary is simply something like this:

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env ruby</span>

<span class="n">command</span> <span class="o">=</span> <span class="no">ARGV</span><span class="p">.</span><span class="nf">shift</span>

<span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
  <span class="nb">puts</span> <span class="s2">"Running </span><span class="si">#{</span><span class="n">cmd</span><span class="p">.</span><span class="nf">inspect</span><span class="si">}</span><span class="s2"> instead"</span>
  <span class="nb">system</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">case</span> <span class="n">command</span>
<span class="k">when</span> <span class="sr">/^git(@|:\/\/).*\.git$/</span>
  <span class="n">run</span><span class="p">(</span><span class="s2">"git clone </span><span class="si">#{</span><span class="n">command</span><span class="p">.</span><span class="nf">inspect</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="k">when</span> <span class="sr">/^(?:ftp|https?):\/\/.+\.t(?:ar\.)?gz$/</span>
  <span class="n">run</span><span class="p">(</span><span class="s2">"curl </span><span class="si">#{</span><span class="n">command</span><span class="p">.</span><span class="nf">inspect</span><span class="si">}</span><span class="s2"> | tar xzv"</span><span class="p">)</span>
<span class="k">else</span>
  <span class="vg">$stderr</span><span class="p">.</span><span class="nf">puts</span> <span class="s2">"No default action defined in </span><span class="si">#{</span><span class="kp">__FILE__</span><span class="p">.</span><span class="nf">inspect</span><span class="si">}</span><span class="s2">"</span>
  <span class="nb">abort</span>
<span class="k">end</span>
</code></pre></div></div>

Each command you want to register just becomes a new <code class="highlighter-rouge">when</code>
statement. For instance, to implement the functionality Dr Nic was
trying to achieve, I simply modify the <code class="highlighter-rouge">case</code> block as such:

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">case</span> <span class="n">command</span>
<span class="k">when</span> <span class="sr">/^[a-z0-9_\-\/]+\.feature(:\d+)?$/</span>
  <span class="n">run</span><span class="p">(</span><span class="s2">"cucumber </span><span class="si">#{</span><span class="n">command</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="c1"># ... </span>
<span class="k">end</span>
</code></pre></div></div>

The existing entries I have in my <code class="highlighter-rouge">method_missing</code> command will
auto-clone the repository of a pasted Git URL and download and expand a
URL for a tar file, respectively. Not too shabby, and dead easy to
implement
</p>
  
        <div class="f6 fw3 silver mt0">
          
          <time>7 Oct 2009</time>
          
          <span class="ttl">&middot; 



  
	  1 min read
	

</span>
        </div>
      </article>
    </a>
    
    <a class="link black-80 hover-silver" href="/2009/10/gotcha-with-hash-new-when-providing-a-default-value/">
      <article class="f5 lh-copy fw3 pb4 bb b--light-gray">
        <div class="f6 fw6 lh-title ttu tracked mv4"><time>Oct 2009</time></div>
        <h3 class="f3 fw6 lh-title mb0">Gotcha with Hash.new when providing a default value</h3>
        <p class="f5 fw3 lh-copy mv2">For a project I am working on at the moment, I needed a <code class="highlighter-rouge">Hash</code>
that returned a different default value, i.e. not <code class="highlighter-rouge">nil</code>.
Specifically, I needed it to return another <code class="highlighter-rouge">Hash</code>, and for that
internal <code class="highlighter-rouge">Hash</code>’s default value to be an <code class="highlighter-rouge">Array</code>, like so:

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">hash</span> <span class="o">=</span> <span class="c1"># ...</span>
<span class="nb">p</span> <span class="nb">hash</span><span class="p">.</span><span class="nf">class</span>                              <span class="c1">#=&gt; Hash</span>
<span class="nb">p</span> <span class="nb">hash</span><span class="p">[</span><span class="ss">:non_existant_key</span><span class="p">].</span><span class="nf">class</span>           <span class="c1">#=&gt; Hash</span>
<span class="nb">p</span> <span class="nb">hash</span><span class="p">[</span><span class="ss">:another</span><span class="p">][</span><span class="ss">:non_existant_key</span><span class="p">].</span><span class="nf">class</span> <span class="c1">#=&gt; Array</span>
</code></pre></div></div>

Naïvely, I threw this into my code, and went along my merry way:
<code class="highlighter-rouge">entries = Hash.new(Hash.new([]))</code>. A few days later, I came back
to this code to finish it and realised that something was awry with the
values I was getting out of the <code class="highlighter-rouge">Hash</code>. It took me a while to figure it
out because the values were all integers being summed together and I was
never looking or setting the values directly.

However, eventually I saw a pattern — many of the values were the same.
For instance, given the following assignments, I should expect
<code class="highlighter-rouge">[ruby]p entries[153][:monday] #=&gt; [12.hours]</code>:

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">entries</span><span class="p">[</span><span class="mi">153</span><span class="p">][</span><span class="ss">:monday</span><span class="p">]</span>  <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">.</span><span class="nf">hours</span>
<span class="n">entries</span><span class="p">[</span><span class="mi">153</span><span class="p">][</span><span class="ss">:tuesday</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">.</span><span class="nf">hours</span>
<span class="n">entries</span><span class="p">[</span><span class="mi">87</span><span class="p">][</span><span class="ss">:monday</span><span class="p">]</span>   <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">.</span><span class="nf">hours</span>
<span class="n">entries</span><span class="p">[</span><span class="mi">87</span><span class="p">][</span><span class="ss">:tuesday</span><span class="p">]</span>  <span class="o">&lt;&lt;</span> <span class="mf">2.5</span><span class="p">.</span><span class="nf">hours</span>
</code></pre></div></div>

However, what I found was the following:

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">p</span> <span class="n">entries</span><span class="p">[</span><span class="mi">153</span><span class="p">][</span><span class="ss">:monday</span><span class="p">]</span>  <span class="c1">#=&gt; [12.hours, 3.hours, 7.hours, 2.5.hours]</span>
<span class="nb">p</span> <span class="n">entries</span><span class="p">[</span><span class="mi">153</span><span class="p">][</span><span class="ss">:tuesday</span><span class="p">]</span> <span class="c1">#=&gt; [12.hours, 3.hours, 7.hours, 2.5.hours]</span>
<span class="nb">p</span> <span class="n">entries</span><span class="p">[</span><span class="mi">87</span><span class="p">][</span><span class="ss">:monday</span><span class="p">]</span>   <span class="c1">#=&gt; [12.hours, 3.hours, 7.hours, 2.5.hours]</span>
<span class="nb">p</span> <span class="n">entries</span><span class="p">[</span><span class="mi">87</span><span class="p">][</span><span class="ss">:tuesday</span><span class="p">]</span>  <span class="c1">#=&gt; [12.hours, 3.hours, 7.hours, 2.5.hours]</span>

<span class="c1"># And in fact:</span>
<span class="nb">p</span> <span class="n">entries</span><span class="p">[</span><span class="ss">:any</span><span class="p">][</span><span class="ss">:thing</span><span class="p">]</span>  <span class="c1">#=&gt; [12.hours, 3.hours, 7.hours, 2.5.hours]</span>
</code></pre></div></div>

Let that soak in for a second. <code class="highlighter-rouge">Hash.new({})</code> uses the <strong>same
instance</strong> of the internal <code class="highlighter-rouge">Array</code> as the default value for each
of the inner-most keys. It also doesn’t set the key you want so
<code class="highlighter-rouge">p entries</code> still printed <code class="highlighter-rouge">{}</code>. In retrospect, it is
blatantly obvious that it does this, but the ramifications are still
huge.

The way to get the intended effect is of course to use the block syntax
of <code class="highlighter-rouge">[ruby]Hash.new</code> which, while much uglier, definitely works as
expected:

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">entries</span> <span class="o">=</span> <span class="no">Hash</span><span class="p">.</span><span class="nf">new</span> <span class="p">{</span><span class="o">|</span><span class="nb">hash</span><span class="p">,</span> <span class="n">key</span><span class="o">|</span> <span class="nb">hash</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="no">Hash</span><span class="p">.</span><span class="nf">new</span> <span class="p">{</span><span class="o">|</span><span class="n">h</span><span class="p">,</span> <span class="n">k</span><span class="o">|</span> <span class="n">h</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span> <span class="p">}}</span>
<span class="n">entries</span><span class="p">[</span><span class="mi">153</span><span class="p">][</span><span class="ss">:monday</span><span class="p">]</span>  <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">.</span><span class="nf">hours</span>
<span class="n">entries</span><span class="p">[</span><span class="mi">153</span><span class="p">][</span><span class="ss">:tuesday</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">.</span><span class="nf">hours</span>
<span class="n">entries</span><span class="p">[</span><span class="mi">87</span><span class="p">][</span><span class="ss">:monday</span><span class="p">]</span>   <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">.</span><span class="nf">hours</span>
<span class="n">entries</span><span class="p">[</span><span class="mi">87</span><span class="p">][</span><span class="ss">:tuesday</span><span class="p">]</span>  <span class="o">&lt;&lt;</span> <span class="mf">2.5</span><span class="p">.</span><span class="nf">hours</span>

<span class="nb">p</span> <span class="n">entries</span> <span class="c1">#=&gt; {87=&gt;{:monday=&gt;[7.hours], :tuesday=&gt;[2.5.hours]}, 153=&gt;{:monday=&gt;[12.hours], :tuesday=&gt;[3.hours]}}</span>
</code></pre></div></div>

Wow. Obvious, but good to remember. I am sure most of you have had this
issue before, but I think it is still worthy of mention…
</p>
  
        <div class="f6 fw3 silver mt0">
          
          <time>1 Oct 2009</time>
          
          <span class="ttl">&middot; 



  
	  1 min read
	

</span>
        </div>
      </article>
    </a>
    
    <a class="link black-80 hover-silver" href="/2009/10/code-formatting-in-rss-feeds/">
      <article class="f5 lh-copy fw3 pb4 bb b--light-gray">
        <div class="f6 fw6 lh-title ttu tracked mv4"><time>Oct 2009</time></div>
        <h3 class="f3 fw6 lh-title mb0">Code formatting in RSS Feeds</h3>
        <p class="f5 fw3 lh-copy mv2">Apologies readers — I just realised that the code formatting is kinda
screwed up in RSS feeds because I am using some HTML5 elements to
represent my code blocks and using CSS to style them appropriately on
the site. The RSS feeds obviously lack these stylesheets and so look
pretty crap. I am not sure what the best solution is yet. Perhaps I
embed a <code class="highlighter-rouge">&lt;style&gt;</code> in each RSS post or simply have the RSS feeds
only show an excerpt of the full post.

</p>
  
        <div class="f6 fw3 silver mt0">
          
          <time>1 Oct 2009</time>
          
          <span class="ttl">&middot; 



  
	  Less than 1 min read
	

</span>
        </div>
      </article>
    </a>
    

  </div>
</div>

<footer class="flex justify-start items-baseline mw7 center w-100 ph3 ph4-ns mt4 mb2 lh-copy">
  <nav class="flex flex-row flex-wrap">
    <span class="f7 fw3 silver mr3 ttc"><a href="https://bjeanes.com/" class="f7 fw5 silver hover-silver link underline-hover" title="Bo Jeanes">Bo jeanes</a> &copy; 2020</span>
    

    
    <span class="f7 fw3 silver mr3">Designed with <a href="https://desiredpersona.com/themes/" class="f7 fw3 silver hover-silver link underline-hover mr3" target="_blank">Minimal Theme</a></span>
    
  </nav>
</footer>

</body>
</html>