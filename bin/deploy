#!/usr/bin/env bash

# Builds the current site and pushes the resulting directory as the root of the
# target branch (gh-pages or master, depending on repository type).

# TODO: Ensure working directory is clean and push it too

set -ex

# Determine which branch GitHub pages is built from, for this repository
remote=$(git config remote.origin.url)
if [[ $remote = *.github.io ]] || [[ $remote = *.github.io.git ]]; then
  branch=master
else
  branch=gh-pages
fi

# Build the site
bundle exec jekyll build \
  --destination ./_site \
  --no-watch \
  --strict_front_matter

# Stage build directory to index
git add -fA ./_site

# Write tree to an object
tree=$(git write-tree --prefix=_site)

# Un-stage the build directory
git reset -- ./_site

# Get the author info from current commit (so the deployment commit has the
# same details)
export GIT_AUTHOR_NAME=$(git show -s --format='%an' HEAD)
export GIT_COMMITTER_NAME="$GIT_AUTHOR_NAME"
export GIT_AUTHOR_EMAIL=$(git show -s --format='%ae' HEAD)
export GIT_COMMITTER_EMAIL="$GIT_AUTHOR_EMAIL"

# Create a new commit for that tree as a child of current branch's commit
identifier=$(git describe --dirty --always)
commit=$(git commit-tree -p refs/remotes/origin/$branch -m "Deploy $identifier" $tree)

# Set the github pages branch to the new object
git update-ref refs/heads/$branch $commit

git push -f origin refs/heads/$branch

